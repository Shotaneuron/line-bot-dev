<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: #f0fdfa; color: #1e293b; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .btn-hover { transition: transform 0.2s; }
        .btn-hover:active { transform: scale(0.96); }
        #detail-modal { display: none; transition: opacity 0.3s; }
        #detail-modal.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-bg { animation: pulseBg 3s infinite alternate; }
        @keyframes pulseBg { 0% { background-color: #f8fafc; } 100% { background-color: #f1f5f9; } }
    </style>
</head>
<body class="safe-area-inset-top pb-24 relative">

    <header class="bg-white px-6 py-8 rounded-b-[2rem] shadow-sm mb-6 text-center">
        <p class="text-[10px] font-black text-sky-500 tracking-[0.3em] mb-2 uppercase">Hokkaido University</p>
        <h1 class="text-2xl font-black text-slate-800 tracking-tight mb-2">åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ <span class="text-xl">ğŸ’¡</span></h1>
        <p class="text-xs text-slate-500 font-bold mt-3 bg-slate-100 inline-block px-3 py-1 rounded-full">ã€Œå¿ƒã€ã‚’ç§‘å­¦ã™ã‚‹å­¦ç”Ÿã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</p>
    </header>

    <main class="px-5 space-y-8">

        <section class="pulse-bg border-2 border-slate-200 rounded-[2rem] p-5 text-center relative overflow-hidden shadow-inner">
            <div class="absolute -top-4 -right-4 text-6xl opacity-10">ğŸ“Š</div>
            <h2 class="text-xs font-black text-slate-500 tracking-widest mb-3">RESEARCH DATA</h2>
            <div class="flex justify-center items-end space-x-1 mb-4">
                <span class="text-sm font-bold text-slate-600 pb-1">ç¾åœ¨ã€åŒ—å¤§ç”Ÿ</span>
                <span id="stat-total" class="text-4xl font-black text-sky-600 tracking-tighter">--</span>
                <span class="text-sm font-bold text-slate-600 pb-1">äººãŒè¨ºæ–­æ¸ˆï¼</span>
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mb-2">ğŸ‘‘ ä¸€ç•ªå¤šã„ã‚¿ã‚¤ãƒ—ã¯...</p>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">ğŸ”¥ ã‚„ã‚‹æ°—</p>
                    <p id="stat-top-motivation" class="text-[11px] font-black text-orange-500 break-words">é›†è¨ˆä¸­...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">â° æ™‚é–“å¸¯</p>
                    <p id="stat-top-chrono" class="text-[11px] font-black text-emerald-500 break-words">é›†è¨ˆä¸­...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">â˜• ã‚³ãƒ¼ãƒ’ãƒ¼</p>
                    <p id="stat-top-coffee" class="text-[11px] font-black text-amber-600 break-words">é›†è¨ˆä¸­...</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-indigo-500">å¿ƒç†ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹</h2>
            <div class="grid grid-cols-2 gap-3">
                <a href="motivation.html" class="btn-hover block bg-gradient-to-br from-orange-400 to-rose-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ— ğŸ”¥</h3>
                    <p class="text-[9px] font-bold text-white/80">ãƒ¢ãƒãƒ™ã®æºæ³‰ã‚’ç‰¹å®š</p>
                </a>
                <a href="bigfive.html" class="btn-hover block bg-gradient-to-br from-indigo-500 to-cyan-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">Big Fiveè¨ºæ–­ ğŸ§ </h3>
                    <p class="text-[9px] font-bold text-white/80">ä¸–ç•ŒåŸºæº–ã®æ€§æ ¼åˆ†æ</p>
                </a>
                <a href="chronotype.html" class="btn-hover block bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ— â°</h3>
                    <p class="text-[9px] font-bold text-white/80">æœ€å¼·ã®ã€Œæ™‚é–“å¸¯ã€ãŒåˆ¤æ˜</p>
                </a>
                <a href="coffee.html" class="btn-hover block bg-gradient-to-br from-amber-500 to-orange-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ â˜•</h3>
                    <p class="text-[9px] font-bold text-white/80">1å•ã§ã‚ã‹ã‚‹æ·±å±¤å¿ƒç†</p>
                </a>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-sky-400">ã‚ãªãŸã®åˆ†æãƒ‡ãƒ¼ã‚¿</h2>
            <div class="space-y-3">
                
                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
                        <span id="date-motivation" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-motivation" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-motivation" onclick="openModal('motivation')" class="hidden w-full bg-orange-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">Big Five æ€§æ ¼ãƒ†ã‚¹ãƒˆ</span>
                        <span id="date-bigfive" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-bigfive" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-bigfive" onclick="openModal('bigfive')" class="hidden w-full bg-indigo-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
                        <span id="date-chrono" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-chrono" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-chrono" onclick="openModal('chronotype')" class="hidden w-full bg-emerald-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ãƒ†ã‚¹ãƒˆ</span>
                        <span id="date-coffee" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-coffee" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-coffee" onclick="openModal('coffee')" class="hidden w-full bg-amber-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-teal-400">ã‚¼ãƒŸç”Ÿã®æ´»å‹•ãƒ»ã‚³ãƒ©ãƒ </h2>
            <div class="space-y-3">
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-teal-50 rounded-xl text-2xl mr-4">ğŸ“–</div>
                    <div><h3 class="text-sm font-black text-slate-800">AIå…ˆè¼©ã®3åˆ†å¿ƒç†å­¦ã‚³ãƒ©ãƒ </h3><p class="text-[10px] font-bold text-slate-500 mt-1">ã€Œã‚¨ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã€ã®è½ã¨ã—ç©´ã¨ã¯ï¼Ÿ</p></div>
                </a>
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-amber-50 rounded-xl text-2xl mr-4">ğŸ“¸</div>
                    <div><h3 class="text-sm font-black text-slate-800">ã‚¼ãƒŸæ´»å‹•æ—¥èªŒ & ãƒ¡ãƒ³ãƒãƒ¼ç´¹ä»‹</h3><p class="text-[10px] font-bold text-slate-500 mt-1">å€‹æ€§è±Šã‹ãªå…ˆè¼©ãŸã¡ã‚’å¤§å…¬é–‹ï¼</p></div>
                </a>
            </div>
        </section>

        <section class="btn-hover">
            <a href="#" class="block bg-gradient-to-r from-amber-400 to-orange-500 rounded-[2rem] p-6 text-center shadow-lg relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 text-6xl opacity-20">â˜•</div>
                <h2 class="text-white font-black text-sm mb-2 drop-shadow-md">ï¼¼ æ–°å…¥ç”Ÿæ­“è¿ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ï¼ ï¼</h2>
                <p class="text-white/90 text-xs font-bold mb-4 drop-shadow-sm">å¿ƒç†å­¦ã«èˆˆå‘³ãŒã‚ã‚‹äººã€å¤§æ­“è¿ï¼<br>ã¾ãšã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³èª¬æ˜ä¼šã¸éŠã³ã«æ¥ã¦ã­âœ¨</p>
                <span class="inline-block bg-white text-orange-500 text-xs font-black px-8 py-3 rounded-full shadow-md">è©³ç´°ãƒ»å‚åŠ ç”³è¾¼ã¯ã“ã¡ã‚‰ï¼ ğŸ‘‰</span>
            </a>
        </section>

    </main>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 z-50 justify-center items-end pb-0 sm:items-center sm:p-5 hidden">
        <div class="bg-white w-full sm:w-96 rounded-t-[2rem] sm:rounded-[2rem] p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ ğŸ“‘</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xl bg-slate-100 rounded-full w-8 h-8 flex justify-center items-center">Ã—</button>
            </div>
            
            <div id="chart-container" class="w-full aspect-square mb-6 bg-slate-50 rounded-2xl p-2">
                <canvas id="radarChart"></canvas>
            </div>
            
            <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                <h4 class="text-xs font-black text-indigo-600 mb-2">ğŸ¤– AIå…ˆè¼©ã®åˆ†æ</h4>
                <p id="modal-text" class="text-xs text-slate-700 font-bold leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-700 text-sm font-black py-3 rounded-xl mt-2 active:bg-slate-300">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        let myChart = null;
        let userData = null;

        // ğŸ“– 30é …ç›®ã®ãƒ•ã‚¡ã‚»ãƒƒãƒˆï¼ˆå°é …ç›®ï¼‰è¾æ›¸
        const FACET_DICT = {
            'E': { title: "å¤–å‘æ€§ã®å†…è¨³", color: "bg-orange-400", facets: { 1: "å‹å¥½æ€§", 2: "ç¤¾äº¤æ€§", 3: "è‡ªå·±ä¸»å¼µ", 4: "æ´»å‹•æ°´æº–", 5: "åˆºæ¿€å¸Œæ±‚", 6: "æ˜æœ—æ€§" },
                descs: { 1: "å‘¨å›²ã¸è¦ªã—ã¿ã‚’æ„Ÿã˜ã€æ¸©ã‹ãæ¥ã™ã‚‹å‚¾å‘", 2: "äººã¨ä¸€ç·’ã«ã„ã‚‹ã“ã¨ã‚’å¥½ã¿ã€é›†å›£ã‚’æ±‚ã‚ã‚‹å‚¾å‘", 3: "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’å–ã‚Šã€æ„è¦‹ã‚’ä¸»å¼µã™ã‚‹åŠ›", 4: "ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã«æ´»å‹•çš„ã«å‹•ããƒšãƒ¼ã‚¹", 5: "ã‚¹ãƒªãƒ«ã‚„å¼·ã„åˆºæ¿€ã‚’æ±‚ã‚ã‚‹å‚¾å‘", 6: "å–œã³ã‚„æ¥½ã—ã•ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘" } },
            'A': { title: "å”èª¿æ€§ã®å†…è¨³", color: "bg-green-400", facets: { 1: "ä¿¡é ¼", 2: "èª å®Ÿã•", 3: "åˆ©ä»–ä¸»ç¾©", 4: "é †å¿œæ€§", 5: "è¬™è™šã•", 6: "å„ªã—ã„å¿ƒ" },
                descs: { 1: "ä»–äººã®æ„å›³ãŒå–„æ„ã§ã‚ã‚‹ã¨ä¿¡ã˜ã‚‹å‚¾å‘", 2: "é§†ã‘å¼•ãã‚’ã›ãšã€ç‡ç›´ã§éš ã—äº‹ãŒãªã„å‚¾å‘", 3: "ä»–äººã®å¹¸ç¦ã‚’é¡˜ã„ã€é€²ã‚“ã§æ´åŠ©ã™ã‚‹å‚¾å‘", 4: "å¯¾ç«‹ã‚’é¿ã‘ã€ä»–äººã«è­²æ­©ã—ã¦è¨±ã™å‚¾å‘", 5: "è‡ªæ…¢ã‚’ã›ãšã€è‡ªåˆ†ã‚’æ§ãˆã‚ã«è¡¨ç¾ã™ã‚‹å‚¾å‘", 6: "ä»–äººã®è‹¦ã—ã¿ã«å…±æ„Ÿã—ã€åŒæƒ…ã™ã‚‹å‚¾å‘" } },
            'C': { title: "èª å®Ÿæ€§ã®å†…è¨³", color: "bg-blue-400", facets: { 1: "è‡ªå·±åŠ¹åŠ›æ„Ÿ", 2: "ç§©åºæ€§", 3: "ç¾©å‹™æ„Ÿ", 4: "é”æˆåŠªåŠ›", 5: "è‡ªå·±é›éŒ¬", 6: "æ…é‡ã•" },
                descs: { 1: "ç‰©äº‹ã‚’æˆã—é‚ã’ã‚‹èƒ½åŠ›ãŒã‚ã‚‹ã¨ä¿¡ã˜ã‚‹å‚¾å‘", 2: "æ•´ç†æ•´é “ã‚’å¥½ã¿ã€è¨ˆç”»çš„ã«é€²ã‚ã‚‹å‚¾å‘", 3: "ãƒ«ãƒ¼ãƒ«ã‚„é“å¾³çš„ãªç¾©å‹™ã‚’å³æ ¼ã«å®ˆã‚‹å‚¾å‘", 4: "é«˜ã„ç›®æ¨™ã‚’è¨­å®šã—ã€ãã‚Œã«å‘ã‹ã£ã¦åŠªåŠ›ã™ã‚‹å‚¾å‘", 5: "å›°é›£ãªã‚¿ã‚¹ã‚¯ã§ã‚‚æŠ•ã’å‡ºã•ãšã«ã‚„ã‚Šé‚ã’ã‚‹åŠ›", 6: "è¡Œå‹•å‰ã«çµæœã‚’äºˆæ¸¬ã—ã€æ·±ãè€ƒãˆã¦ã‹ã‚‰å‹•ãå‚¾å‘" } },
            'N': { title: "æ•æ„Ÿã•ï¼ˆç¥çµŒç—‡å‚¾å‘ï¼‰ã®å†…è¨³", color: "bg-purple-400", facets: { 1: "ä¸å®‰", 2: "æ€’ã‚Š", 3: "æŠ‘ã†ã¤", 4: "è‡ªæ„è­˜", 5: "è¡å‹•æ€§", 6: "è„†å¼±æ€§" },
                descs: { 1: "å¿ƒé…äº‹ã‚„ææ€–ã€å°†æ¥ã¸ã®ä¸å®‰ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘", 2: "ã‚¤ãƒ©ã‚¤ãƒ©ã—ã‚„ã™ãã€ä¸æº€ã‚’æŠ±ãã‚„ã™ã„å‚¾å‘", 3: "æ‚²ã—ã¿ã‚„å­¤ç‹¬æ„Ÿã‚’æ„Ÿã˜ã¦è½ã¡è¾¼ã¿ã‚„ã™ã„å‚¾å‘", 4: "ä»–äººã®ç›®ã‚’æ°—ã«ã—ã€æ¥ãšã‹ã—ã•ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘", 5: "å¼·ã„æ¬²æ±‚ã«æŠ—ãˆãšã€æ„Ÿæƒ…ã§è¡Œå‹•ã—ã¦ã—ã¾ã†å‚¾å‘", 6: "ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã«å¼±ãã€ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚Šã‚„ã™ã„å‚¾å‘" } },
            'O': { title: "é–‹æ”¾æ€§ã®å†…è¨³", color: "bg-pink-400", facets: { 1: "æƒ³åƒåŠ›", 2: "èŠ¸è¡“çš„é–¢å¿ƒ", 3: "æ„Ÿæƒ…æ€§", 4: "å†’é™ºå¿ƒ", 5: "çŸ¥æ€§", 6: "é€²å–æ€§" },
                descs: { 1: "ç©ºæƒ³ã‚’å¥½ã¿ã€è±Šã‹ãªå†…é¢ä¸–ç•Œã‚’æŒã¤å‚¾å‘", 2: "éŸ³æ¥½ã‚„ç¾è¡“ãªã©ã®ç¾ã—ã•ã«æ·±ãæ„Ÿå‹•ã™ã‚‹å‚¾å‘", 3: "è‡ªåˆ†ã®æ„Ÿæƒ…ã®å‹•ãã‚’å¤§åˆ‡ã«ã™ã‚‹å‚¾å‘", 4: "æ–°ã—ã„æ´»å‹•ã‚„å ´æ‰€ã€æœªçŸ¥ã®ã‚‚ã®ã‚’å¥½ã‚€å‚¾å‘", 5: "æŠ½è±¡çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚„çŸ¥çš„ãªéŠã³ã‚’å¥½ã‚€å‚¾å‘", 6: "ä¼çµ±ã‚’ç–‘ã„ã€æ–°ã—ã„ä¾¡å€¤è¦³ã‚’å—ã‘å…¥ã‚Œã‚‹å‚¾å‘" } }
        };

        async function initializePortal() {
            try {
                await liff.init({ liffId: "2009176797-S5FV668D" }); 
                fetchStatistics();
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const userId = profile.userId;

                const url = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${userId}`;
                const res = await fetch(url);
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields) {
                        userData = json.fields;
                        reflectData('motivation', userData.motivationResult, userData.motivationDate);
                        reflectData('bigfive', userData.bigFiveResult, userData.bigFiveDate);
                        reflectData('chrono', userData.chronoResult, userData.chronoDate);
                        reflectData('coffee', userData.coffeeResult, userData.coffeeDate);
                    }
                }
            } catch (err) { console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err); }
        }

        function reflectData(type, resultField, dateField) {
            if(resultField && resultField.stringValue) {
                document.getElementById(`result-${type}`).innerText = resultField.stringValue;
                document.getElementById(`result-${type}`).style.color = "#1e293b";
                document.getElementById(`btn-${type}`).classList.remove('hidden');
                if(dateField && dateField.timestampValue) {
                    const d = new Date(dateField.timestampValue);
                    document.getElementById(`date-${type}`).innerText = d.toLocaleDateString() + " å®Ÿæ–½";
                }
            }
        }

        async function fetchStatistics() {
            try {
                const statsUrl = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`;
                const statsRes = await fetch(statsUrl);
                const statsJson = await statsRes.json();
                if (statsJson.documents) {
                    let totalUsers = 0;
                    let motiCounts = {}, chronoCounts = {}, coffeeCounts = {};
                    statsJson.documents.forEach(doc => {
                        const f = doc.fields;
                        if (f) {
                            let tested = false;
                            if (f.motivationResult) { tested = true; let t = f.motivationResult.stringValue.replace('ã‚„ã‚‹æ°—ï¼š', ''); motiCounts[t] = (motiCounts[t] || 0) + 1; }
                            if (f.chronoResult) { tested = true; let t = f.chronoResult.stringValue.split('ï¼ˆ')[0]; chronoCounts[t] = (chronoCounts[t] || 0) + 1; }
                            if (f.coffeeResult) { tested = true; let t = f.coffeeResult.stringValue.split(' ')[0]; coffeeCounts[t] = (coffeeCounts[t] || 0) + 1; }
                            if (tested) totalUsers++;
                        }
                    });
                    if (totalUsers > 0) {
                        document.getElementById('stat-total').innerText = totalUsers;
                        if (Object.keys(motiCounts).length > 0) document.getElementById('stat-top-motivation').innerText = Object.keys(motiCounts).reduce((a, b) => motiCounts[a] > motiCounts[b] ? a : b);
                        if (Object.keys(chronoCounts).length > 0) document.getElementById('stat-top-chrono').innerText = Object.keys(chronoCounts).reduce((a, b) => chronoCounts[a] > chronoCounts[b] ? a : b);
                        if (Object.keys(coffeeCounts).length > 0) document.getElementById('stat-top-coffee').innerText = Object.keys(coffeeCounts).reduce((a, b) => coffeeCounts[a] > coffeeCounts[b] ? a : b);
                    }
                }
            } catch (e) { console.error("çµ±è¨ˆå–å¾—ã‚¨ãƒ©ãƒ¼:", e); }
        }

function openModal(testType) {
    if (!userData) return;
    document.getElementById('detail-modal').style.display = 'flex';
    const chartContainer = document.getElementById('chart-container');
    const modalText = document.getElementById('modal-text');
    
    let labels = [], dataPoints = [], maxScore = 7, title = "", text = "", extraHTML = "";
    let showChart = true;

    try {
        if (testType === 'bigfive') {
            title = "Big Five åˆ†æ ğŸ§ ";
            // ãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if (!userData.bigFiveScores || !userData.bigFiveScores.stringValue) {
                text = userData.bigFiveResult ? userData.bigFiveResult.stringValue : "è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                showChart = false;
            } else {
                // REST APIå½¢å¼ã®ãƒ‘ãƒ¼ã‚¹
                const s = JSON.parse(userData.bigFiveScores.stringValue);
                const domains = s.domainScores || s; // domainScoreséšå±¤ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã†
                
                // è¡¨ç¤ºãƒ©ãƒ™ãƒ«ã®æ›´æ–°ï¼ˆã€Œç¥çµŒç—‡çš„å‚¾å‘ã€ã«çµ±ä¸€ï¼‰
                labels = ['å¤–å‘æ€§', 'å”èª¿æ€§', 'èª å®Ÿæ€§', 'ç¥çµŒç—‡çš„å‚¾å‘', 'é–‹æ”¾æ€§'];
                
                // ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆã®æŠ½å‡ºï¼ˆä¿å­˜æ™‚ã®è‹±èªã‚­ãƒ¼åã«åˆã‚ã›ã‚‹ï¼‰
                dataPoints = [
                    domains.extraversion || domains.E || 0,
                    domains.agreeableness || domains.A || 0,
                    domains.conscientiousness || domains.C || 0,
                    domains.neuroticism || domains.N || 0,
                    domains.openness || domains.O || 0
                ];

                // æº€ç‚¹ã®åˆ¤å®šï¼ˆlatestTestãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèªï¼‰
                const isFull = (userData.latestTest && userData.latestTest.stringValue === "bigfive_full");
                maxScore = isFull ? 120 : 7;

                text = "ä¸–ç•ŒåŸºæº–ã®æ€§æ ¼åˆ†æçµæœã§ã™ã€‚å¤–å´ã«åºƒãŒã£ã¦ã„ã‚‹é …ç›®ãŒã‚ãªãŸã®å¼·ã¿ã§ã™ã€‚\n\n";

                // 30é …ç›®ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆfacetScoresãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
                if (s.facetScores) {
                    extraHTML = `<div class="mt-6 border-t border-slate-200 pt-5"><h5 class="text-sm font-black text-slate-800 mb-4">ğŸ”¬ 30é …ç›®ã®è©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°</h5><div class="space-y-6">`;
                    
                    // E, A, C, N, O ã®é †ã§è¡¨ç¤º
                    const domainKeys = ['E', 'A', 'C', 'N', 'O'];
                    domainKeys.forEach(key => {
                        const d = FACET_DICT[key];
                        const fData = s.facetScores[key];
                        if (fData && d) {
                            extraHTML += `<div class="bg-slate-50 rounded-xl p-4 border border-slate-100"><h6 class="text-xs font-black text-slate-700 mb-3">${d.title}</h6><div class="space-y-3">`;
                            
                            // 1ã€œ6ã®å°é …ç›®ã‚’ãƒ«ãƒ¼ãƒ—
                            for (let i = 1; i <= 6; i++) {
                                // ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ¼ãŒæ•°å­—('1')ã‹è‹±èªåã‹ä¸¡æ–¹å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                                const score = fData[i] || Object.values(fData)[i-1] || 0;
                                const facetName = d.facets[i];
                                const facetDesc = d.descs ? d.descs[i] : ""; // descãƒ‡ãƒ¼ã‚¿ã®è£œå®Œ
                                const percent = Math.min(100, Math.round((score / 20) * 100));

                                extraHTML += `
                                <div>
                                    <div class="flex justify-between items-end mb-1">
                                        <span class="text-[11px] font-bold text-slate-800">${facetName}</span>
                                        <span class="text-[10px] font-black text-slate-400">${score}/20</span>
                                    </div>
                                    <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden mb-1">
                                        <div class="h-full ${d.color} rounded-full" style="width: ${percent}%"></div>
                                    </div>
                                    <p class="text-[9px] text-slate-500 leading-tight">${facetDesc}</p>
                                </div>`;
                            }
                            extraHTML += `</div></div>`;
                        }
                    });
                    extraHTML += `</div></div>`;
                }
            }
        }
        else if (testType === 'motivation' && userData.motivationScores) {
                    const s = JSON.parse(userData.motivationScores.stringValue);
                    const resName = userData.motivationResult ? userData.motivationResult.stringValue : "";
                    labels = ['æˆé•·æ€è€ƒ', 'è³è³›æ¬²æ±‚', 'è‡ªä¿¡']; 
                    dataPoints = [s.mindset || 0, s.focus || 0, s.confidence || 0]; 
                    maxScore = 2;
                    title = "ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ— åˆ†æ ğŸ”¥";
                    text = `ã€ ${resName} ã€‘\n\nã‚ãªãŸã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã®æºæ³‰ã‚’åˆ†æã—ã¾ã—ãŸï¼\n\n`;
                    text += (s.mindset >= 1 ? "ğŸŒ± æˆé•·æ€è€ƒï¼šé«˜\nå›°é›£ãªèª²é¡Œã«ç‡ƒãˆã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚\n\n" : "ğŸŒ± æˆé•·æ€è€ƒï¼šå®‰å®š\nåŠ¹ç‡ã‚’é‡è¦–ã™ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚\n\n");
                    // ... (ä»–ã®è§£èª¬ã‚‚åŒæ§˜ã« .stringValue ã‚’è€ƒæ…®ã—ã¦ç¶™ç¶š)
                }
                else if (testType === 'chronotype' && userData.chronoResult) {
                    showChart = false;
                    title = "ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ— åˆ†æ â°";
                    text = userData.chronoResult.stringValue.replace(/\n/g, '<br>');
                }
                else if (testType === 'coffee' && userData.coffeeResult) {
                    showChart = false;
                    title = "ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ åˆ†æ â˜•";
                    text = userData.coffeeResult.stringValue.replace(/\n/g, '<br>');
                }

                // è¡¨ç¤ºã®åæ˜ 
                document.getElementById('modal-title').innerText = title;
                modalText.innerHTML = text.replace(/\n/g, '<br>') + extraHTML;

                if (showChart) {
                    chartContainer.style.display = 'block';
                    drawChart(labels, dataPoints, maxScore);
                } else {
                    chartContainer.style.display = 'none';
                }

            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
                modalText.innerHTML = "ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚";
            }
}
        initializePortal();
    </script>
</body>
</html>