<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>北大心理ゼミ Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: #f0fdfa; color: #1e293b; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .btn-hover { transition: transform 0.2s; }
        .btn-hover:active { transform: scale(0.96); }
        #detail-modal { display: none; transition: opacity 0.3s; }
        #detail-modal.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-bg { animation: pulseBg 3s infinite alternate; }
        @keyframes pulseBg { 0% { background-color: #f8fafc; } 100% { background-color: #f1f5f9; } }
    </style>
</head>
<body class="safe-area-inset-top pb-24 relative">

    <header class="bg-white px-6 py-8 rounded-b-[2rem] shadow-sm mb-6 text-center">
        <p class="text-[10px] font-black text-sky-500 tracking-[0.3em] mb-2 uppercase">Hokkaido University</p>
        <h1 class="text-2xl font-black text-slate-800 tracking-tight mb-2">北大心理ゼミ <span class="text-xl">💡</span></h1>
        <p class="text-xs text-slate-500 font-bold mt-3 bg-slate-100 inline-block px-3 py-1 rounded-full">「心」を科学する学生コミュニティ</p>
    </header>

    <main class="px-5 space-y-8">

        <section class="pulse-bg border-2 border-slate-200 rounded-[2rem] p-5 text-center relative overflow-hidden shadow-inner">
            <div class="absolute -top-4 -right-4 text-6xl opacity-10">📊</div>
            <h2 class="text-xs font-black text-slate-500 tracking-widest mb-3">RESEARCH DATA</h2>
            <div class="flex justify-center items-end space-x-1 mb-4">
                <span class="text-sm font-bold text-slate-600 pb-1">現在、北大生</span>
                <span id="stat-total" class="text-4xl font-black text-sky-600 tracking-tighter">--</span>
                <span class="text-sm font-bold text-slate-600 pb-1">人が診断済！</span>
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mb-2">👑 一番多いタイプは...</p>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">🔥 やる気</p>
                    <p id="stat-top-motivation" class="text-[11px] font-black text-orange-500 break-words">集計中...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">⏰ 時間帯</p>
                    <p id="stat-top-chrono" class="text-[11px] font-black text-emerald-500 break-words">集計中...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">☕ コーヒー</p>
                    <p id="stat-top-coffee" class="text-[11px] font-black text-amber-600 break-words">集計中...</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-indigo-500">心理テストを受ける</h2>
            <div class="grid grid-cols-2 gap-3">
                <a href="motivation.html" class="btn-hover block bg-gradient-to-br from-orange-400 to-rose-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">やる気８タイプ 🔥</h3>
                    <p class="text-[9px] font-bold text-white/80">モチベの源泉を特定</p>
                </a>
                <a href="bigfive.html" class="btn-hover block bg-gradient-to-br from-indigo-500 to-cyan-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">Big Five診断 🧠</h3>
                    <p class="text-[9px] font-bold text-white/80">世界基準の性格分析</p>
                </a>
                <a href="chronotype.html" class="btn-hover block bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">クロノタイプ ⏰</h3>
                    <p class="text-[9px] font-bold text-white/80">最強の「時間帯」が判明</p>
                </a>
                <a href="coffee.html" class="btn-hover block bg-gradient-to-br from-amber-500 to-orange-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">コーヒー性格 ☕</h3>
                    <p class="text-[9px] font-bold text-white/80">1問でわかる深層心理</p>
                </a>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-sky-400">あなたの分析データ</h2>
            <div class="space-y-3">
                
                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">やる気８タイプ診断</span>
                        <span id="date-motivation" class="text-[10px] font-bold text-slate-400">未診断</span>
                    </div>
                    <p id="result-motivation" class="text-base font-black text-slate-400 mb-3">テストを受けてみよう！</p>
                    <button id="btn-motivation" onclick="openModal('motivation')" class="hidden w-full bg-orange-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">詳細を見る</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">Big Five 性格テスト</span>
                        <span id="date-bigfive" class="text-[10px] font-bold text-slate-400">未診断</span>
                    </div>
                    <p id="result-bigfive" class="text-base font-black text-slate-400 mb-3">テストを受けてみよう！</p>
                    <button id="btn-bigfive" onclick="openModal('bigfive')" class="hidden w-full bg-indigo-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">詳細を見る</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">クロノタイプ診断</span>
                        <span id="date-chrono" class="text-[10px] font-bold text-slate-400">未診断</span>
                    </div>
                    <p id="result-chrono" class="text-base font-black text-slate-400 mb-3">テストを受けてみよう！</p>
                    <button id="btn-chrono" onclick="openModal('chronotype')" class="hidden w-full bg-emerald-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">詳細を見る</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">コーヒー性格テスト</span>
                        <span id="date-coffee" class="text-[10px] font-bold text-slate-400">未診断</span>
                    </div>
                    <p id="result-coffee" class="text-base font-black text-slate-400 mb-3">テストを受けてみよう！</p>
                    <button id="btn-coffee" onclick="openModal('coffee')" class="hidden w-full bg-amber-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">詳細を見る</button>
                </div>

            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-teal-400">ゼミ生の活動・コラム</h2>
            <div class="space-y-3">
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-teal-50 rounded-xl text-2xl mr-4">📖</div>
                    <div><h3 class="text-sm font-black text-slate-800">AI先輩の3分心理学コラム</h3><p class="text-[10px] font-bold text-slate-500 mt-1">「エリートタイプ」の落とし穴とは？</p></div>
                </a>
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-amber-50 rounded-xl text-2xl mr-4">📸</div>
                    <div><h3 class="text-sm font-black text-slate-800">ゼミ活動日誌 & メンバー紹介</h3><p class="text-[10px] font-bold text-slate-500 mt-1">個性豊かな先輩たちを大公開！</p></div>
                </a>
            </div>
        </section>

        <section class="btn-hover">
            <a href="#" class="block bg-gradient-to-r from-amber-400 to-orange-500 rounded-[2rem] p-6 text-center shadow-lg relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 text-6xl opacity-20">☕</div>
                <h2 class="text-white font-black text-sm mb-2 drop-shadow-md">＼ 新入生歓迎イベント開催！ ／</h2>
                <p class="text-white/90 text-xs font-bold mb-4 drop-shadow-sm">心理学に興味がある人、大歓迎！<br>まずはオンライン説明会へ遊びに来てね✨</p>
                <span class="inline-block bg-white text-orange-500 text-xs font-black px-8 py-3 rounded-full shadow-md">詳細・参加申込はこちら！ 👉</span>
            </a>
        </section>

    </main>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 z-50 justify-center items-end pb-0 sm:items-center sm:p-5 hidden">
        <div class="bg-white w-full sm:w-96 rounded-t-[2rem] sm:rounded-[2rem] p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">詳細レポート 📑</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xl bg-slate-100 rounded-full w-8 h-8 flex justify-center items-center">×</button>
            </div>
            
            <div id="chart-container" class="w-full aspect-square mb-6 bg-slate-50 rounded-2xl p-2">
                <canvas id="radarChart"></canvas>
            </div>
            
            <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                <h4 class="text-xs font-black text-indigo-600 mb-2">🤖 AI先輩の分析</h4>
                <p id="modal-text" class="text-xs text-slate-700 font-bold leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-700 text-sm font-black py-3 rounded-xl mt-2 active:bg-slate-300">閉じる</button>
        </div>
    </div>

    <script>
        let myChart = null;
        let userData = null;

        const FACET_DICT = {
            'E': { title: "外向性の内訳", color: "bg-orange-400", facets: { 1: "友好性", 2: "社交性", 3: "自己主張", 4: "活動水準", 5: "刺激希求", 6: "明朗性" },
                descs: { 1: "周囲へ親しみを感じ、温かく接する傾向", 2: "人と一緒にいることを好み、集団を求める傾向", 3: "リーダーシップを取り、意見を主張する力", 4: "エネルギッシュに活動的に動くペース", 5: "スリルや強い刺激を求める傾向", 6: "喜びや楽しさを感じやすい傾向" } },
            'A': { title: "協調性の内訳", color: "bg-green-400", facets: { 1: "信頼", 2: "誠実さ", 3: "利他主義", 4: "順応性", 5: "謙虚さ", 6: "優しい心" },
                descs: { 1: "他人の意図が善意であると信じる傾向", 2: "駆け引きをせず、率直で隠し事がない傾向", 3: "他人の幸福を願い、進んで援助する傾向", 4: "対立を避け、他人に譲歩して許す傾向", 5: "自慢をせず、自分を控えめに表現する傾向", 6: "他人の苦しみに共感し、同情する傾向" } },
            'C': { title: "誠実性の内訳", color: "bg-blue-400", facets: { 1: "自己効力感", 2: "秩序性", 3: "義務感", 4: "達成努力", 5: "自己鍛錬", 6: "慎重さ" },
                descs: { 1: "物事を成し遂げる能力があると信じる傾向", 2: "整理整頓を好み、計画的に進める傾向", 3: "ルールや道徳的な義務を厳格に守る傾向", 4: "高い目標を設定し、それに向かって努力する傾向", 5: "困難なタスクでも投げ出さずにやり遂げる力", 6: "行動前に結果を予測し、深く考えてから動く傾向" } },
            'N': { title: "神経症的傾向の内訳", color: "bg-purple-400", facets: { 1: "不安", 2: "怒り", 3: "抑うつ", 4: "自意識", 5: "衝動性", 6: "脆弱性" },
                descs: { 1: "心配事や恐怖、将来への不安を感じやすい傾向", 2: "イライラしやすく、不満を抱きやすい傾向", 3: "悲しみや孤独感を感じて落ち込みやすい傾向", 4: "他人の目を気にし、恥ずかしさを感じやすい傾向", 5: "強い欲求に抗えず、感情で行動してしまう傾向", 6: "プレッシャーに弱く、パニックになりやすい傾向" } },
            'O': { title: "開放性の内訳", color: "bg-pink-400", facets: { 1: "想像力", 2: "芸術的関心", 3: "感情性", 4: "冒険心", 5: "知性", 6: "進取性" },
                descs: { 1: "空想を好み、豊かな内面世界を持つ傾向", 2: "音楽や美術などの美しさに深く感動する傾向", 3: "自分の感情の動きを大切にする傾向", 4: "新しい活動や場所、未知のものを好む傾向", 5: "抽象的なアイデアや知的な遊びを好む傾向", 6: "伝統を疑い、新しい価値観を受け入れる傾向" } }
        };

        async function initializePortal() {
            try {
                await liff.init({ liffId: "2009176797-S5FV668D" }); 
                fetchStatistics();
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                const userId = profile.userId;

                const url = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${userId}`;
                const res = await fetch(url);
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields) {
                        userData = json.fields;
                        reflectData('motivation', userData.motivationResult, userData.motivationDate);
                        reflectData('bigfive', userData.bigFiveResult, userData.bigFiveDate);
                        reflectData('chrono', userData.chronoResult, userData.chronoDate);
                        reflectData('coffee', userData.coffeeResult, userData.coffeeDate);
                    }
                }
            } catch (err) { console.error("初期化エラー:", err); }
        }

        function reflectData(type, resultField, dateField) {
            if(resultField && resultField.stringValue) {
                document.getElementById(`result-${type}`).innerText = resultField.stringValue;
                document.getElementById(`result-${type}`).style.color = "#1e293b";
                document.getElementById(`btn-${type}`).classList.remove('hidden');
                if(dateField && dateField.timestampValue) {
                    const d = new Date(dateField.timestampValue);
                    document.getElementById(`date-${type}`).innerText = d.toLocaleDateString() + " 実施";
                }
            }
        }

        async function fetchStatistics() {
            try {
                const statsUrl = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`;
                const statsRes = await fetch(statsUrl);
                const statsJson = await statsRes.json();
                if (statsJson.documents) {
                    let totalUsers = 0;
                    let motiCounts = {}, chronoCounts = {}, coffeeCounts = {};
                    statsJson.documents.forEach(doc => {
                        const f = doc.fields;
                        if (f) {
                            let tested = false;
                            if (f.motivationResult) { tested = true; let t = f.motivationResult.stringValue.replace('やる気：', ''); motiCounts[t] = (motiCounts[t] || 0) + 1; }
                            if (f.chronoResult) { tested = true; let t = f.chronoResult.stringValue.split('（')[0]; chronoCounts[t] = (chronoCounts[t] || 0) + 1; }
                            if (f.coffeeResult) { tested = true; let t = f.coffeeResult.stringValue.split(' ')[0]; coffeeCounts[t] = (coffeeCounts[t] || 0) + 1; }
                            if (tested) totalUsers++;
                        }
                    });
                    if (totalUsers > 0) {
                        document.getElementById('stat-total').innerText = totalUsers;
                        if (Object.keys(motiCounts).length > 0) document.getElementById('stat-top-motivation').innerText = Object.keys(motiCounts).reduce((a, b) => motiCounts[a] > motiCounts[b] ? a : b);
                        if (Object.keys(chronoCounts).length > 0) document.getElementById('stat-top-chrono').innerText = Object.keys(chronoCounts).reduce((a, b) => chronoCounts[a] > chronoCounts[b] ? a : b);
                        if (Object.keys(coffeeCounts).length > 0) document.getElementById('stat-top-coffee').innerText = Object.keys(coffeeCounts).reduce((a, b) => coffeeCounts[a] > coffeeCounts[b] ? a : b);
                    }
                }
            } catch (e) { console.error("統計取得エラー:", e); }
        }

        function openModal(testType) {
            if (!userData) return;
            document.getElementById('detail-modal').style.display = 'flex';
            const chartContainer = document.getElementById('chart-container');
            const modalText = document.getElementById('modal-text');
            
            // ★ UI修正：モーダルの中の文字を「左揃え」に強制し、折り返す！
            modalText.className = "text-xs text-slate-700 font-bold leading-relaxed whitespace-pre-wrap break-words text-left";
            
            let labels = [], dataPoints = [], maxScore = 7, title = "", text = "", extraHTML = "";
            let showChart = true;

            function safeParse(field) {
                if (!field) return {};
                if (field.stringValue) {
                    try { return JSON.parse(field.stringValue); } 
                    catch(e) { return {}; }
                }
                return field;
            }
            function safeString(field) { return field && field.stringValue ? field.stringValue : "データなし"; }

            try {
                if (testType === 'bigfive') {
                    title = "Big Five 分析 🧠";
                    if (!userData.bigFiveScores) {
                        text = safeString(userData.bigFiveResult);
                        showChart = false;
                    } else {
                        const s = safeParse(userData.bigFiveScores);
                        const domains = s.domainScores || s;
                        
                        labels = ['外向性', '協調性', '誠実性', '神経症的傾向', '開放性'];
                        dataPoints = [
                            Number(domains.extraversion || domains.E || 0),
                            Number(domains.agreeableness || domains.A || 0),
                            Number(domains.conscientiousness || domains.C || 0),
                            Number(domains.neuroticism || domains.N || 0),
                            Number(domains.openness || domains.O || 0)
                        ];
                        
                        const isFull = (safeString(userData.latestTest) === "bigfive_full" || !!s.facetScores);
                        maxScore = isFull ? 120 : 7;
                        const mid = maxScore / 2;

                        text = "【 AI先輩の性格傾向分析 】\n";
                        text += (dataPoints[0] >= mid ? "🔥 外向性 [高]：社交的でポジティブなエネルギーに溢れています。\n" : "☕ 外向性 [低]：一人の時間を大切にし、深く考える慎重派です。\n");
                        text += (dataPoints[1] >= mid ? "🤝 協調性 [高]：思いやりがあり、チームの和を大切にします。\n" : "⚔️ 協調性 [低]：合理性を重んじ、自分の意見をしっかり持っています。\n");
                        text += (dataPoints[2] >= mid ? "📋 誠実性 [高]：責任感が強く、計画的に物事を完遂します。\n" : "🌱 誠実性 [低]：型にとらわれず、臨機応変な対応が得意です。\n");
                        text += (dataPoints[3] >= mid ? "🌧️ 神経症的傾向 [高]：些細な変化に気づける、高いリスク察知能力の持ち主です。\n" : "🛡️ 神経症的傾向 [低]：プレッシャーに強く、常にどっしり構える安定感があります。\n");
                        text += (dataPoints[4] >= mid ? "💡 開放性 [高]：好奇心旺盛で、新しいアイデアや挑戦が大好きです。\n" : "🏛️ 開放性 [低]：現実的で、地に足のついた実績や伝統を重んじます。\n");
                        text += "\n💡 低い項目は「欠点」ではなく、裏を返せば強力な「別の才能」です！";

                        if (isFull && s.facetScores && typeof s.facetScores === 'object') {
                            extraHTML = `<div class="mt-6 border-t border-slate-200 pt-5 text-left"><h5 class="text-sm font-black text-slate-800 mb-4">🔬 30項目の詳細レポート（タップで展開）</h5><div class="space-y-3">`;
                            const domainInfo = {
                                'E': { icon: '🔥', name: '外向性 (Extraversion)' },
                                'A': { icon: '🤝', name: '協調性 (Agreeableness)' },
                                'C': { icon: '📋', name: '誠実性 (Conscientiousness)' },
                                'N': { icon: '🌧️', name: '神経症的傾向 (Neuroticism)' },
                                'O': { icon: '💡', name: '開放性 (Openness)' }
                            };
                            ['E', 'A', 'C', 'N', 'O'].forEach(key => {
                                const d = FACET_DICT[key];
                                const fData = s.facetScores[key];
                                if (fData && typeof fData === 'object' && d) {
                                    extraHTML += `
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                                        <summary class="flex justify-between items-center p-4 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden bg-slate-50 hover:bg-slate-100 transition">
                                            <div class="flex items-center gap-2"><span class="text-lg">${domainInfo[key].icon}</span> ${domainInfo[key].name}</div>
                                            <span class="transition duration-300 group-open:rotate-180 text-slate-400">▼</span>
                                        </summary>
                                        <div class="p-4 border-t border-slate-100 bg-white space-y-4">
                                            <p class="text-[10px] text-slate-400 font-bold mb-3">※スコアが低い場合も「逆の強み」があることを意味します。</p>
                                    `;
                                    Object.keys(d.facets).forEach((idx, arrayIndex) => {
                                        let score = Number(fData[idx]);
                                        if (isNaN(score)) score = Number(Object.values(fData)[arrayIndex]) || 0;
                                        const percent = Math.min(100, Math.max(0, Math.round((score / 20) * 100)));
                                        const facetName = d.facets[idx];
                                        const facetDesc = d.descs ? d.descs[idx] : "";
                                        extraHTML += `<div><div class="flex justify-between items-end mb-1"><span class="text-[11px] font-bold text-slate-800">${facetName}</span><span class="text-[10px] font-black text-slate-400">${score}/20</span></div>
                                        <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden mb-1"><div class="h-full ${d.color} rounded-full" style="width: ${percent}%"></div></div>
                                        <p class="text-[9px] text-slate-500 leading-tight">${facetDesc}</p></div>`;
                                    });
                                    extraHTML += `</div></details>`;
                                }
                            });
                            extraHTML += `</div></div>`;
                        }
                    }
                } 
                else if (testType === 'motivation') {
                    title = "やる気８タイプ 分析 🔥";
                    if (!userData.motivationScores) {
                        text = "まだ診断データがありません。";
                        showChart = false;
                    } else {
                        const s = safeParse(userData.motivationScores);
                        const resName = safeString(userData.motivationResult).replace('やる気：', '');
                        labels = ['成長思考', '賞賛欲求', '自信']; 
                        dataPoints = [Number(s.mindset || 0), Number(s.focus || 0), Number(s.confidence || 0)]; 
                        maxScore = 2; 
                        text = `【 ${resName} 】\n\nあなたのモチベーションの源泉を分析しました！\n\n`;
                        text += dataPoints[0] >= 1 ? "🌱 成長思考：高\n困難な課題や新しい知識の吸収に燃えるタイプ。\n\n" : "🌱 成長思考：安定\n無駄な労力をかけず、効率よく目標を達成するプロセスにやりがいを感じるタイプ。\n\n";
                        text += dataPoints[1] >= 1 ? "👀 賞賛欲求：高\n人から認められ、褒められると120%の力を発揮します！\n\n" : "👀 賞賛欲求：内発的\n他人の評価より自分が納得するクオリティをとことん追求する職人肌です。\n\n";
                        text += dataPoints[2] >= 1 ? "✨ 自信：高\nプレッシャーのかかる場面でも物怖じせず挑戦できます。\n\n" : "✨ 自信：慎重\nリスクを事前に察知し、綿密な計画を立てるサポーター気質です。\n\n";
                    }
                } 
                else if (testType === 'chronotype') {
                    showChart = false;
                    title = "クロノタイプ 分析 ⏰";
                    const t = safeString(userData.chronoResult);
                    let desc = "", routine = "";
                    if(t.includes('ライオン')) {
                        desc = "【 ライオン型（朝型）🦁 】\n全人口の15〜20%を占める生粋の朝型。狩りをするライオンのように、目覚めとともにエネルギーが全開になります。";
                        routine = "05:30 起床して朝食（タンパク質多め）\n06:00 - 09:00 集中して仕事（🔥 ゴールデンタイム！）\n09:00 - 10:00 カフェイン投入\n10:00 - 12:00 会議や雑用\n12:00 昼食\n13:00 - 17:00 アイデア出し等、創造的な仕事\n17:00 - 18:00 エクササイズ\n18:00 - 19:00 夕食\n22:00 スマホ・PCをオフ\n22:30 就寝";
                    } else if(t.includes('クマ')) {
                        desc = "【 クマ型（昼型）🐻 】\n全人口の50%を占める標準的な昼型。太陽の動きに合わせて生活し、親切で開放的な性格が多いです。";
                        routine = "07:00 起床して2〜3分の運動\n07:30 朝食（タンパク質多め）\n09:00 - 10:00 カフェイン投入、1日の計画\n10:00 - 12:00 集中力が必要なタスク（🔥 ゴールデンタイム！）\n12:00 昼食 → 軽く散歩\n14:30 - 14:50 瞑想またはパワーナップ(昼寝)\n15:00 - 18:00 会議や雑用\n18:00 - 19:00 エクササイズ\n19:30 夕食\n20:00 - 22:00 創造的な仕事\n23:00 就寝";
                    } else if(t.includes('オオカミ')) {
                        desc = "【 オオカミ型（夜型）🐺 】\n全人口の15〜20%の夜型。朝は弱く、夕方以降に集中力と創造性がピークに達するクリエイター気質です。";
                        routine = "07:30 起床して朝食（タンパク質多め）\n08:30 軽いエクササイズ\n09:00 1日の計画\n11:00 - 13:00 カフェイン投入、雑用\n13:00 昼食 → 散歩\n15:00 - 18:00 集中力が必要な仕事\n18:00 - 19:00 エクササイズ\n20:00 夕食\n21:00 - 23:00 創造的な仕事（🔥 ゴールデンタイム！）\n24:00 就寝";
                    } else if(t.includes('イルカ')) {
                        desc = "【 イルカ型（不規則型）🐬 】\n全人口の10%の不規則型。眠りが浅く神経質ですが、知性が高く完璧主義な一面があります。";
                        routine = "06:30 起床して軽くエクササイズ\n07:30 朝食（タンパク質多め）\n09:30 カフェイン投入\n10:00 - 12:00 創造的な仕事\n12:00 昼食\n13:00 - 16:00 雑用またはエクササイズ\n17:00 - 18:00 集中力が必要な仕事（🔥 ゴールデンタイム！）\n18:00 瞑想やヨガ\n19:00 夕食\n23:30 就寝";
                    }
                    if(desc) {
                        text = desc;
                        extraHTML = `
                            <div class="mt-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-left">
                                <h5 class="text-xs font-black text-indigo-800 mb-2">📚 診断の根拠</h5>
                                <p class="text-[10px] text-indigo-700 leading-relaxed break-words">米国の睡眠専門医・臨床心理学者である<br><strong>マイケル・ブレウス博士</strong>の調査と著書『The Power of When』に基づいています。</p>
                            </div>
                            <div class="mt-5 border-t border-slate-200 pt-5 text-left">
                                <h5 class="text-sm font-black text-slate-800 mb-3">🗓️ 推奨タイムスケジュール</h5>
                                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 shadow-inner overflow-x-auto">
                                    <pre class="text-[10px] text-slate-700 font-bold whitespace-pre-wrap break-words font-sans leading-relaxed min-w-full">${routine}</pre>
                                </div>
                            </div>
                            <div class="mt-6 border-t border-slate-200 pt-5 text-left">
                                <h5 class="text-sm font-black text-slate-800 mb-3">🔍 他のクロノタイプ</h5>
                                <div class="space-y-2">
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🦁 ライオン（朝型）</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold break-words">全人口の15〜20%。朝イチから全開で、午前中に重いタスクをこなすのが得意。午後は早い段階でエネルギー切れになりがち。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🐻 クマ（昼型）</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold break-words">全人口の50%。太陽の動きに合わせた標準的な体内時計。親切で開放的な性格が多い。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🐺 オオカミ（夜型）</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold break-words">全人口の15〜20%。夕方以降から本領発揮するクリエイター気質。朝は非常に弱い。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🐬 イルカ（不規則型）</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold break-words">全人口の10%。眠りが浅く神経質だが、知性が高く完璧主義。ちょっとした音で目が覚めやすい。</div>
                                    </details>
                                </div>
                            </div>
                        `;
                    } else { text = t; }
                } 
                else if (testType === 'coffee') {
                    showChart = false;
                    title = "コーヒー性格 分析 ☕";
                    const t = safeString(userData.coffeeResult);
                    let desc = "", strong = "", weak = "", psycho = "";
                    
                    if(t.includes('ブラック')) {
                        desc = "【 ブラックコーヒー ☕ 】\n苦味をそのまま受け入れる、合理的でストレートな性格。";
                        strong = "無駄を嫌い、効率を重んじて物事をシンプルに解決する能力に長けています。目標に向かって一直線に進む忍耐力があります。";
                        weak = "他人のやり方に合わせるのが苦手で、少し頑固（気分屋）になりがちです。";
                        psycho = "白黒はっきりさせたい「合理主義」の傾向。物事を複雑にせず、本質だけを見極めようとするため、ゼミのリーダーやマネージャーとしての適性が高いです。";
                    } else if(t.includes('カフェラテ')) {
                        desc = "【 カフェラテ（ミルク入り） 🥛 】\nコーヒーの苦味をミルクで和らげるように、人生のストレスも和らげようとする平和主義者。";
                        strong = "非常に協調性が高く、周囲を気遣うお人好し。人間関係の潤滑油になれる天性の優しさがあります。";
                        weak = "他人のために自分を犠牲にしすぎたり、頼み事を断れずにキャパオーバーになりがちです。";
                        psycho = "「苦痛を和らげたい」という深層心理があり、他人に優しくすることで自分も満たされる「ギバー（与える人）」の傾向が強いです。チームの癒やし担当にぴったりです。";
                    } else if(t.includes('フローズン')) {
                        desc = "【 フローズン / ブレンド 🧊 】\n新しい刺激や甘いご褒美を求める、好奇心旺盛なトレンドセッター。";
                        strong = "子どものような豊かな想像力を持ち、直感やひらめきでゼロからイチを生み出すのが得意です。社交的でノリが良いのも特徴。";
                        weak = "計画性がやや低く、目先の楽しさや安易な解決策に飛びついて無謀な選択をしやすい一面があります。";
                        psycho = "心理学でいう「刺激希求性（新しい体験を求める傾向）」が非常に高く、ルーティンワークよりも、イベント企画やSNS運用など変化のあるクリエイティブな場面で輝きます。";
                    } else if(t.includes('特殊')) {
                        desc = "【 特殊オーダー（カフェインレス・ソイ等） ✨ 】\n自分の体調やルールのコントロールを重視する、こだわりの強い完璧主義タイプ。";
                        strong = "健康意識が高く、自分の状態を客観的に分析して正しい選択ができる自立心があります。";
                        weak = "秩序やルールにこだわりすぎるあまり、予定が狂うと強い不安やストレスを感じやすい繊細さがあります。";
                        psycho = "「コントロール欲求」が高く、自分の環境を細部まで自分自身で管理したい傾向があります。研究データの分析や論文のチェックなど、緻密さが求められるタスクで右に出る者はいません。";
                    } else if(t.includes('インスタント')) {
                        desc = "【 インスタントコーヒー 🍵 】\n手軽さや伝統的な方法を好む、究極のマイペース＆のんびり屋。";
                        strong = "どんな状況でも気楽に構えることができ、細かいことに動じない圧倒的なスルースキルを持っています。";
                        weak = "大事な決断やタスクをつい後回しにしてしまう、先延ばし癖（プロクラスティネーション）があります。";
                        psycho = "「現状維持バイアス」が強く、効率や新しさよりも「いつもの安心感」を優先します。周囲が焦っている状況でも平常心を保てる、ゼミの貴重なメンタル安定剤です。";
                    }

                    if(desc) {
                        text = desc;
                        extraHTML = `
                            <div class="mt-4 bg-orange-50 p-4 rounded-xl border border-orange-100 space-y-3 text-left">
                                <div>
                                    <span class="inline-block text-[10px] font-black text-orange-600 bg-orange-100 px-2 py-1 rounded mb-1">✨ 長所 (強み)</span>
                                    <p class="text-[11px] text-slate-700 font-bold leading-relaxed ml-1 break-words">${strong}</p>
                                </div>
                                <div class="pt-2 border-t border-orange-100/50">
                                    <span class="inline-block text-[10px] font-black text-blue-600 bg-blue-100 px-2 py-1 rounded mb-1">💦 短所 (注意点)</span>
                                    <p class="text-[11px] text-slate-700 font-bold leading-relaxed ml-1 break-words">${weak}</p>
                                </div>
                            </div>

                            <div class="mt-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100 text-left">
                                <h5 class="text-xs font-black text-indigo-800 mb-2">🧠 心理メカニズムの解説</h5>
                                <p class="text-[11px] text-indigo-700 leading-relaxed font-bold break-words">${psycho}</p>
                            </div>

                            <div class="mt-5 bg-amber-50 p-4 rounded-xl border border-amber-100 text-left">
                                <h5 class="text-xs font-black text-amber-800 mb-2">📚 診断の根拠</h5>
                                <p class="text-[10px] text-amber-700 leading-relaxed break-words">カリフォルニア州立大学の臨床心理学者<br><strong>ラマニ・ドゥルバスラ博士</strong>が1000人を対象に行った行動心理学の観察研究に基づいています。</p>
                            </div>

                            <div class="mt-6 border-t border-slate-200 pt-5 text-left">
                                <h5 class="text-sm font-black text-slate-800 mb-3">🔍 他のコーヒー性格</h5>
                                <div class="space-y-2">
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">☕ ブラック</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold leading-relaxed break-words">忍耐強くて効率的。物事をシンプルに考えるのが得意だが、気分屋で自分のやり方に固執しがち。白黒はっきりさせたい合理主義者。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🥛 カフェラテ</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold leading-relaxed break-words">お人好しで世話焼き。他人の面倒を見すぎるあまり、自分を犠牲にしてしまいがち。「苦痛を和らげたい」という深層心理を持つギバー。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🧊 フローズン / ブレンド</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold leading-relaxed break-words">流行に敏感で創造性が高いが、無謀な選択をしやすく、安易な解決策に飛びつきやすい。常に新しい体験を求める「刺激希求性」が高い。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">✨ 特殊オーダー</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold leading-relaxed break-words">自立心が強く健康志向。完璧主義がゆえにルールにこだわりすぎ、不安を感じやすい。自分の環境を管理したい「コントロール欲求」が高い。</div>
                                    </details>
                                    <details class="group bg-white rounded-xl shadow-sm border border-slate-200">
                                        <summary class="flex justify-between items-center p-3 cursor-pointer font-black text-slate-700 list-none [&::-webkit-details-marker]:hidden hover:bg-slate-50 transition">
                                            <span class="text-xs">🍵 インスタント</span><span class="text-slate-400 group-open:rotate-180 transition">▼</span>
                                        </summary>
                                        <div class="p-3 border-t border-slate-100 text-[10px] text-slate-600 font-bold leading-relaxed break-words">気楽でのんびり屋。些細なことに動じないが、大事なことでも先送りにしがち。新しさよりも安心感を好む「現状維持バイアス」が強い。</div>
                                    </details>
                                </div>
                            </div>
                        `;
                    } else { text = t; }
                }

                document.getElementById('modal-title').innerText = title;
                modalText.innerHTML = text.replace(/\n/g, '<br>') + extraHTML;
                
                if (showChart) { 
                    chartContainer.style.display = 'block'; 
                    drawChart(labels, dataPoints, maxScore); 
                } else { 
                    chartContainer.style.display = 'none'; 
                }

            } catch (e) { 
                console.error("データ処理エラー:", e); 
                document.getElementById('modal-title').innerText = "エラーが発生しました 💥";
                modalText.innerHTML = `データの解析中に予期せぬエラーが起きました。<br><br><span class="text-red-500 text-[10px] bg-red-50 p-2 rounded block break-words">${e.message}</span>`;
                chartContainer.style.display = 'none';
            }
        }

        // ==========================================
        // 💥 消えていた2つの超重要関数を大復活！！！
        // ==========================================
        function closeModal() { 
            document.getElementById('detail-modal').style.display = 'none'; 
        }

        function drawChart(labels, dataPoints, maxScore) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            if(myChart) { myChart.destroy(); }
            myChart = new Chart(ctx, {
                type: 'radar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        label: 'スコア', 
                        data: dataPoints, 
                        backgroundColor: 'rgba(99, 102, 241, 0.2)', 
                        borderColor: 'rgba(99, 102, 241, 1)', 
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)', 
                        borderWidth: 2 
                    }] 
                },
                options: { 
                    scales: { 
                        r: { 
                            min: 0, 
                            max: maxScore, 
                            ticks: { stepSize: maxScore/5, display: false } 
                        } 
                    }, 
                    plugins: { legend: { display: false } } 
                }
            });
        }

        initializePortal();
    </script>
</body>
</html>