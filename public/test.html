<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: #f0fdfa; color: #1e293b; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.6); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .btn-hover { transition: transform 0.2s; }
        .btn-hover:active { transform: scale(0.96); }
        #detail-modal { display: none; transition: opacity 0.3s; }
        #detail-modal.show { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .pulse-bg { animation: pulseBg 3s infinite alternate; }
        @keyframes pulseBg { 0% { background-color: #f8fafc; } 100% { background-color: #f1f5f9; } }
    </style>
</head>
<body class="safe-area-inset-top pb-24 relative">

    <header class="bg-white px-6 py-8 rounded-b-[2rem] shadow-sm mb-6 text-center">
        <p class="text-[10px] font-black text-sky-500 tracking-[0.3em] mb-2 uppercase">Hokkaido University</p>
        <h1 class="text-2xl font-black text-slate-800 tracking-tight mb-2">åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ <span class="text-xl">ğŸ’¡</span></h1>
        <p class="text-xs text-slate-500 font-bold mt-3 bg-slate-100 inline-block px-3 py-1 rounded-full">ã€Œå¿ƒã€ã‚’ç§‘å­¦ã™ã‚‹å­¦ç”Ÿã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</p>
    </header>

    <main class="px-5 space-y-8">

        <section class="pulse-bg border-2 border-slate-200 rounded-[2rem] p-5 text-center relative overflow-hidden shadow-inner">
            <div class="absolute -top-4 -right-4 text-6xl opacity-10">ğŸ“Š</div>
            <h2 class="text-xs font-black text-slate-500 tracking-widest mb-3">RESEARCH DATA</h2>
            <div class="flex justify-center items-end space-x-1 mb-4">
                <span class="text-sm font-bold text-slate-600 pb-1">ç¾åœ¨ã€åŒ—å¤§ç”Ÿ</span>
                <span id="stat-total" class="text-4xl font-black text-sky-600 tracking-tighter">--</span>
                <span class="text-sm font-bold text-slate-600 pb-1">äººãŒè¨ºæ–­æ¸ˆï¼</span>
            </div>
            
            <p class="text-[10px] font-bold text-slate-400 mb-2">ğŸ‘‘ ä¸€ç•ªå¤šã„ã‚¿ã‚¤ãƒ—ã¯...</p>
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">ğŸ”¥ ã‚„ã‚‹æ°—</p>
                    <p id="stat-top-motivation" class="text-[11px] font-black text-orange-500 break-words">é›†è¨ˆä¸­...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">â° æ™‚é–“å¸¯</p>
                    <p id="stat-top-chrono" class="text-[11px] font-black text-emerald-500 break-words">é›†è¨ˆä¸­...</p>
                </div>
                <div class="bg-white rounded-xl py-3 px-1 shadow-sm border border-slate-100">
                    <p class="text-[9px] font-bold text-slate-400 mb-1">â˜• ã‚³ãƒ¼ãƒ’ãƒ¼</p>
                    <p id="stat-top-coffee" class="text-[11px] font-black text-amber-600 break-words">é›†è¨ˆä¸­...</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-indigo-500">å¿ƒç†ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹</h2>
            <div class="grid grid-cols-2 gap-3">
                <a href="motivation.html" class="btn-hover block bg-gradient-to-br from-orange-400 to-rose-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ— ğŸ”¥</h3>
                    <p class="text-[9px] font-bold text-white/80">ãƒ¢ãƒãƒ™ã®æºæ³‰ã‚’ç‰¹å®š</p>
                </a>
                <a href="bigfive.html" class="btn-hover block bg-gradient-to-br from-indigo-500 to-cyan-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">Big Fiveè¨ºæ–­ ğŸ§ </h3>
                    <p class="text-[9px] font-bold text-white/80">ä¸–ç•ŒåŸºæº–ã®æ€§æ ¼åˆ†æ</p>
                </a>
                <a href="chronotype.html" class="btn-hover block bg-gradient-to-br from-emerald-400 to-teal-500 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ— â°</h3>
                    <p class="text-[9px] font-bold text-white/80">æœ€å¼·ã®ã€Œæ™‚é–“å¸¯ã€ãŒåˆ¤æ˜</p>
                </a>
                <a href="coffee.html" class="btn-hover block bg-gradient-to-br from-amber-500 to-orange-400 rounded-2xl p-4 text-white shadow-md">
                    <h3 class="text-sm font-black mb-1">ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ â˜•</h3>
                    <p class="text-[9px] font-bold text-white/80">1å•ã§ã‚ã‹ã‚‹æ·±å±¤å¿ƒç†</p>
                </a>
            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-sky-400">ã‚ãªãŸã®åˆ†æãƒ‡ãƒ¼ã‚¿</h2>
            <div class="space-y-3">
                
                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
                        <span id="date-motivation" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-motivation" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-motivation" onclick="openModal('motivation')" class="hidden w-full bg-orange-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">Big Five æ€§æ ¼ãƒ†ã‚¹ãƒˆ</span>
                        <span id="date-bigfive" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-bigfive" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-bigfive" onclick="openModal('bigfive')" class="hidden w-full bg-indigo-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ—è¨ºæ–­</span>
                        <span id="date-chrono" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-chrono" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-chrono" onclick="openModal('chronotype')" class="hidden w-full bg-emerald-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

                <div class="glass-card rounded-[2rem] p-5">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-[10px] font-black text-slate-400 tracking-widest bg-slate-100 px-2 py-1 rounded">ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ãƒ†ã‚¹ãƒˆ</span>
                        <span id="date-coffee" class="text-[10px] font-bold text-slate-400">æœªè¨ºæ–­</span>
                    </div>
                    <p id="result-coffee" class="text-base font-black text-slate-400 mb-3">ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã¿ã‚ˆã†ï¼</p>
                    <button id="btn-coffee" onclick="openModal('coffee')" class="hidden w-full bg-amber-500 text-white text-xs font-bold py-2.5 rounded-xl shadow-sm btn-hover">è©³ç´°ã‚’è¦‹ã‚‹</button>
                </div>

            </div>
        </section>

        <section>
            <h2 class="text-sm font-black text-slate-700 pl-2 mb-3 border-l-4 border-teal-400">ã‚¼ãƒŸç”Ÿã®æ´»å‹•ãƒ»ã‚³ãƒ©ãƒ </h2>
            <div class="space-y-3">
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-teal-50 rounded-xl text-2xl mr-4">ğŸ“–</div>
                    <div><h3 class="text-sm font-black text-slate-800">AIå…ˆè¼©ã®3åˆ†å¿ƒç†å­¦ã‚³ãƒ©ãƒ </h3><p class="text-[10px] font-bold text-slate-500 mt-1">ã€Œã‚¨ãƒªãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã€ã®è½ã¨ã—ç©´ã¨ã¯ï¼Ÿ</p></div>
                </a>
                <a href="#" class="btn-hover flex items-center bg-white rounded-2xl p-3 shadow-sm border border-slate-100">
                    <div class="w-12 h-12 flex justify-center items-center bg-amber-50 rounded-xl text-2xl mr-4">ğŸ“¸</div>
                    <div><h3 class="text-sm font-black text-slate-800">ã‚¼ãƒŸæ´»å‹•æ—¥èªŒ & ãƒ¡ãƒ³ãƒãƒ¼ç´¹ä»‹</h3><p class="text-[10px] font-bold text-slate-500 mt-1">å€‹æ€§è±Šã‹ãªå…ˆè¼©ãŸã¡ã‚’å¤§å…¬é–‹ï¼</p></div>
                </a>
            </div>
        </section>

        <section class="btn-hover">
            <a href="#" class="block bg-gradient-to-r from-amber-400 to-orange-500 rounded-[2rem] p-6 text-center shadow-lg relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 text-6xl opacity-20">â˜•</div>
                <h2 class="text-white font-black text-sm mb-2 drop-shadow-md">ï¼¼ æ–°å…¥ç”Ÿæ­“è¿ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ï¼ ï¼</h2>
                <p class="text-white/90 text-xs font-bold mb-4 drop-shadow-sm">å¿ƒç†å­¦ã«èˆˆå‘³ãŒã‚ã‚‹äººã€å¤§æ­“è¿ï¼<br>ã¾ãšã¯ã‚ªãƒ³ãƒ©ã‚¤ãƒ³èª¬æ˜ä¼šã¸éŠã³ã«æ¥ã¦ã­âœ¨</p>
                <span class="inline-block bg-white text-orange-500 text-xs font-black px-8 py-3 rounded-full shadow-md">è©³ç´°ãƒ»å‚åŠ ç”³è¾¼ã¯ã“ã¡ã‚‰ï¼ ğŸ‘‰</span>
            </a>
        </section>

    </main>

    <div id="detail-modal" class="fixed inset-0 bg-slate-900/60 z-50 justify-center items-end pb-0 sm:items-center sm:p-5 hidden">
        <div class="bg-white w-full sm:w-96 rounded-t-[2rem] sm:rounded-[2rem] p-6 max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-title" class="text-lg font-black text-slate-800">è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ ğŸ“‘</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 font-bold text-xl bg-slate-100 rounded-full w-8 h-8 flex justify-center items-center">Ã—</button>
            </div>
            
            <div id="chart-container" class="w-full aspect-square mb-6 bg-slate-50 rounded-2xl p-2">
                <canvas id="radarChart"></canvas>
            </div>
            
            <div class="bg-indigo-50 p-4 rounded-xl mb-4">
                <h4 class="text-xs font-black text-indigo-600 mb-2">ğŸ¤– AIå…ˆè¼©ã®åˆ†æ</h4>
                <p id="modal-text" class="text-xs text-slate-700 font-bold leading-relaxed whitespace-pre-wrap"></p>
            </div>
            <button onclick="closeModal()" class="w-full bg-slate-200 text-slate-700 text-sm font-black py-3 rounded-xl mt-2 active:bg-slate-300">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
let myChart = null;
    let userData = null;

    // ğŸ“– 30é …ç›®ã®ãƒ•ã‚¡ã‚»ãƒƒãƒˆï¼ˆå°é …ç›®ï¼‰è¾æ›¸
    const FACET_DICT = {
        'E': {
            title: "å¤–å‘æ€§ã®å†…è¨³", color: "bg-orange-400",
            facets: {
                1: { name: "å‹å¥½æ€§", desc: "å‘¨å›²ã®äººã¸è¦ªã—ã¿ã‚’æ„Ÿã˜ã€æ¸©ã‹ãæ¥ã™ã‚‹å‚¾å‘" },
                2: { name: "ç¤¾äº¤æ€§", desc: "äººã¨ä¸€ç·’ã«ã„ã‚‹ã“ã¨ã‚’å¥½ã¿ã€é›†å›£ã‚’æ±‚ã‚ã‚‹å‚¾å‘" },
                3: { name: "è‡ªå·±ä¸»å¼µ", desc: "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’å–ã‚Šã€è‡ªåˆ†ã®æ„è¦‹ã‚’ä¸»å¼µã™ã‚‹åŠ›" },
                4: { name: "æ´»å‹•æ°´æº–", desc: "ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã§ã€å¸¸ã«å¿™ã—ãæ´»å‹•çš„ã«å‹•ããƒšãƒ¼ã‚¹" },
                5: { name: "åˆºæ¿€å¸Œæ±‚", desc: "ã‚¹ãƒªãƒ«ã‚„èˆˆå¥®ã€éæ—¥å¸¸çš„ãªå¼·ã„åˆºæ¿€ã‚’æ±‚ã‚ã‚‹å‚¾å‘" },
                6: { name: "æ˜æœ—æ€§", desc: "ãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ„Ÿæƒ…ï¼ˆå–œã³ãƒ»æ¥½ã—ã•ï¼‰ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘" }
            }
        },
        'A': {
            title: "å”èª¿æ€§ã®å†…è¨³", color: "bg-green-400",
            facets: {
                1: { name: "ä¿¡é ¼", desc: "ä»–äººã®æ„å›³ãŒå–„æ„ã«åŸºã¥ã„ã¦ã„ã‚‹ã¨ä¿¡ã˜ã‚‹å‚¾å‘" },
                2: { name: "èª å®Ÿã•", desc: "é§†ã‘å¼•ãã‚’ã›ãšã€ç‡ç›´ã§éš ã—äº‹ãŒãªã„å‚¾å‘" },
                3: { name: "åˆ©ä»–ä¸»ç¾©", desc: "ä»–äººã®å¹¸ç¦ã‚’é¡˜ã„ã€é€²ã‚“ã§æ´åŠ©ã—ã‚ˆã†ã¨ã™ã‚‹å‚¾å‘" },
                4: { name: "é †å¿œæ€§", desc: "å¯¾ç«‹ã‚’é¿ã‘ã€ä»–äººã«è­²æ­©ã—ã¦è¨±ã™å‚¾å‘" },
                5: { name: "è¬™è™šã•", desc: "è‡ªæ…¢ã‚’ã›ãšã€è‡ªåˆ†ã‚’æ§ãˆã‚ã«è¡¨ç¾ã™ã‚‹å‚¾å‘" },
                6: { name: "å„ªã—ã„å¿ƒ", desc: "ä»–äººã®æ‚²ã—ã¿ã‚„è‹¦ã—ã¿ã«å…±æ„Ÿã—ã€åŒæƒ…ã™ã‚‹å‚¾å‘" }
            }
        },
        'C': {
            title: "èª å®Ÿæ€§ã®å†…è¨³", color: "bg-blue-400",
            facets: {
                1: { name: "è‡ªå·±åŠ¹åŠ›æ„Ÿ", desc: "è‡ªåˆ†ã«ã¯ç‰©äº‹ã‚’æˆã—é‚ã’ã‚‹èƒ½åŠ›ãŒã‚ã‚‹ã¨ä¿¡ã˜ã‚‹å‚¾å‘" },
                2: { name: "ç§©åºæ€§", desc: "æ•´ç†æ•´é “ã‚’å¥½ã¿ã€è¨ˆç”»çš„ã«ç‰©äº‹ã‚’é€²ã‚ã‚‹å‚¾å‘" },
                3: { name: "ç¾©å‹™æ„Ÿ", desc: "ãƒ«ãƒ¼ãƒ«ã‚„é“å¾³çš„ãªç¾©å‹™ã‚’å³æ ¼ã«å®ˆã‚ã†ã¨ã™ã‚‹å‚¾å‘" },
                4: { name: "é”æˆåŠªåŠ›", desc: "é«˜ã„ç›®æ¨™ã‚’è¨­å®šã—ã€ãã‚Œã«å‘ã‹ã£ã¦åŠªåŠ›ã™ã‚‹å‚¾å‘" },
                5: { name: "è‡ªå·±é›éŒ¬", desc: "å›°é›£ã‚„é€€å±ˆãªã‚¿ã‚¹ã‚¯ã§ã‚‚ã€æŠ•ã’å‡ºã•ãšã«ã‚„ã‚Šé‚ã’ã‚‹åŠ›" },
                6: { name: "æ…é‡ã•", desc: "è¡Œå‹•ã™ã‚‹å‰ã«çµæœã‚’äºˆæ¸¬ã—ã€æ·±ãè€ƒãˆã¦ã‹ã‚‰å‹•ãå‚¾å‘" }
            }
        },
        'N': {
            title: "æ•æ„Ÿã•ï¼ˆç¥çµŒç—‡å‚¾å‘ï¼‰ã®å†…è¨³", color: "bg-purple-400",
            facets: {
                1: { name: "ä¸å®‰", desc: "å¿ƒé…äº‹ã‚„ææ€–ã€å°†æ¥ã¸ã®æ¼ ç„¶ã¨ã—ãŸä¸å®‰ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘" },
                2: { name: "æ€’ã‚Š", desc: "ã‚¤ãƒ©ã‚¤ãƒ©ã—ã‚„ã™ãã€ä»–äººã®è¡Œå‹•ã«å¯¾ã—ã¦ä¸æº€ã‚’æŠ±ãã‚„ã™ã„å‚¾å‘" },
                3: { name: "æŠ‘ã†ã¤", desc: "æ‚²ã—ã¿ã‚„å­¤ç‹¬æ„Ÿã€ç½ªæ‚ªæ„Ÿãªã©ã‚’æ„Ÿã˜ã¦è½ã¡è¾¼ã¿ã‚„ã™ã„å‚¾å‘" },
                4: { name: "è‡ªæ„è­˜", desc: "ä»–äººã®ç›®ã‚’æ°—ã«ã—ã€æ¥ãšã‹ã—ã•ã‚„æ°—ã¾ãšã•ã‚’æ„Ÿã˜ã‚„ã™ã„å‚¾å‘" },
                5: { name: "è¡å‹•æ€§", desc: "å¼·ã„æ¬²æ±‚ã‚„èª˜æƒ‘ã«æŠ—ãˆãšã€ãã®å ´ã®æ„Ÿæƒ…ã§è¡Œå‹•ã—ã¦ã—ã¾ã†å‚¾å‘" },
                6: { name: "è„†å¼±æ€§", desc: "ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ã«å¼±ãã€ãƒ‘ãƒ‹ãƒƒã‚¯ã«ãªã‚Šã‚„ã™ã„å‚¾å‘" }
            }
        },
        'O': {
            title: "é–‹æ”¾æ€§ã®å†…è¨³", color: "bg-pink-400",
            facets: {
                1: { name: "æƒ³åƒåŠ›", desc: "ç©ºæƒ³ã‚’å¥½ã¿ã€è±Šã‹ã§å‰µé€ çš„ãªå†…é¢ä¸–ç•Œã‚’æŒã£ã¦ã„ã‚‹å‚¾å‘" },
                2: { name: "èŠ¸è¡“çš„é–¢å¿ƒ", desc: "éŸ³æ¥½ãƒ»ç¾è¡“ãƒ»è‡ªç„¶ãªã©ã®ç¾ã—ã•ã«æ·±ãæ„Ÿå‹•ã™ã‚‹å‚¾å‘" },
                3: { name: "æ„Ÿæƒ…æ€§", desc: "è‡ªåˆ†ã®æ„Ÿæƒ…ã®å‹•ãã«æ•æ„Ÿã§ã€ãã‚Œã‚’å¤§åˆ‡ã«ã™ã‚‹å‚¾å‘" },
                4: { name: "å†’é™ºå¿ƒ", desc: "æ–°ã—ã„æ´»å‹•ã‚„å ´æ‰€ã€é£Ÿã¹ãŸã“ã¨ã®ãªã„ã‚‚ã®ã‚’å¥½ã‚€å‚¾å‘" },
                5: { name: "çŸ¥æ€§", desc: "æŠ½è±¡çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚„å“²å­¦çš„ãªè­°è«–ã€çŸ¥çš„ãªéŠã³ã‚’å¥½ã‚€å‚¾å‘" },
                6: { name: "é€²å–æ€§", desc: "ä¼çµ±ã‚„æ¨©å¨ã‚’ç–‘ã„ã€æ–°ã—ã„ä¾¡å€¤è¦³ã‚’å—ã‘å…¥ã‚Œã‚‹å‚¾å‘" }
            }
        }
    };

    async function initializePortal() {
        try {
            await liff.init({ liffId: "2009176797-S5FV668D" }); 
            fetchStatistics();

            if (!liff.isLoggedIn()) { liff.login(); return; }
            const userId = (await liff.getProfile()).userId;

            const url = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${userId}`;
            const res = await fetch(url);
            
            if (res.ok) {
                const json = await res.json();
                if (json.fields) {
                    userData = json.fields;
                    reflectData('motivation', userData.motivationResult, userData.motivationDate);
                    reflectData('bigfive', userData.bigFiveResult, userData.bigFiveDate);
                    reflectData('chrono', userData.chronoResult, userData.chronoDate);
                    reflectData('coffee', userData.coffeeResult, userData.coffeeDate);
                }
            }
        } catch (err) { console.error(err); }
    }

    function reflectData(type, resultField, dateField) {
        if(resultField) {
            document.getElementById(`result-${type}`).innerText = resultField.stringValue;
            document.getElementById(`result-${type}`).style.color = "#1e293b";
            document.getElementById(`btn-${type}`).classList.remove('hidden');
            const d = new Date(dateField.timestampValue);
            document.getElementById(`date-${type}`).innerText = d.toLocaleDateString() + " å®Ÿæ–½";
        }
    }

    async function fetchStatistics() {
        try {
            const statsUrl = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`;
            const statsRes = await fetch(statsUrl);
            if (!statsRes.ok) return;
            const statsJson = await statsRes.json();
            
            if (statsJson.documents) {
                let totalUsers = 0;
                let motiCounts = {}, chronoCounts = {}, coffeeCounts = {};

                statsJson.documents.forEach(doc => {
                    if (doc.fields) {
                        let isTested = false;
                        if (doc.fields.motivationResult) {
                            isTested = true;
                            let t = doc.fields.motivationResult.stringValue.replace('ã‚„ã‚‹æ°—ï¼š', '');
                            motiCounts[t] = (motiCounts[t] || 0) + 1;
                        }
                        if (doc.fields.chronoResult) {
                            isTested = true;
                            let t = doc.fields.chronoResult.stringValue.split('ï¼ˆ')[0];
                            chronoCounts[t] = (chronoCounts[t] || 0) + 1;
                        }
                        if (doc.fields.coffeeResult) {
                            isTested = true;
                            let t = doc.fields.coffeeResult.stringValue.split(' ')[0];
                            coffeeCounts[t] = (coffeeCounts[t] || 0) + 1;
                        }
                        if (isTested) totalUsers++;
                    }
                });

                if (totalUsers > 0) {
                    let currentCount = 0;
                    const counter = setInterval(() => {
                        currentCount++;
                        document.getElementById('stat-total').innerText = currentCount;
                        if (currentCount >= totalUsers) clearInterval(counter);
                    }, 50);

                    if (Object.keys(motiCounts).length > 0) document.getElementById('stat-top-motivation').innerText = Object.keys(motiCounts).reduce((a, b) => motiCounts[a] > motiCounts[b] ? a : b);
                    if (Object.keys(chronoCounts).length > 0) document.getElementById('stat-top-chrono').innerText = Object.keys(chronoCounts).reduce((a, b) => chronoCounts[a] > chronoCounts[b] ? a : b);
                    if (Object.keys(coffeeCounts).length > 0) document.getElementById('stat-top-coffee').innerText = Object.keys(coffeeCounts).reduce((a, b) => coffeeCounts[a] > coffeeCounts[b] ? a : b);
                } else {
                    document.getElementById('stat-total').innerText = "0";
                    document.getElementById('stat-top-motivation').innerText = "ã¾ã ";
                    document.getElementById('stat-top-chrono').innerText = "ã¾ã ";
                    document.getElementById('stat-top-coffee').innerText = "ã¾ã ";
                }
            }
        } catch (e) { console.error(e); }
    }

    function openModal(testType) {
        document.getElementById('detail-modal').style.display = 'flex';
        const chartContainer = document.getElementById('chart-container');
        const modalText = document.getElementById('modal-text');
        
        let labels = [], dataPoints = [], maxScore = 7, title = "", text = "";
        let showChart = true;
        let extraHTML = "";

        if (testType === 'bigfive' && userData.bigFiveScores) {
            const s = JSON.parse(userData.bigFiveScores.stringValue);
            const domains = s.domainScores || s;
            
            labels = ['å¤–å‘æ€§', 'å”èª¿æ€§', 'èª å®Ÿæ€§', 'æ•æ„Ÿã•', 'é–‹æ”¾æ€§'];
            dataPoints = [domains.extraversion, domains.agreeableness, domains.conscientiousness, domains.neuroticism, domains.openness];
            
            const version = userData.bigFiveVersion ? userData.bigFiveVersion.stringValue : 'short';
            maxScore = (version === 'full' || s.domainScores) ? 120 : 7;
            
            title = "Big Five åˆ†æ ğŸ§ ";
            text = "ã‚°ãƒ©ãƒ•ãŒå¤–ã«åºƒãŒã£ã¦ã„ã‚‹é …ç›®ãŒã‚ãªãŸã®å¼·ã¿ã€‚å†…å´ã«ã¸ã“ã‚“ã§ã„ã‚‹é …ç›®ã¯ã€æ„è­˜ã—ã¦ã‚«ãƒãƒ¼ã™ã¹ããƒã‚¤ãƒ³ãƒˆã§ã™ã€‚";

            if (s.facetScores) {
                extraHTML = `<div class="mt-6 border-t border-slate-200 pt-5">
                    <h5 class="text-sm font-black text-slate-800 mb-4">ğŸ”¬ 30é …ç›®ã®è©³ç´°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°</h5>
                    <div class="space-y-6">`;
                
                const domainKeys = ['E', 'A', 'C', 'N', 'O'];
                domainKeys.forEach(domainKey => {
                    const dict = FACET_DICT[domainKey];
                    const facetsData = s.facetScores[domainKey];
                    
                    if (facetsData) {
                        extraHTML += `<div class="bg-slate-50 rounded-xl p-4 shadow-sm border border-slate-100">
                            <h6 class="text-xs font-black text-slate-700 mb-3">${dict.title}</h6>
                            <div class="space-y-3">`;

                        for (let i = 1; i <= 6; i++) {
                            const score = Object.values(facetsData)[i-1] || 0;
                            const facetInfo = dict.facets[i];
                            const percent = Math.min(100, Math.round((score / 20) * 100));

                            extraHTML += `
                            <div>
                                <div class="flex justify-between items-end mb-1">
                                    <span class="text-[11px] font-bold text-slate-800">${facetInfo.name}</span>
                                    <span class="text-[10px] font-black text-slate-400">${score}/20</span>
                                </div>
                                <div class="h-1.5 bg-slate-200 rounded-full overflow-hidden mb-1">
                                    <div class="h-full ${dict.color} rounded-full" style="width: ${percent}%"></div>
                                </div>
                                <p class="text-[9px] text-slate-500 leading-tight">${facetInfo.desc}</p>
                            </div>`;
                        }
                        // â˜…ä¿®æ­£ï¼šã“ã“ã®é–‰ã˜ã‚¿ã‚°ã®æ•°ã‚’æ•´ç†
                        extraHTML += `</div></div>`;
                    }
                });
                // â˜…ä¿®æ­£ï¼šæœ€å¾Œã®é–‰ã˜ã‚¿ã‚°
                extraHTML += `</div></div>`;
            }
        } 
        else if (testType === 'motivation' && userData.motivationScores) {
            const s = JSON.parse(userData.motivationScores.stringValue);
            labels = ['æˆé•·æ€è€ƒ', 'è³è³›æ¬²æ±‚', 'è‡ªä¿¡']; dataPoints = [s.mindset, s.focus, s.confidence]; maxScore = 2;
            title = "ã‚„ã‚‹æ°—ï¼˜ã‚¿ã‚¤ãƒ— åˆ†æ ğŸ”¥";
            text = "è‡ªåˆ†ãŒã©ã‚“ãªæ™‚ã«é ‘å¼µã‚Œã‚‹ã‹ã‚’çŸ¥ã‚‹ã“ã¨ã§ã€å¤§å­¦ç”Ÿæ´»ã®ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è‡ªåœ¨ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ï¼";
        }
        else if (testType === 'chronotype') {
            showChart = false;
            title = "ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ— åˆ†æ â°";
            const typeStr = userData.chronoResult.stringValue;
            if(typeStr.includes('ãƒ©ã‚¤ã‚ªãƒ³')) text = "ã€ãƒ©ã‚¤ã‚ªãƒ³å‹ï¼ˆæœå‹ï¼‰ã€‘\nåˆå‰ä¸­ã«æœ€ã‚‚é›†ä¸­åŠ›ãŒãƒ”ãƒ¼ã‚¯ã«é”ã™ã‚‹ç”Ÿç²‹ã®æœå‹ã§ã™ã€‚å¤§äº‹ãªã‚¿ã‚¹ã‚¯ã‚„å‹‰å¼·ã¯æœä¸€ç•ªã«ç‰‡ä»˜ã‘ã‚‹ã®ãŒå¤§æ­£è§£ï¼å¤œã¯æ½”ãä¼‘ã‚€ã®ãŒå‰ã§ã™ã€‚";
            else if(typeStr.includes('ã‚¯ãƒ')) text = "ã€ã‚¯ãƒå‹ï¼ˆæ˜¼å‹ï¼‰ã€‘\nãŠæ˜¼å‰ã€œåˆå¾Œã«ã‹ã‘ã¦èƒ½åŠ›ãŒå…¨é–‹ã«ãªã‚‹ã€å¤ªé™½ã®å‹•ãã«åˆã‚ã›ãŸã‚¿ã‚¤ãƒ—ã€‚æ˜¼éãã®çœ æ°—ã‚’è»½ã„æ•£æ­©ã§é£›ã°ã›ã°ã€ã‚¼ãƒŸã®æ´»å‹•ã§ã‚‚ä¸€ç•ªæ´»èºã§ãã¾ã™ï¼";
            else if(typeStr.includes('ã‚ªã‚ªã‚«ãƒŸ')) text = "ã€ã‚ªã‚ªã‚«ãƒŸå‹ï¼ˆå¤œå‹ï¼‰ã€‘\nå¤•æ–¹ã‹ã‚‰å¤œã«ã‹ã‘ã¦é›†ä¸­åŠ›ãŒé«˜ã¾ã‚‹å¤œå‹ã€‚åˆå‰ä¸­ã¯ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–ãªç™ºæƒ³ãŒå‡ºã‚„ã™ã„ã®ã§ã€ã‚¢ã‚¤ãƒ‡ã‚¢å‡ºã—ã«ä½¿ã„ã€ã‚¬ãƒƒãƒ„ãƒªä½œæ¥­ã¯å¤œã«å›ã—ã¾ã—ã‚‡ã†ï¼";
            else if(typeStr.includes('ã‚¤ãƒ«ã‚«')) text = "ã€ã‚¤ãƒ«ã‚«å‹ï¼ˆä¸è¦å‰‡å‹ï¼‰ã€‘\nå°‘ã—ç¥çµŒè³ªã§ç¡çœ ãŒæµ…ããªã‚Šã‚„ã™ã„ã‚¿ã‚¤ãƒ—ã€‚å¤œã«ã‚¹ãƒãƒ›ã‚’è¦‹ã™ããšã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã™ã‚‹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’ä½œã‚‹ã¨å¤§å­¦ç”Ÿæ´»ã®è³ªãŒåŠ‡çš„ã«ä¸ŠãŒã‚Šã¾ã™ï¼";
        }
        else if (testType === 'coffee') {
            showChart = false;
            title = "ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼ åˆ†æ â˜•";
            const typeStr = userData.coffeeResult.stringValue;
            if(typeStr.includes('ãƒ–ãƒ©ãƒƒã‚¯')) text = "ã€ãƒ–ãƒ©ãƒƒã‚¯ã‚³ãƒ¼ãƒ’ãƒ¼ã€‘\nç´”ç²‹ãªã‚‚ã®ã‚’å¥½ã‚€ä¿å®ˆçš„ãªã‚¿ã‚¤ãƒ—ã§ã™ï¼ç„¡é§„ã‚’å«Œã„ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆãªç‰©è¨€ã„ã‚’å¥½ã‚€ã®ã§ã€ã‚¼ãƒŸã®é€²è¡Œå½¹ã‚„ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãªã©ã€å ´ã‚’ä»•åˆ‡ã‚‹å½¹å‰²ã«å‘ã„ã¦ã„ã¾ã™ã€‚";
            else if(typeStr.includes('ã‚«ãƒ•ã‚§ãƒ©ãƒ†')) text = "ã€ã‚«ãƒ•ã‚§ãƒ©ãƒ†ã€‘\näººç”Ÿã®è‹¦ã—ã¿ã‚’å’Œã‚‰ã’ã‚ˆã†ã¨ã™ã‚‹å¿«æ¥½ä¸»ç¾©è€…ã‚¿ã‚¤ãƒ—ã§ã™ï¼å‘¨å›²ã‚’å’Œã¾ã›ã‚‹ãŸã‚ã€ã‚¼ãƒŸã®äººé–“é–¢ä¿‚ã®æ½¤æ»‘æ²¹ã«ãªã‚‹ç´ æ™´ã‚‰ã—ã„æ‰èƒ½ã‚’æŒã£ã¦ã„ã¾ã™ã€‚";
            else if(typeStr.includes('ãƒ•ãƒ­ãƒ¼ã‚ºãƒ³')) text = "ã€ãƒ•ãƒ­ãƒ¼ã‚ºãƒ³ã€‘\næµè¡Œã«æ•æ„Ÿã§ã€è‡ªç™ºçš„ãªãƒˆãƒ¬ãƒ³ãƒ‰ã‚»ãƒƒã‚¿ãƒ¼ã§ã™ï¼ã‚¼ãƒŸã®ã‚¤ãƒ™ãƒ³ãƒˆä¼ç”»ã‚„ã€SNSé‹ç”¨ãªã©ã€æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã™å ´é¢ã§æœ€ã‚‚è¼ãã¾ã™ã€‚";
            else if(typeStr.includes('ç‰¹æ®Š')) text = "ã€ç‰¹æ®Šã‚ªãƒ¼ãƒ€ãƒ¼ã€‘\nè‡ªåˆ†ã®ä½“èª¿ã‚„çŠ¶æ³ã«æ•æ„Ÿãªã€ã“ã ã‚ã‚Šã®å¼·ã„å®Œç’§ä¸»ç¾©ã‚¿ã‚¤ãƒ—ã§ã™ï¼ã‚¼ãƒŸã®ç ”ç©¶ã‚„è«–æ–‡åŸ·ç­†ãªã©ã€ç´°éƒ¨ã¾ã§å¾¹åº•çš„ã«ã“ã ã‚ã‚‹ä½œæ¥­ãŒå¾—æ„ã§ã™ã€‚";
            else if(typeStr.includes('ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆ')) text = "ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ãƒˆã€‘\nä¼çµ±çš„ãªæ–¹æ³•ã«ã“ã ã‚ã‚‹ã€ãƒã‚¤ãƒšãƒ¼ã‚¹ã§ã®ã‚“ã³ã‚Šå±‹ãªã‚¿ã‚¤ãƒ—ã§ã™ï¼ç„¦ã‚‰ãšè‡ªåˆ†ã®ãƒšãƒ¼ã‚¹ã§é€²ã‚ã‚‰ã‚Œã‚‹å½¹å‰²ã‚’è¦‹ã¤ã‘ã‚‹ã¨ã€ç¢ºå®Ÿã«æˆæœã‚’å‡ºã—ã¾ã™ã€‚";
        }

        document.getElementById('modal-title').innerText = title;
        // â˜…ä¿®æ­£ï¼š\n ã‚’ <br> ã«å¤‰æ›ã—ã¦ã€HTMLä¸Šã§ã‚‚ã¡ã‚ƒã‚“ã¨æ”¹è¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼
        modalText.innerHTML = text.replace(/\n/g, '<br>') + extraHTML;

        if (showChart) {
            chartContainer.style.display = 'block';
            drawChart(labels, dataPoints, maxScore);
        } else {
            chartContainer.style.display = 'none';
        }
    }

    function closeModal() { document.getElementById('detail-modal').style.display = 'none'; }

    function drawChart(labels, dataPoints, maxScore) {
        const ctx = document.getElementById('radarChart').getContext('2d');
        if(myChart) { myChart.destroy(); }
        myChart = new Chart(ctx, {
            type: 'radar',
            data: { labels: labels, datasets: [{ label: 'ã‚¹ã‚³ã‚¢', data: dataPoints, backgroundColor: 'rgba(99, 102, 241, 0.2)', borderColor: 'rgba(99, 102, 241, 1)', pointBackgroundColor: 'rgba(99, 102, 241, 1)', borderWidth: 2 }] },
            options: { scales: { r: { min: 0, max: maxScore, ticks: { stepSize: maxScore/5, display: false } } }, plugins: { legend: { display: false } } }
        });
    }

    initializePortal();
        
    </script>
</body>
</html>