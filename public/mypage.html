<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Zen+Kaku+Gothic+New:wght@700;900&family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        /* ğŸŒŸ èƒŒæ™¯ã‚’è¶…æ˜ã‚‹ãã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ãªå‹•ãã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ï¼ */
        body { 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background: linear-gradient(-45deg, #4158D0, #C850C0, #FFCC70, #4facfe);
            background-size: 300% 300%;
            animation: gradientBG 12s ease infinite;
            color: white; 
            min-height: 100vh; 
            padding-bottom: 5rem; 
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* æš—ã„ã‚°ãƒ¬ãƒ¼ã‚’ã‚„ã‚ã¦ã€æ˜ã‚‹ã„ã™ã‚Šã‚¬ãƒ©ã‚¹é¢¨ã« */
        .glass-card { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* å½¹è·ã”ã¨ã®ç‰¹åˆ¥ãªè£…é£¾ï¼ˆèƒŒæ™¯ã«åˆã‚ã›ã¦å¾®èª¿æ•´ï¼‰ */
        .card-gold { background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%); border: 1px solid #fde68a; box-shadow: 0 10px 30px -10px rgba(217, 119, 6, 0.8); }
        .card-silver { background: linear-gradient(135deg, #64748b 0%, #334155 100%); border: 1px solid #cbd5e1; }
        .card-special { background: linear-gradient(135deg, #8b5cf6 0%, #4f46e5 100%); border: 1px solid #d8b4fe; box-shadow: 0 10px 30px -10px rgba(79, 70, 229, 0.6); }
        .card-normal { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; }
        
        /* ãƒã‚ªãƒ³ã®è„ˆæ‰“ã¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(217,70,239,0.5); }
            50% { box-shadow: 0 0 40px rgba(217,70,239,0.9), 0 0 10px rgba(56,189,248,0.8); }
        }
        .neon-border { animation: neonPulse 2.5s infinite; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="safe-area-inset-top p-5">

    <div class="text-center mb-6 fade-in pt-2 mx-2">
        <div class="relative p-[3px] rounded-3xl bg-gradient-to-r from-cyan-400 via-fuchsia-500 to-orange-400 neon-border">
            
            <div class="bg-white/95 backdrop-blur-xl rounded-[1.7rem] py-5 px-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1/3 bg-gradient-to-b from-white/80 to-transparent"></div>

                <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 via-indigo-600 to-fuchsia-600 tracking-[0.1em] mb-2 drop-shadow-sm relative z-10" style="font-family: 'Zen Kaku Gothic New', sans-serif;">
                    åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ
                </h1>
                <p class="text-[10px] font-black text-indigo-600 tracking-[0.2em] mb-1 relative z-10">
                    å­¦å•ã®å®Ÿè·µ
                </p>
                <p class="text-[8px] text-fuchsia-600 font-bold tracking-[0.1em] relative z-10">
                    ã€œçŸ¥è­˜ã‚’è¡Œå‹•ã«å¤‰ãˆæœªæ¥ã‚’ç™ºæ˜ã™ã‚‹ã€œ
                </p>
            </div>
        </div>
    </div>

    <header id="id-card" class="card-normal rounded-3xl p-6 mb-6 fade-in relative overflow-hidden transition-all duration-500">
        <div class="absolute top-[-50%] right-[-20%] w-[200px] h-[200px] bg-white/20 rounded-full filter blur-[20px]"></div>
        
        <button onclick="openEditModal()" class="absolute top-4 right-4 bg-white/30 hover:bg-white/50 text-white text-[10px] font-bold px-3 py-1.5 rounded-full backdrop-blur-md transition z-20 flex items-center gap-1 border border-white/40 shadow-sm">
            <span>âœï¸</span> ç·¨é›†
        </button>
        
        <div class="relative z-10 pr-16"> 
            <div class="flex items-center gap-4 mb-4">
                <img id="user-icon" src="https://via.placeholder.com/150" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full border-2 border-white/80 shadow-lg object-cover flex-shrink-0">
                <div>
                    <p id="user-univ" class="text-[9px] font-bold text-white/90 mb-0.5 drop-shadow-sm">å¤§å­¦ãƒ»å­¦éƒ¨ã‚’è¨­å®šã—ã‚ˆã†</p>
                    <h1 id="user-name" class="text-xl sm:text-2xl font-black text-white tracking-tight drop-shadow-md leading-tight">ã‚²ã‚¹ãƒˆ ã•ã‚“</h1>
                    <div id="user-role-badges" class="flex flex-wrap gap-1 mt-1.5 hidden"></div>
                </div>
            </div>
            
            <div class="bg-white/20 rounded-xl p-3 border border-white/30 flex items-start gap-2 relative group cursor-pointer active:scale-95 transition shadow-inner" onclick="editHitokoto()">
                <span class="text-sm">ğŸ’¬</span>
                <div class="flex-1">
                    <p class="text-[9px] text-white/80 font-bold mb-0.5">ä»Šã®ã²ã¨ã“ã¨ (ã‚¿ãƒƒãƒ—ã§ç·¨é›†)</p>
                    <p id="user-intro" class="text-xs text-white font-bold leading-relaxed drop-shadow-sm">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã²ã¨ã“ã¨ã‚’è¨­å®šï¼</p>
                </div>
                <span class="text-white/50 text-xs">âœï¸</span>
            </div>
        </div>
    </header>

    <main class="space-y-4">
        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.1s;">
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-sm font-black text-white drop-shadow-sm tracking-widest flex items-center gap-2">
                    <span>ğŸ“š</span> ã‚ãŸã—ã®ãƒˆãƒªã‚»ãƒ„
                </h2>
            </div>
            <p id="tags-hint" class="text-[9px] text-indigo-100 font-bold mb-3 hidden">ğŸ‘‡ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨åŒã˜ã‚¿ã‚¤ãƒ—ã®ã‚¼ãƒŸç”Ÿã‚’æ¢ã›ã¾ã™ï¼</p>
            <div id="tags-container" class="flex flex-wrap gap-2">
                <p class="text-xs text-white/70 font-bold">ã¾ã ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰è¨ºæ–­ã—ã‚ˆã†ï¼</p>
            </div>
        </section>

        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-sm font-black text-white drop-shadow-sm mb-4 tracking-widest flex items-center gap-2">
                <span>ğŸ‘¥</span> ã‚¼ãƒŸå†…ã®ã¤ãªãŒã‚Š
            </h2>
            
            <div class="mb-4">
                <p class="text-[10px] text-white font-bold mb-2 drop-shadow-sm">âœ¨ ã‚ãªãŸã¨ä¼¼ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ (ã‚·ãƒ³ã‚¯ãƒ­ç‡)</p>
                <div id="sync-users-container" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                    <p class="text-xs text-white/70 font-bold w-full text-center py-4">ãƒ‡ãƒ¼ã‚¿åé›†ä¸­... ğŸ”„</p>
                </div>
            </div>

            <div class="bg-white/20 rounded-xl p-4 border border-white/30 shadow-inner">
                <p class="text-[10px] text-white font-black mb-1">ğŸ‘‘ ã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚¢åº¦</p>
                <p id="rare-text" class="text-xs text-white/90 font-bold leading-relaxed">è¨ˆç®—ä¸­... ğŸ”„</p>
            </div>
        </section>
    </main>

    <div id="same-type-modal" class="fixed inset-0 z-[55] hidden flex-col justify-end">
        <div class="bg-indigo-950 rounded-t-[2rem] p-6 shadow-2xl border-t border-indigo-500/50 max-h-[75vh] flex flex-col w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeSameTypeModal()" class="absolute top-5 right-5 w-8 h-8 bg-indigo-900 rounded-full text-indigo-300 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 id="same-type-title" class="text-lg font-black text-white mb-1">ğŸ» ã‚¯ãƒå‹ã®ãƒ¡ãƒ³ãƒãƒ¼</h3>
            <p id="same-type-count" class="text-xs text-pink-300 font-bold mb-4">ã‚ãªãŸä»¥å¤–ã« ã€‡ äººã„ã¾ã™</p>
            
            <div id="same-type-list" class="space-y-2 overflow-y-auto pr-2 no-scrollbar pb-10"></div>
        </div>
    </div>

    <div id="other-profile-modal" class="fixed inset-0 z-[60] hidden flex-col justify-end">
        <div class="bg-indigo-950 rounded-t-[2.5rem] p-6 shadow-2xl border-t border-indigo-500/50 max-h-[85vh] w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeOtherProfile()" class="absolute top-5 right-5 w-8 h-8 bg-indigo-900 rounded-full text-indigo-300 text-lg font-bold flex items-center justify-center">&times;</button>
            
            <div class="flex flex-col items-center mt-2 mb-6">
                <img id="other-icon" src="" class="w-24 h-24 rounded-full border-4 border-indigo-500/50 mb-3 object-cover shadow-lg">
                <div id="other-role-badges" class="flex flex-wrap justify-center gap-1 mb-2"></div>
                <h3 id="other-name" class="text-xl font-black text-white mb-1"></h3>
                <p id="other-univ" class="text-[10px] text-indigo-200 font-bold"></p>
            </div>
            
            <div class="bg-indigo-900/50 rounded-xl p-4 mb-4 border border-indigo-500/30">
                <p class="text-[10px] text-indigo-300 font-bold mb-1">ğŸ’¬ ä»Šã®ã²ã¨ã“ã¨</p>
                <p id="other-intro" class="text-sm text-white font-bold"></p>
            </div>

            <div class="bg-indigo-900/50 rounded-xl p-4 border border-indigo-500/30">
                <p class="text-[10px] text-indigo-300 font-bold mb-2">ğŸ·ï¸ èˆˆå‘³ã‚¿ã‚°</p>
                <div id="other-tags" class="flex flex-wrap gap-1.5"></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex-col justify-end">
        <div class="bg-indigo-950 rounded-t-[2rem] p-6 shadow-2xl border-t border-indigo-500/50 max-h-[90vh] overflow-y-auto w-full max-w-md mx-auto relative animate-[translateY_0.3s_ease-out]">
            <button onclick="closeEditModal()" class="absolute top-5 right-5 w-8 h-8 bg-indigo-900 rounded-full text-indigo-300 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 class="text-lg font-black text-white mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°è¨­å®š</h3>
            
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-indigo-300">åå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ æ¨å¥¨ï¼‰</label><input type="text" id="edit-name" class="w-full bg-indigo-900/50 border border-indigo-500/30 rounded-xl p-3 text-sm text-white focus:outline-none focus:border-pink-500"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-indigo-300">å¤§å­¦</label><input type="text" id="edit-uni" value="åŒ—æµ·é“å¤§å­¦" class="w-full bg-indigo-900/50 border border-indigo-500/30 rounded-xl p-3 text-sm text-white"></div>
                    <div><label class="text-[10px] font-bold text-indigo-300">å­¦å¹´</label>
                        <select id="edit-grade" class="w-full bg-indigo-900/50 border border-indigo-500/30 rounded-xl p-3 text-sm text-white">
                            <option value="å­¦éƒ¨1å¹´">å­¦éƒ¨1å¹´</option><option value="å­¦éƒ¨2å¹´">å­¦éƒ¨2å¹´</option><option value="å­¦éƒ¨3å¹´">å­¦éƒ¨3å¹´</option><option value="å­¦éƒ¨4å¹´">å­¦éƒ¨4å¹´</option><option value="ä¿®å£«1å¹´">ä¿®å£«1å¹´</option><option value="ä¿®å£«2å¹´">ä¿®å£«2å¹´</option><option value="åšå£«1å¹´">åšå£«1å¹´</option><option value="åšå£«2å¹´">åšå£«2å¹´</option><option value="åšå£«3å¹´">åšå£«3å¹´</option><option value="åšå£«4å¹´">åšå£«4å¹´</option><option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-indigo-300">å­¦éƒ¨ãƒ»å­¦ç§‘</label><input type="text" id="edit-faculty" placeholder="ä¾‹: å·¥å­¦éƒ¨ ç’°å¢ƒç¤¾ä¼šå·¥å­¦ç§‘" class="w-full bg-indigo-900/50 border border-indigo-500/30 rounded-xl p-3 text-sm text-white"></div>
                
                <div>
                    <label class="text-[10px] font-bold flex justify-between">
                        <span class="text-indigo-300">è©³ã—ã„è‡ªå·±ç´¹ä»‹æ–‡</span> <span class="text-pink-400">â€»Notionã«è¨˜éŒ²ã•ã‚Œã¾ã™</span>
                    </label>
                    <textarea id="edit-selfintro" rows="4" placeholder="ã‚¼ãƒŸã§ã‚„ã‚ŠãŸã„ã“ã¨ã€è¶£å‘³ã€ç‰¹æŠ€ãªã©è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ï¼" class="w-full bg-indigo-900/50 border border-indigo-500/30 rounded-xl p-3 text-sm text-white mt-1 focus:outline-none focus:border-pink-500"></textarea>
                </div>
            </div>
            
            <button onclick="saveProfile()" class="w-full mt-6 bg-gradient-to-r from-pink-500 to-indigo-500 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                ä¿å­˜ã—ã¦åŒæœŸã™ã‚‹ ğŸš€
            </button>
        </div>
    </div>

    <script>
        let myData = null;
        let myUserId = "";
        let allUsersData = [];

        function getSafe(field) {
            if (!field) return "";
            if (field.stringValue !== undefined) return field.stringValue;
            if (field.integerValue !== undefined) return field.integerValue;
            return "";
        }

        async function initMyPage() {
            try {
                // âš ï¸ ã“ã“ã¯æ–°ã—ã„ãƒã‚¤ãƒšãƒ¼ã‚¸ã®LIFF IDï¼
                await liff.init({ liffId: "2009176797-tgpGsUUz" }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                myUserId = profile.userId;
                document.getElementById('user-icon').src = profile.pictureUrl;
                document.getElementById('user-name').innerText = profile.displayName + " ã•ã‚“";

                const url = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${myUserId}`;
                const res = await fetch(url);
                
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields) {
                        myData = json.fields;
                        renderProfile(myData);
                        renderTags(myData);
                    }
                }
                
                fetchConnections();
                
            } catch (err) { console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err); }
        }

        function applyRoleStyle(roles) {
            const card = document.getElementById('id-card');
            const badgesContainer = document.getElementById('user-role-badges');
            
            card.className = "rounded-3xl p-6 mb-6 fade-in relative overflow-hidden transition-all duration-500";
            badgesContainer.innerHTML = "";
            
            if (!roles || roles.length === 0 || roles.includes("ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼") || roles.includes("æœªè¨­å®š")) {
                card.classList.add('card-normal');
                badgesContainer.classList.add('hidden');
                return;
            }

            badgesContainer.classList.remove('hidden');
            let highestRarity = 4; 

            roles.forEach(role => {
                let badgeClass = "";
                let badgeIcon = "";
                let rarity = 4;

                if (role === "ä»£è¡¨") {
                    rarity = 1;
                    badgeIcon = "ğŸ‘‘";
                    badgeClass = "bg-yellow-500/20 text-yellow-100 border border-yellow-300/50";
                } else if (["ç§˜æ›¸", "çµ±æ‹¬", "åºƒå ±", "è£œä½"].some(r => role.includes(r))) {
                    rarity = 2;
                    badgeIcon = "ğŸ›¡ï¸";
                    badgeClass = "bg-white/20 text-white border border-white/50";
                } else if (role.includes("éƒ¨") || role.includes("PJ") || ["ã‚¼ãƒŸ", "è¬›ç¾©"].some(r => role.includes(r))) {
                    rarity = 3;
                    badgeIcon = "âœ¨";
                    badgeClass = "bg-indigo-500/30 text-indigo-100 border border-indigo-300/50";
                } else {
                    rarity = 4;
                    badgeIcon = "ğŸ”–";
                    badgeClass = "bg-black/30 text-white/80 border border-white/30";
                }

                if (rarity < highestRarity) highestRarity = rarity;
                badgesContainer.innerHTML += `<span class="inline-block ${badgeClass} text-[10px] font-black tracking-widest px-2 py-0.5 rounded shadow-sm backdrop-blur-sm">${badgeIcon} ${role}</span>`;
            });

            if (highestRarity === 1) card.classList.add('card-gold');
            else if (highestRarity === 2) card.classList.add('card-silver');
            else if (highestRarity === 3) card.classList.add('card-special');
            else card.classList.add('card-special');
        }

        function renderProfile(data) {
            if (data.profile && data.profile.mapValue && data.profile.mapValue.fields) {
                const p = data.profile.mapValue.fields;
                const name = getSafe(p.name);
                const uni = getSafe(p.uni);
                const grade = getSafe(p.grade);
                const intro = getSafe(p.intro); 
                const selfIntro = getSafe(p.selfIntro); 
                
                let roles = [];
                if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) {
                    roles = p.roles.arrayValue.values.map(v => getSafe(v));
                } else if (p.role) {
                    roles = [getSafe(p.role)];
                }

                if (name) document.getElementById('user-name').innerText = name + " ã•ã‚“";
                if (uni || grade) document.getElementById('user-univ').innerText = `${uni} ${grade}`;
                if (intro) document.getElementById('user-intro').innerText = intro;

                applyRoleStyle(roles);

                document.getElementById('edit-name').value = name;
                document.getElementById('edit-uni').value = uni;
                document.getElementById('edit-faculty').value = getSafe(p.faculty);
                document.getElementById('edit-grade').value = grade || "å­¦éƒ¨1å¹´";
                document.getElementById('edit-selfintro').value = selfIntro;
            }
        }

        function renderTags(data) {
            const container = document.getElementById('tags-container');
            let html = "";
            if (data.motivationResult) {
                const val = getSafe(data.motivationResult).replace('ã‚„ã‚‹æ°—ï¼š', '');
                html += `<button onclick="showSameTypeUsers('${val}', 'motivation', 'ğŸ”¥ ã‚„ã‚‹æ°—ã‚¿ã‚¤ãƒ—')" class="bg-white/20 hover:bg-white/40 text-white border border-white/50 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm backdrop-blur-sm">ğŸ”¥ ${val}</button>`;
            }
            if (data.bigFiveResult) {
                const match = getSafe(data.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/);
                if (match) html += `<button onclick="showSameTypeUsers('${match[1]}', 'bigFive', 'ğŸ§  æ€§æ ¼ã‚¿ã‚¤ãƒ—')" class="bg-white/20 hover:bg-white/40 text-white border border-white/50 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm backdrop-blur-sm">ğŸ§  ${match[1]}æ´¾</button>`;
            }
            if (data.chronoResult) {
                const val = getSafe(data.chronoResult).split('ï¼ˆ')[0];
                html += `<button onclick="showSameTypeUsers('${val}', 'chrono', 'â° ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ—')" class="bg-white/20 hover:bg-white/40 text-white border border-white/50 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm backdrop-blur-sm">â° ${val}</button>`;
            }
            if (data.coffeeResult) {
                const val = getSafe(data.coffeeResult).split(' ')[0];
                html += `<button onclick="showSameTypeUsers('${val}', 'coffee', 'â˜• ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼')" class="bg-white/20 hover:bg-white/40 text-white border border-white/50 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm backdrop-blur-sm">â˜• ${val}å¥½ã</button>`;
            }
            if (data.smResult) {
                const val = getSafe(data.smResult).split('ï¼ˆ')[0];
                html += `<button onclick="showSameTypeUsers('${val}', 'sm', 'ğŸŒ¬ï¸ ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ')" class="bg-white/20 hover:bg-white/40 text-white border border-white/50 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm backdrop-blur-sm">ğŸŒ¬ï¸ ${val}</button>`;
            }

            if (html !== "") {
                container.innerHTML = html;
                document.getElementById('tags-hint').classList.remove('hidden');
            }
        }

        function showSameTypeUsers(typeValue, typeCategory, titlePrefix) {
            if (allUsersData.length === 0) {
                alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ï¼");
                return;
            }

            document.getElementById('same-type-title').innerText = `${titlePrefix} ãŒåŒã˜ä»²é–“`;
            
            const matchedUsers = [];
            
            allUsersData.forEach((doc, index) => {
                if (doc.name.includes(myUserId)) return; 

                const f = doc.fields;
                if (!f || !f.profile || !f.profile.mapValue) return;

                let isMatch = false;
                if (typeCategory === 'chrono' && getSafe(f.chronoResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'bigFive' && getSafe(f.bigFiveResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'coffee' && getSafe(f.coffeeResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'sm' && getSafe(f.smResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'motivation' && getSafe(f.motivationResult).includes(typeValue)) isMatch = true;

                if (isMatch) {
                    const p = f.profile.mapValue.fields;
                    let roles = [];
                    if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) {
                        roles = p.roles.arrayValue.values.map(v => getSafe(v));
                    } else if (p.role) { roles = [getSafe(p.role)]; }
                    
                    matchedUsers.push({
                        index: index,
                        name: getSafe(p.name) || "åŒ¿åãƒ¡ãƒ³ãƒãƒ¼",
                        icon: getSafe(p.iconUrl) || "https://via.placeholder.com/150",
                        role: (roles.length > 0 && roles[0] !== "æœªè¨­å®š") ? roles[0] : "ãƒ¡ãƒ³ãƒãƒ¼"
                    });
                }
            });

            document.getElementById('same-type-count').innerText = `ã‚ãªãŸä»¥å¤–ã« ${matchedUsers.length} äººè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼`;

            const listContainer = document.getElementById('same-type-list');
            if (matchedUsers.length > 0) {
                let html = "";
                matchedUsers.forEach(user => {
                    html += `
                    <div onclick="closeSameTypeModal(); showOtherProfile(${user.index})" class="flex items-center gap-4 bg-indigo-900/50 p-3 rounded-xl border border-indigo-500/30 cursor-pointer hover:bg-indigo-800 active:scale-95 transition shadow-sm">
                        <img src="${user.icon}" class="w-12 h-12 rounded-full object-cover border-2 border-indigo-400/50">
                        <div>
                            <p class="text-sm font-bold text-white mb-0.5">${user.name} ã•ã‚“</p>
                            <p class="text-[10px] text-pink-300 font-bold">${user.role}</p>
                        </div>
                        <span class="ml-auto text-indigo-300 text-xs">ğŸ‘‰</span>
                    </div>`;
                });
                listContainer.innerHTML = html;
            } else {
                listContainer.innerHTML = `<p class="text-sm text-indigo-300 text-center py-6">ã¾ã ã“ã®ã‚¿ã‚¤ãƒ—ã®ä»²é–“ã¯ã„ã¾ã›ã‚“ã€‚<br>æ–°å…¥ç”ŸãŒå…¥ã£ã¦ãã‚‹ã®ã‚’å¾…ã¨ã†ï¼</p>`;
            }

            document.getElementById('same-type-modal').classList.remove('hidden');
            document.getElementById('same-type-modal').classList.add('flex');
        }

        function closeSameTypeModal() {
            document.getElementById('same-type-modal').classList.add('hidden');
            document.getElementById('same-type-modal').classList.remove('flex');
        }

        function editHitokoto() {
            const current = document.getElementById('user-intro').innerText;
            const text = current === "ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã²ã¨ã“ã¨ã‚’è¨­å®šï¼" ? "" : current;
            const input = prompt("ã„ã¾ã®ã²ã¨ã“ã¨ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ç”¨ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„âœ¨\nâ€»æœ€å¤§40æ–‡å­—ç¨‹åº¦", text);
            
            if (input !== null && input.trim() !== "") {
                document.getElementById('user-intro').innerText = "æ›´æ–°ä¸­... ğŸš€";
                liff.sendMessages([{ type: "text", text: "ã²ã¨ã“ã¨ " + input }]).then(() => {
                    setTimeout(() => { window.location.reload(); }, 1500); 
                }).catch(err => alert("ã‚¨ãƒ©ãƒ¼: " + err));
            }
        }

        async function fetchConnections() {
            if (!myData) return;
            try {
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`);
                const json = await res.json();
                if (!json.documents) return;

                allUsersData = json.documents;

                const myChrono = getSafe(myData.chronoResult).split('ï¼ˆ')[0];
                const myBigFiveMatch = getSafe(myData.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/);
                const myBigFive = myBigFiveMatch ? myBigFiveMatch[1] : "";
                const myCoffee = getSafe(myData.coffeeResult).split(' ')[0];

                let chronoSameCount = 0;
                let syncRanking = [];

                json.documents.forEach((doc, index) => {
                    if (doc.name.includes(myUserId)) return;
                    const f = doc.fields;
                    if (!f || !f.profile || !f.profile.mapValue) return; 

                    const p = f.profile.mapValue.fields;
                    const otherName = getSafe(p.name);
                    const otherIcon = getSafe(p.iconUrl) || "https://via.placeholder.com/150";
                    if (!otherName) return;

                    let roles = [];
                    if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) {
                        roles = p.roles.arrayValue.values.map(v => getSafe(v));
                    } else if (p.role) { roles = [getSafe(p.role)]; }

                    let otherChrono = getSafe(f.chronoResult).split('ï¼ˆ')[0];
                    if (myChrono && otherChrono === myChrono) chronoSameCount++;

                    let score = 0;
                    if (myChrono && otherChrono === myChrono) score += 25;
                    if (myBigFive && getSafe(f.bigFiveResult).includes(myBigFive)) score += 35;
                    if (myCoffee && getSafe(f.coffeeResult).includes(myCoffee)) score += 20;
                    if (getSafe(myData.smResult) && getSafe(f.smResult) && getSafe(myData.smResult).split('ï¼ˆ')[0] === getSafe(f.smResult).split('ï¼ˆ')[0]) score += 20;

                    if (score >= 15) {
                        syncRanking.push({ index: index, name: otherName, icon: otherIcon, score: score, topRole: roles.length > 0 ? roles[0] : "ãƒ¡ãƒ³ãƒãƒ¼" });
                    }
                });

                if (myChrono) {
                    document.getElementById('rare-text').innerHTML = `ã‚ãªãŸã¨åŒã˜ã€Œ${myChrono}ã€ã®ã‚¼ãƒŸç”Ÿã¯ã€<br>å…¨ä½“ã§ <strong class="text-pink-400 text-sm drop-shadow-sm">${chronoSameCount + 1}äºº</strong> ã„ã¾ã™ï¼`;
                }

                syncRanking.sort((a,b) => b.score - a.score);
                const container = document.getElementById('sync-users-container');
                
                if (syncRanking.length > 0) {
                    let html = "";
                    syncRanking.slice(0, 5).forEach((user, i) => {
                        const crown = i === 0 ? "ğŸ‘‘" : "ğŸ¤";
                        const color = i === 0 ? "border-pink-400/80 bg-white/20" : "border-white/30 bg-white/10";
                        const roleDisplay = user.topRole === "ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼" || user.topRole === "æœªè¨­å®š" ? "ãƒ¡ãƒ³ãƒãƒ¼" : user.topRole;
                        
                        html += `
                        <div onclick="showOtherProfile(${user.index})" class="flex-shrink-0 rounded-2xl p-3 border ${color} w-32 flex flex-col items-center cursor-pointer hover:bg-white/30 active:scale-95 transition shadow-lg relative backdrop-blur-sm">
                            <span class="absolute -top-2 -right-2 bg-gradient-to-r from-pink-500 to-orange-400 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full shadow-md">${user.score}%</span>
                            <img src="${user.icon}" class="w-12 h-12 rounded-full mb-2 object-cover border-2 border-white/50">
                            <p class="text-[10px] text-white font-bold text-center w-full truncate drop-shadow-sm">${crown} ${user.name}</p>
                            <p class="text-[8px] text-white/80 mt-1 w-full text-center truncate">${roleDisplay}</p>
                        </div>`;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<p class="text-xs text-white/70 font-bold w-full text-center py-4">ã¾ã ä¼¼ã¦ã„ã‚‹äººãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»²é–“ãŒå¢—ãˆã‚‹ã®ã‚’å¾…ã¨ã†ï¼</p>`;
                }

            } catch (e) { console.error(e); }
        }

        function showOtherProfile(index) {
            const doc = allUsersData[index];
            const f = doc.fields;
            const p = f.profile.mapValue.fields;

            document.getElementById('other-name').innerText = getSafe(p.name) + " ã•ã‚“";
            document.getElementById('other-icon').src = getSafe(p.iconUrl) || "https://via.placeholder.com/150";
            
            let roles = [];
            if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) {
                roles = p.roles.arrayValue.values.map(v => getSafe(v));
            } else if (p.role) { roles = [getSafe(p.role)]; }
            
            const badgesContainer = document.getElementById('other-role-badges');
            badgesContainer.innerHTML = "";
            if (roles.length > 0 && !roles.includes("ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼") && !roles.includes("æœªè¨­å®š")) {
                 roles.forEach(role => {
                     badgesContainer.innerHTML += `<span class="bg-indigo-500/40 text-indigo-200 border border-indigo-400/50 text-[9px] font-bold px-2 py-0.5 rounded shadow-sm">${role}</span>`;
                 });
            }

            const uni = getSafe(p.uni);
            const grade = getSafe(p.grade);
            document.getElementById('other-univ').innerText = (uni || grade) ? `${uni} ${grade}` : "";
            
            const intro = getSafe(p.intro) || getSafe(p.selfIntro) || "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼";
            document.getElementById('other-intro').innerText = intro;

            let tagsHtml = "";
            if (p.tags && p.tags.arrayValue && p.tags.arrayValue.values) {
                p.tags.arrayValue.values.forEach(v => {
                    tagsHtml += `<span class="bg-indigo-900/50 text-indigo-200 text-[9px] font-bold px-2 py-1 rounded border border-indigo-500/50">ğŸ·ï¸ ${getSafe(v)}</span>`;
                });
            }
            if(tagsHtml === "") tagsHtml = `<span class="text-[10px] text-indigo-400/50">ã‚¿ã‚°æœªè¨­å®š</span>`;
            document.getElementById('other-tags').innerHTML = tagsHtml;

            document.getElementById('other-profile-modal').classList.remove('hidden');
            document.getElementById('other-profile-modal').classList.add('flex');
        }

        function closeOtherProfile() {
            document.getElementById('other-profile-modal').classList.add('hidden');
            document.getElementById('other-profile-modal').classList.remove('flex');
        }

        function openEditModal() { document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal').classList.add('flex'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }

        function saveProfile() {
            const name = document.getElementById('edit-name').value;
            const uni = document.getElementById('edit-uni').value;
            const faculty = document.getElementById('edit-faculty').value;
            const grade = document.getElementById('edit-grade').value;
            const selfintro = document.getElementById('edit-selfintro').value;

            if(!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }

            const text = `ã€ãƒ—ãƒ­ãƒ•æ›´æ–°ã€‘\nåå‰:${name}\nå¤§å­¦:${uni}\nå­¦éƒ¨:${faculty}\nå­¦å¹´:${grade}\nè‡ªå·±ç´¹ä»‹:${selfintro}`;
            
            liff.sendMessages([{ type: "text", text: text }]).then(() => {
                alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã€Notionã¨åŒæœŸã—ã¾ã—ãŸï¼ğŸš€\n(åæ˜ ã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)");
                window.location.reload(); 
            }).catch((err) => {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err);
            });
        }

        initMyPage();
    </script>
</body>
</html>