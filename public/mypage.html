<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: #0f172a; color: white; min-height: 100vh; padding-bottom: 5rem; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .id-card { background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); position: relative; overflow: hidden; }
        .id-card::after { content: ''; position: absolute; top: -50%; right: -20%; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; filter: blur(20px); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
        #edit-modal { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="safe-area-inset-top p-5">

    <header class="id-card rounded-3xl p-6 shadow-2xl mb-6 fade-in relative">
        <button onclick="openEditModal()" class="absolute top-4 right-4 bg-white/20 hover:bg-white/30 text-white text-[10px] font-bold px-3 py-1.5 rounded-full backdrop-blur-sm transition z-20">
            âœï¸ ç·¨é›†
        </button>
        <div class="relative z-10 flex items-center gap-4">
            <img id="user-icon" src="https://via.placeholder.com/150" class="w-20 h-20 rounded-full border-2 border-white shadow-md object-cover">
            <div>
                <p id="user-univ" class="text-[9px] font-black text-white/80 tracking-widest uppercase mb-1">åŒ—æµ·é“å¤§å­¦ å¿ƒç†ã‚¼ãƒŸ</p>
                <h1 id="user-name" class="text-2xl font-black text-white tracking-tight drop-shadow-md">ã‚²ã‚¹ãƒˆ ã•ã‚“</h1>
                <p id="user-intro" class="text-xs text-indigo-100 mt-1 font-bold line-clamp-2">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†ã—ã¦è‡ªå·±ç´¹ä»‹ã‚’æ›¸ã“ã†ï¼</p>
            </div>
        </div>
    </header>

    <main class="space-y-4">
        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.1s;">
            <h2 class="text-sm font-black text-slate-300 mb-4 tracking-widest flex items-center gap-2">
                <span>ğŸ“š</span> ã‚ãŸã—ã®ãƒˆãƒªã‚»ãƒ„
            </h2>
            <div id="tags-container" class="flex flex-wrap gap-2">
                <p class="text-xs text-slate-500 font-bold">ã¾ã ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰è¨ºæ–­ã—ã‚ˆã†ï¼</p>
            </div>
        </section>

        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-sm font-black text-slate-300 mb-4 tracking-widest flex items-center gap-2">
                <span>ğŸ‘¥</span> ã‚¼ãƒŸå†…ã®ã¤ãªãŒã‚Š
            </h2>
            
            <div class="bg-slate-800/50 rounded-xl p-4 mb-3 border border-slate-700">
                <p class="text-[10px] text-emerald-400 font-bold mb-1">âœ¨ ã‚·ãƒ³ã‚¯ãƒ­ç‡ ç¬¬1ä½</p>
                <p class="text-xs text-slate-300 font-bold leading-relaxed">
                    ã‚ãªãŸã¨ä¸€ç•ªæ€§æ ¼ã‚¿ã‚¤ãƒ—ãŒä¼¼ã¦ã„ã‚‹ã‚¼ãƒŸç”Ÿã¯...<br>
                    <span id="sync-match" class="text-lg text-white font-black bg-emerald-500/20 px-2 py-0.5 rounded mt-1 inline-block">è¨ˆç®—ä¸­... ğŸ”„</span>
                </p>
            </div>

            <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                <p class="text-[10px] text-pink-400 font-bold mb-1">ğŸ‘‘ ã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚¢åº¦</p>
                <p id="rare-text" class="text-xs text-slate-300 font-bold leading-relaxed">è¨ˆç®—ä¸­... ğŸ”„</p>
            </div>
        </section>
    </main>

    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex-col justify-end">
        <div class="bg-slate-800 rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-700 max-h-[90vh] overflow-y-auto w-full max-w-md mx-auto relative animate-[translateY_0.3s_ease-out]">
            <button onclick="closeEditModal()" class="absolute top-5 right-5 text-slate-400 text-2xl font-bold">&times;</button>
            <h3 class="text-lg font-black text-white mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h3>
            
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-400">åå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ æ¨å¥¨ï¼‰</label><input type="text" id="edit-name" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white focus:outline-none focus:border-indigo-500"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-400">å¤§å­¦</label><input type="text" id="edit-uni" value="åŒ—æµ·é“å¤§å­¦" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white"></div>
                    <div><label class="text-[10px] font-bold text-slate-400">å­¦å¹´</label>
                        <select id="edit-grade" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white">
                            <option value="B1">B1 (1å¹´)</option><option value="B2">B2 (2å¹´)</option><option value="B3">B3 (3å¹´)</option><option value="B4">B4 (4å¹´)</option><option value="M1">M1 (é™¢1)</option><option value="M2">M2 (é™¢2)</option><option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-400">å­¦éƒ¨ãƒ»å­¦ç§‘</label><input type="text" id="edit-faculty" placeholder="ä¾‹: å·¥å­¦éƒ¨ ç’°å¢ƒç¤¾ä¼šå·¥å­¦ç§‘" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white"></div>
                <div><label class="text-[10px] font-bold text-slate-400">ä»Šã®ã²ã¨ã“ã¨ (è‡ªå·±ç´¹ä»‹)</label><textarea id="edit-intro" rows="3" placeholder="æœ€è¿‘ãƒãƒã£ã¦ã‚‹ã“ã¨ãªã©ï¼" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white"></textarea></div>
            </div>
            
            <button onclick="saveProfile()" class="w-full mt-6 bg-indigo-600 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition">
                ä¿å­˜ã—ã¦Notionã¨åŒæœŸã™ã‚‹ ğŸš€
            </button>
        </div>
    </div>

    <script>
        let myData = null;

        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å®‰å…¨ã«å–å¾—ã™ã‚‹ä¾¿åˆ©é–¢æ•°
        function getSafe(field) {
            if (!field) return "";
            if (field.stringValue !== undefined) return field.stringValue;
            if (field.integerValue !== undefined) return field.integerValue;
            return "";
        }

        async function initMyPage() {
            try {
                // â˜…LIFF IDã¯ãƒãƒ¼ã‚¿ãƒ«ã¨åŒã˜ã‚‚ã®ï¼
                await liff.init({ liffId: "2009176797-S5FV668D" }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                
                const profile = await liff.getProfile();
                document.getElementById('user-icon').src = profile.pictureUrl;
                document.getElementById('user-name').innerText = profile.displayName + " ã•ã‚“";

                // Firestoreã‹ã‚‰è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const url = `https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${profile.userId}`;
                const res = await fetch(url);
                
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields) {
                        myData = json.fields;
                        renderProfile(myData);
                        renderTags(myData);
                        
                        // ã¤ãªãŒã‚Šè¨ˆç®—ã®ãŸã‚ã«å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        fetchConnections(profile.userId, myData);
                    }
                }
            } catch (err) { console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err); }
        }

        function renderProfile(data) {
            // Firestoreã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ profile ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
            if (data.profile && data.profile.mapValue && data.profile.mapValue.fields) {
                const p = data.profile.mapValue.fields;
                const name = getSafe(p.name);
                const uni = getSafe(p.uni);
                const grade = getSafe(p.grade);
                const intro = getSafe(p.intro);
                
                if (name) document.getElementById('user-name').innerText = name + " ã•ã‚“";
                if (uni || grade) document.getElementById('user-univ').innerText = `${uni} ${grade}`;
                if (intro) document.getElementById('user-intro').innerText = intro;

                // â˜…ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸå€¤ï¼ˆå‰å›ã®å…¥åŠ›å†…å®¹ï¼‰ã¨ã—ã¦ã‚»ãƒƒãƒˆï¼
                document.getElementById('edit-name').value = name;
                document.getElementById('edit-uni').value = uni;
                document.getElementById('edit-faculty').value = getSafe(p.faculty);
                document.getElementById('edit-grade').value = grade || "B1";
                document.getElementById('edit-intro').value = intro;
            }
        }

        function renderTags(data) {
            const container = document.getElementById('tags-container');
            let html = "";
            if (data.motivationResult) html += `<span class="bg-orange-500/20 text-orange-400 border border-orange-500/30 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">ğŸ”¥ ${getSafe(data.motivationResult).replace('ã‚„ã‚‹æ°—ï¼š', '')}</span>`;
            if (data.bigFiveResult) {
                const match = getSafe(data.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/);
                if (match) html += `<span class="bg-indigo-500/20 text-indigo-400 border border-indigo-500/30 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">ğŸ§  ${match[1]}æ´¾</span>`;
            }
            if (data.chronoResult) html += `<span class="bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">â° ${getSafe(data.chronoResult).split('ï¼ˆ')[0]}</span>`;
            if (data.coffeeResult) html += `<span class="bg-amber-600/20 text-amber-500 border border-amber-600/30 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">â˜• ${getSafe(data.coffeeResult).split(' ')[0]}å¥½ã</span>`;
            if (data.smResult) html += `<span class="bg-pink-500/20 text-pink-400 border border-pink-500/30 text-xs font-bold px-3 py-1.5 rounded-lg shadow-sm">ğŸŒ¬ï¸ ${getSafe(data.smResult).split('ï¼ˆ')[0]}</span>`;

            if (html !== "") container.innerHTML = html;
        }

        async function fetchConnections(myUserId, myD) {
            try {
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`);
                const json = await res.json();
                
                if (!json.documents) return;

                // è‡ªåˆ†ã®ã‚¿ã‚¤ãƒ—ã‚’æŠ½å‡º
                const myChrono = getSafe(myD.chronoResult).split('ï¼ˆ')[0];
                const myBigFiveMatch = getSafe(myD.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/);
                const myBigFive = myBigFiveMatch ? myBigFiveMatch[1] : "";

                let chronoSameCount = 0;
                let syncRanking = [];

                json.documents.forEach(doc => {
                    // è‡ªåˆ†è‡ªèº«ã¯ã‚¹ã‚­ãƒƒãƒ—
                    if (doc.name.includes(myUserId)) return;
                    const f = doc.fields;
                    if (!f) return;

                    let otherChrono = getSafe(f.chronoResult).split('ï¼ˆ')[0];
                    if (myChrono && otherChrono === myChrono) chronoSameCount++;

                    // ã‚·ãƒ³ã‚¯ãƒ­ç‡ã®è¨ˆç®—ï¼ˆä¸€è‡´ã—ãŸãƒ†ã‚¹ãƒˆçµæœã®æ•°ï¼‰
                    let score = 0;
                    if (myChrono && otherChrono === myChrono) score += 20;
                    if (myBigFive && getSafe(f.bigFiveResult).includes(myBigFive)) score += 30;
                    if (getSafe(myD.coffeeResult) && getSafe(f.coffeeResult) && getSafe(myD.coffeeResult).split(' ')[0] === getSafe(f.coffeeResult).split(' ')[0]) score += 15;
                    if (getSafe(myD.smResult) && getSafe(f.smResult) && getSafe(myD.smResult).split('ï¼ˆ')[0] === getSafe(f.smResult).split('ï¼ˆ')[0]) score += 25;

                    if (score > 0) {
                        let otherName = "åŒ¿åãƒ¡ãƒ³ãƒãƒ¼";
                        if (f.profile && f.profile.mapValue && f.profile.mapValue.fields && f.profile.mapValue.fields.name) {
                            otherName = f.profile.mapValue.fields.name.stringValue;
                        }
                        syncRanking.push({ name: otherName, score: score });
                    }
                });

                // ãƒ¬ã‚¢åº¦ã®è¡¨ç¤º
                if (myChrono) {
                    document.getElementById('rare-text').innerHTML = `ã‚ãªãŸã¨åŒã˜ã€Œ${myChrono}ã€ã®ã‚¼ãƒŸç”Ÿã¯ã€<br>å…¨ä½“ã§ <strong>${chronoSameCount + 1}äºº</strong> ã„ã¾ã™ï¼`;
                } else {
                    document.getElementById('rare-text').innerHTML = "ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã‚‹ã¨ã“ã“ã«ãƒ¬ã‚¢åº¦ãŒå‡ºã¾ã™ï¼";
                }

                // ã‚·ãƒ³ã‚¯ãƒ­ç‡ãƒˆãƒƒãƒ—ã®è¡¨ç¤º
                syncRanking.sort((a,b) => b.score - a.score);
                if (syncRanking.length > 0) {
                    document.getElementById('sync-match').innerText = `ğŸ¤ ${syncRanking[0].name} ã•ã‚“ï¼ˆã‚·ãƒ³ã‚¯ãƒ­ç‡ ${syncRanking[0].score}%ï¼‰`;
                } else {
                    document.getElementById('sync-match').innerText = "ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒè¶³ã‚Šã¾ã›ã‚“ï¼";
                }

            } catch (e) { console.error(e); }
        }

        function openEditModal() { document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal').classList.add('flex'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }

        // ğŸš€ ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†ï¼ˆã“ã“ã§LINE Botã«è£ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ï¼ï¼‰
        function saveProfile() {
            const name = document.getElementById('edit-name').value;
            const uni = document.getElementById('edit-uni').value;
            const faculty = document.getElementById('edit-faculty').value;
            const grade = document.getElementById('edit-grade').value;
            const intro = document.getElementById('edit-intro').value;

            if(!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }

            // LIFFçµŒç”±ã§Botã«ã€Œé­”æ³•ã®è¨€è‘‰ã€ã‚’é€ä¿¡ã—ã¦ã€è£å´ã§Notionã‚’æ›´æ–°ã•ã›ã‚‹ï¼
            const text = `ã€ãƒ—ãƒ­ãƒ•æ›´æ–°ã€‘\nåå‰:${name}\nå¤§å­¦:${uni}\nå­¦éƒ¨:${faculty}\nå­¦å¹´:${grade}\nè‡ªå·±ç´¹ä»‹:${intro}`;
            
            liff.sendMessages([{ type: "text", text: text }]).then(() => {
                alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼\nåæ˜ ã«ã¯å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚");
                window.location.reload(); // ç”»é¢ã‚’æ›´æ–°ã—ã¦æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            }).catch((err) => {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err);
            });
        }

        initMyPage();
    </script>
</body>
</html>