<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ | åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Zen+Kaku+Gothic+New:wght@700;900&family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: linear-gradient(-45deg, #ffffff, #f8fafc, #eff6ff, #fdf4ff, #fffbeb); background-size: 300% 300%; animation: auroraBG 15s ease infinite; color: #1e293b; min-height: 100vh; padding-bottom: 5rem; }
        @keyframes auroraBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 10px 30px -10px rgba(71, 85, 105, 0.15); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-gold { background: linear-gradient(135deg, #fef08a 0%, #fde68a 100%); border: 1px solid #fcd34d; box-shadow: 0 10px 30px -10px rgba(251, 191, 36, 0.4); color: #78350f; }
        .card-silver { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border: 1px solid #cbd5e1; color: #334155; }
        .card-special { background: linear-gradient(135deg, #e0e7ff 0%, #fae8ff 100%); border: 1px solid #c7d2fe; color: #312e81; }
        .card-normal { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 10px 30px -10px rgba(71, 85, 105, 0.1); color: #1e293b; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="safe-area-inset-top p-5">

    <div class="text-center mb-6 fade-in pt-2 mx-2">
        <div class="relative p-[3px] rounded-3xl bg-gradient-to-r from-cyan-300 via-indigo-300 to-pink-300 shadow-md">
            <div class="bg-white/95 backdrop-blur-xl rounded-[1.7rem] py-5 px-4 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-1/3 bg-gradient-to-b from-white to-transparent"></div>
                <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-700 via-purple-700 to-pink-600 tracking-[0.1em] mb-2 relative z-10" style="font-family: 'Zen Kaku Gothic New', sans-serif;">åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ</h1>
                <p class="text-[10px] font-black text-indigo-500 tracking-[0.2em] mb-1 relative z-10">å­¦å•ã®å®Ÿè·µ</p>
                <p class="text-[8px] text-pink-500 font-bold tracking-[0.1em] relative z-10">ã€œçŸ¥è­˜ã‚’è¡Œå‹•ã«å¤‰ãˆæœªæ¥ã‚’ç™ºæ˜ã™ã‚‹ã€œ</p>
            </div>
        </div>
    </div>

    <header id="id-card" class="card-normal rounded-3xl p-6 mb-6 fade-in relative overflow-hidden transition-all duration-500">
        <div class="absolute top-[-50%] right-[-20%] w-[200px] h-[200px] bg-white/50 rounded-full filter blur-[20px]"></div>
        <button onclick="openEditModal()" class="absolute top-4 right-4 bg-white/80 hover:bg-white text-slate-700 text-[10px] font-bold px-3 py-1.5 rounded-full backdrop-blur-md transition z-20 flex items-center gap-1 border border-slate-200 shadow-sm"><span>âœï¸</span> ç·¨é›†</button>
        <div class="relative z-10 pr-16"> 
            <div class="flex items-center gap-4 mb-4">
                <img id="user-icon" src="https://via.placeholder.com/150" class="w-16 h-16 sm:w-20 sm:h-20 rounded-full border-2 border-white shadow-md object-cover flex-shrink-0">
                <div>
                    <p id="user-univ" class="text-[9px] font-bold opacity-80 mb-0.5">å¤§å­¦ãƒ»å­¦éƒ¨ã‚’è¨­å®šã—ã‚ˆã†</p>
                    <h1 id="user-name" class="text-xl sm:text-2xl font-black tracking-tight leading-tight">ã‚²ã‚¹ãƒˆ ã•ã‚“</h1>
                    <div id="user-role-badges" class="flex flex-wrap gap-1 mt-1.5 hidden"></div>
                </div>
            </div>
            <div class="bg-black/5 rounded-xl p-3 border border-black/5 flex items-start gap-2 relative group cursor-pointer active:scale-95 transition" onclick="editHitokoto()">
                <span class="text-sm">ğŸ’¬</span>
                <div class="flex-1">
                    <p class="text-[9px] opacity-60 font-bold mb-0.5">ä»Šã®ã²ã¨ã“ã¨ (ã‚¿ãƒƒãƒ—ã§ç·¨é›†)</p>
                    <p id="user-intro" class="text-xs font-bold leading-relaxed">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã²ã¨ã“ã¨ã‚’è¨­å®šï¼</p>
                </div>
                <span class="opacity-40 text-xs">âœï¸</span>
            </div>
        </div>
    </header>

    <main class="space-y-4">
        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.1s;">
            <div class="flex justify-between items-end mb-3">
                <h2 class="text-sm font-black text-slate-800 tracking-widest flex items-center gap-2"><span>ğŸ·ï¸</span> è‡ªåˆ†ã®èˆˆå‘³ã‚¿ã‚°</h2>
                <button onclick="openEditModal()" class="text-[10px] text-indigo-500 font-bold bg-indigo-50 px-2 py-1 rounded-md">ï¼‹ è¿½åŠ </button>
            </div>
            <div id="my-interest-tags" class="flex flex-wrap gap-1.5"></div>
        </section>

        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.15s;">
            <h2 class="text-sm font-black text-slate-800 tracking-widest flex items-center gap-2 mb-4"><span>ğŸ“…</span> ã‚ãŸã—ã®æ´»å‹•äºˆå®š</h2>
            <div class="mb-5">
                <p class="text-[10px] text-indigo-600 font-bold mb-2">ğŸš€ å‚åŠ äºˆå®š</p>
                <div id="dashboard-planned" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"><div class="w-full text-center py-4 bg-slate-50 rounded-xl border border-slate-100"><p class="text-xs text-slate-400 font-bold animate-pulse">äºˆå®šã‚’å–å¾—ä¸­...</p></div></div>
            </div>
            <div class="mb-5">
                <p class="text-[10px] text-orange-500 font-bold mb-2">ğŸ¤” è¿·ã„ä¸­</p>
                <div id="dashboard-maybe" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"><p class="text-xs text-slate-400 font-bold px-2">è¿·ã„ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p></div>
            </div>
            <div class="mb-5">
                <p class="text-[10px] text-pink-500 font-bold mb-2">âœ¨ ã‚ãªãŸã«ãŠã™ã™ã‚ï¼ˆèˆˆå‘³ã‚¿ã‚°ä¸€è‡´ï¼‰</p>
                <div id="dashboard-recommended" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"><p class="text-xs text-slate-400 font-bold px-2">ãŠã™ã™ã‚ã‚’æ¢ã™ã«ã¯ã€èˆˆå‘³ã‚¿ã‚°ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼</p></div>
            </div>
            <div>
                <p class="text-[10px] text-emerald-600 font-bold mb-2">ğŸ† æ´»å‹•å±¥æ­´</p>
                <div id="dashboard-past" class="space-y-2"><p class="text-xs text-slate-400 font-bold px-2">ã¾ã æ´»å‹•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p></div>
            </div>
        </section>

        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-sm font-black text-slate-800 tracking-widest flex items-center gap-2 mb-3"><span>ğŸ“š</span> ã‚ãŸã—ã®ãƒˆãƒªã‚»ãƒ„</h2>
            <p id="tags-hint" class="text-[9px] text-indigo-500 font-bold mb-3 hidden">ğŸ‘‡ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨åŒã˜ã‚¿ã‚¤ãƒ—ã®ã‚¼ãƒŸç”Ÿã‚’æ¢ã›ã¾ã™ï¼</p>
            <div id="tags-container" class="flex flex-wrap gap-2"><p class="text-xs text-slate-500 font-bold">ã¾ã ãƒ†ã‚¹ãƒˆã‚’å—ã‘ã¦ã„ã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰è¨ºæ–­ã—ã‚ˆã†ï¼</p></div>
        </section>

        <section class="glass-card rounded-[2rem] p-5 fade-in" style="animation-delay: 0.3s;">
            <h2 class="text-sm font-black text-slate-800 mb-4 tracking-widest flex items-center gap-2"><span>ğŸ‘¥</span> ã‚¼ãƒŸå†…ã®ã¤ãªãŒã‚Š</h2>
            <div class="mb-4">
                <p class="text-[10px] text-emerald-600 font-bold mb-2">âœ¨ ã‚ãªãŸã¨ä¼¼ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ (ã‚·ãƒ³ã‚¯ãƒ­ç‡)</p>
                <div id="sync-users-container" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"><p class="text-xs text-slate-500 font-bold w-full text-center py-4">ãƒ‡ãƒ¼ã‚¿åé›†ä¸­... ğŸ”„</p></div>
            </div>
            <div class="bg-pink-50/50 rounded-xl p-4 border border-pink-100">
                <p class="text-[10px] text-pink-600 font-black mb-1">ğŸ‘‘ ã‚¿ã‚¤ãƒ—ã®ãƒ¬ã‚¢åº¦</p>
                <p id="rare-text" class="text-xs text-slate-700 font-bold leading-relaxed">è¨ˆç®—ä¸­... ğŸ”„</p>
            </div>
        </section>
    </main>

    <div id="same-type-modal" class="fixed inset-0 z-[55] hidden flex-col justify-end bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-200 max-h-[75vh] flex flex-col w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeSameTypeModal()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 id="same-type-title" class="text-lg font-black text-slate-800 mb-1">ğŸ» ã‚¯ãƒå‹ã®ãƒ¡ãƒ³ãƒãƒ¼</h3>
            <p id="same-type-count" class="text-xs text-indigo-500 font-bold mb-4">ã‚ãªãŸä»¥å¤–ã« ã€‡ äººã„ã¾ã™</p>
            <div id="same-type-list" class="space-y-2 overflow-y-auto pr-2 no-scrollbar pb-10"></div>
        </div>
    </div>

    <div id="event-detail-modal" class="fixed inset-0 z-[70] hidden flex-col justify-end bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-200 max-h-[85vh] flex flex-col w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeEventDetail()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 id="event-modal-title" class="text-lg font-black text-slate-800 mb-4 pr-8 leading-tight">ã‚¤ãƒ™ãƒ³ãƒˆå</h3>
            <div id="event-modal-content" class="overflow-y-auto no-scrollbar pb-6 space-y-4"></div>
        </div>
    </div>

    <div id="past-events-modal" class="fixed inset-0 z-[65] hidden flex-col justify-end bg-slate-900/60 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-200 max-h-[80vh] flex flex-col w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closePastEventsModal()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 class="text-lg font-black text-slate-800 mb-4">ğŸ† æ´»å‹•å±¥æ­´ï¼ˆã™ã¹ã¦ï¼‰</h3>
            <div id="past-events-list" class="overflow-y-auto no-scrollbar pb-6 space-y-3"></div>
        </div>
    </div>

    <div id="other-profile-modal" class="fixed inset-0 z-[80] hidden flex-col justify-end bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2.5rem] p-6 shadow-2xl border-t border-slate-200 max-h-[85vh] w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeOtherProfile()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            <div class="flex flex-col items-center mt-2 mb-6">
                <img id="other-icon" src="" class="w-24 h-24 rounded-full border-4 border-slate-100 mb-3 object-cover shadow-sm">
                <div id="other-role-badges" class="flex flex-wrap justify-center gap-1 mb-2"></div>
                <h3 id="other-name" class="text-xl font-black text-slate-800 mb-1"></h3>
                <p id="other-univ" class="text-[10px] text-slate-500 font-bold"></p>
            </div>
            <div class="bg-slate-50 rounded-xl p-4 mb-4 border border-slate-200">
                <p class="text-[10px] text-slate-500 font-bold mb-1">ğŸ’¬ ä»Šã®ã²ã¨ã“ã¨</p>
                <p id="other-intro" class="text-sm text-slate-700 font-bold"></p>
            </div>
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                <p class="text-[10px] text-slate-500 font-bold mb-2">ğŸ·ï¸ èˆˆå‘³ã‚¿ã‚°</p>
                <div id="other-tags" class="flex flex-wrap gap-1.5"></div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 z-[90] hidden flex-col justify-end bg-slate-900/40 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-200 max-h-[90vh] overflow-y-auto w-full max-w-md mx-auto relative animate-[translateY_0.3s_ease-out]">
            <button onclick="closeEditModal()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            <h3 class="text-lg font-black text-slate-800 mb-6">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è©³ç´°è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="text-[10px] font-bold text-slate-500">åå‰ï¼ˆãƒ•ãƒ«ãƒãƒ¼ãƒ æ¨å¥¨ï¼‰</label><input type="text" id="edit-name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-800 focus:outline-none focus:border-indigo-400"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold text-slate-500">å¤§å­¦</label><input type="text" id="edit-uni" value="åŒ—æµ·é“å¤§å­¦" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-800"></div>
                    <div><label class="text-[10px] font-bold text-slate-500">å­¦å¹´</label>
                        <select id="edit-grade" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-800">
                            <option value="å­¦éƒ¨1å¹´">å­¦éƒ¨1å¹´</option><option value="å­¦éƒ¨2å¹´">å­¦éƒ¨2å¹´</option><option value="å­¦éƒ¨3å¹´">å­¦éƒ¨3å¹´</option><option value="å­¦éƒ¨4å¹´">å­¦éƒ¨4å¹´</option><option value="ä¿®å£«1å¹´">ä¿®å£«1å¹´</option><option value="ä¿®å£«2å¹´">ä¿®å£«2å¹´</option><option value="åšå£«1å¹´">åšå£«1å¹´</option><option value="åšå£«2å¹´">åšå£«2å¹´</option><option value="åšå£«3å¹´">åšå£«3å¹´</option><option value="åšå£«4å¹´">åšå£«4å¹´</option><option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                </div>
                <div><label class="text-[10px] font-bold text-slate-500">å­¦éƒ¨ãƒ»å­¦ç§‘</label><input type="text" id="edit-faculty" placeholder="ä¾‹: å·¥å­¦éƒ¨ ç’°å¢ƒç¤¾ä¼šå·¥å­¦ç§‘" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-800"></div>
                <div>
                    <label class="text-[10px] font-bold flex justify-between"><span class="text-slate-500">è©³ã—ã„è‡ªå·±ç´¹ä»‹æ–‡</span> <span class="text-indigo-400">â€»Notionã«è¨˜éŒ²ã•ã‚Œã¾ã™</span></label>
                    <textarea id="edit-selfintro" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm text-slate-800 mt-1 focus:outline-none focus:border-indigo-400"></textarea>
                </div>
                <div class="pt-2 border-t border-slate-100">
                    <label class="text-[10px] font-bold text-slate-500 mb-2 block">ğŸ·ï¸ èˆˆå‘³ã‚¿ã‚°ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
                    <div id="edit-tags-container" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <button onclick="saveProfile()" class="w-full mt-6 bg-gradient-to-r from-indigo-500 to-pink-500 text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">ä¿å­˜ã—ã¦åŒæœŸã™ã‚‹ ğŸš€</button>
        </div>
    </div>

    <script>
        let myData = null;
        let myUserId = "";
        let allUsersData = [];
        let AVAILABLE_TAGS = [];
        let globalPastEvents = []; 

        function getSafe(field) {
            if (!field) return "";
            if (field.stringValue !== undefined) return field.stringValue;
            if (field.integerValue !== undefined) return field.integerValue;
            return "";
        }

        async function fetchAvailableTags() {
            try {
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/system/metadata`);
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields && json.fields.tags && json.fields.tags.arrayValue && json.fields.tags.arrayValue.values) {
                        AVAILABLE_TAGS = json.fields.tags.arrayValue.values.map(v => v.stringValue);
                    }
                }
            } catch (e) { console.error("ã‚¿ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼", e); }
        }

        // ğŸŒŸ å½¹è·ãƒãƒƒã‚¸ã®HTMLã‚’ç”Ÿæˆã™ã‚‹å…±é€šé–¢æ•°ï¼ˆè‡ªåˆ†ç”¨ã«ã‚‚ä»–äººç”¨ã«ã‚‚ä½¿ãˆã‚‹ï¼ï¼‰
        function getRoleBadgeHtml(role) {
            let badgeClass = "", badgeIcon = "";
            if (role === "ä»£è¡¨") { badgeIcon = "ğŸ‘‘"; badgeClass = "bg-yellow-500/20 text-yellow-800 border border-yellow-400"; } 
            else if (["ç§˜æ›¸", "çµ±æ‹¬", "åºƒå ±", "è£œä½"].some(r => role.includes(r))) { badgeIcon = "ğŸ›¡ï¸"; badgeClass = "bg-slate-200/50 text-slate-700 border border-slate-400"; } 
            else if (role.includes("éƒ¨") || role.includes("PJ") || ["ã‚¼ãƒŸ", "è¬›ç¾©"].some(r => role.includes(r))) { badgeIcon = "âœ¨"; badgeClass = "bg-indigo-500/10 text-indigo-700 border border-indigo-300"; } 
            else { badgeIcon = "ğŸ”–"; badgeClass = "bg-slate-100 text-slate-600 border border-slate-200"; }
            return `<span class="inline-block ${badgeClass} text-[10px] font-black tracking-widest px-2 py-0.5 rounded shadow-sm">${badgeIcon} ${role}</span>`;
        }

        async function fetchDashboardEvents() {
            try {
                const url = `https://asia-northeast1-shinrizemi-linebot.cloudfunctions.net/getUserEvents?userId=${myUserId}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error("Network error");
                const events = await res.json();
                globalPastEvents = events.past; 

                // ğŸš€ å‚åŠ äºˆå®šï¼ˆç¸¦ä¸¦ã³ï¼‰
                if (events.planned.length > 0) {
                    document.getElementById('dashboard-planned').className = "space-y-3";
                    document.getElementById('dashboard-planned').innerHTML = events.planned.map(ev => `
                        <div onclick="openEventDetail('${ev.id}', '${ev.title}')" class="bg-white rounded-xl p-4 border border-indigo-200 shadow-sm flex flex-col cursor-pointer hover:bg-slate-50 active:scale-95 transition">
                            <div class="text-[10px] text-indigo-500 font-bold mb-1">ğŸ“… ${ev.date}</div>
                            <h4 class="text-sm font-black text-slate-800 leading-tight">${ev.title}</h4>
                            <div class="flex gap-1 flex-wrap mt-2">${ev.tags.map(t => `<span class="text-[8px] bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded border border-slate-200">${t}</span>`).join('')}</div>
                        </div>`).join('');
                } else {
                    document.getElementById('dashboard-planned').innerHTML = '<p class="text-xs text-slate-400 font-bold px-2 py-4">å‚åŠ äºˆå®šã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ã‚¿ãƒ«ã‹ã‚‰æ¢ãã†ï¼</p>';
                }

                // ğŸ¤” è¿·ã„ä¸­ ï¼† âœ¨ ãŠã™ã™ã‚ï¼ˆæ¨ªä¸¦ã³ï¼‰
                const createHorizontalCard = (ev, borderCol, bgCol) => `
                    <div onclick="openEventDetail('${ev.id}', '${ev.title}')" class="flex-shrink-0 w-48 bg-white rounded-xl p-4 border ${borderCol} ${bgCol} shadow-sm cursor-pointer hover:bg-slate-50 active:scale-95 transition flex flex-col justify-between">
                        <div>
                            <div class="text-[10px] font-bold mb-1 opacity-70">ğŸ“… ${ev.date}</div>
                            <h4 class="text-sm font-black text-slate-800 leading-tight mb-2 line-clamp-2">${ev.title}</h4>
                        </div>
                    </div>`;

                if (events.maybe.length > 0) document.getElementById('dashboard-maybe').innerHTML = events.maybe.map(e => createHorizontalCard(e, "border-orange-200", "bg-orange-50/50")).join('');
                if (events.recommended.length > 0) document.getElementById('dashboard-recommended').innerHTML = events.recommended.map(e => createHorizontalCard(e, "border-pink-200", "bg-pink-50/50")).join('');

                // ğŸ† æ´»å‹•å±¥æ­´ï¼ˆæ¨ªä¸¦ã³ã€ç›´è¿‘5ä»¶ ï¼‹ ã™ã¹ã¦è¦‹ã‚‹ï¼‰
                if (events.past.length > 0) {
                    document.getElementById('dashboard-past').className = "flex gap-3 overflow-x-auto no-scrollbar pb-2 pt-1"; 
                    let pastHtml = events.past.slice(0, 5).map(ev => `
                        <div onclick="openEventDetail('${ev.id}', '${ev.title}')" class="flex-shrink-0 w-40 bg-white rounded-xl p-3 border border-emerald-200 shadow-sm cursor-pointer hover:bg-slate-50 active:scale-95 transition">
                            <div class="text-[9px] text-emerald-600 font-bold mb-1">ğŸ“… ${ev.date}</div>
                            <h4 class="text-xs font-bold text-slate-700 line-clamp-2 leading-tight">${ev.title}</h4>
                        </div>`).join('');
                    
                    if (events.past.length > 5) {
                        pastHtml += `<div onclick="openPastEventsModal()" class="flex-shrink-0 w-24 bg-slate-50 rounded-xl border border-slate-200 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-100 active:scale-95 transition shadow-sm">
                            <span class="text-lg mb-1">ğŸ‘€</span><span class="text-[10px] font-bold text-slate-500">ã™ã¹ã¦è¦‹ã‚‹</span></div>`;
                    }
                    document.getElementById('dashboard-past').innerHTML = pastHtml;
                }
            } catch(e) { document.getElementById('dashboard-planned').innerHTML = '<p class="text-xs text-red-400 px-2 py-4">äºˆå®šã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</p>'; }
        }

        async function initMyPage() {
            try {
                await liff.init({ liffId: "2009176797-tgpGsUUz" }); 
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUserId = profile.userId;
                document.getElementById('user-icon').src = profile.pictureUrl; document.getElementById('user-name').innerText = profile.displayName + " ã•ã‚“";
                await fetchAvailableTags();
                fetchDashboardEvents();
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users/${myUserId}`);
                if (res.ok) {
                    const json = await res.json();
                    if (json.fields) { myData = json.fields; renderProfile(myData); renderTags(myData); }
                } else { renderEditTags([]); }
                fetchConnections();
            } catch (err) { console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", err); }
        }

        function applyRoleStyle(roles) {
            const card = document.getElementById('id-card'); const badgesContainer = document.getElementById('user-role-badges');
            card.className = "rounded-3xl p-6 mb-6 fade-in relative overflow-hidden transition-all duration-500";
            badgesContainer.innerHTML = "";
            if (!roles || roles.length === 0 || roles.includes("ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼") || roles.includes("æœªè¨­å®š")) {
                card.classList.add('card-normal'); badgesContainer.classList.add('hidden'); return;
            }
            badgesContainer.classList.remove('hidden');
            let highestRarity = 4; 
            roles.forEach(role => {
                if (role === "ä»£è¡¨") highestRarity = Math.min(highestRarity, 1);
                else if (["ç§˜æ›¸", "çµ±æ‹¬", "åºƒå ±", "è£œä½"].some(r => role.includes(r))) highestRarity = Math.min(highestRarity, 2);
                else if (role.includes("éƒ¨") || role.includes("PJ") || ["ã‚¼ãƒŸ", "è¬›ç¾©"].some(r => role.includes(r))) highestRarity = Math.min(highestRarity, 3);
                badgesContainer.innerHTML += getRoleBadgeHtml(role); // å…±é€šé–¢æ•°ã‚’ä½¿ç”¨
            });
            if (highestRarity === 1) card.classList.add('card-gold'); else if (highestRarity === 2) card.classList.add('card-silver'); else card.classList.add('card-special');
        }

        function renderEditTags(userTags) {
            let html = "";
            AVAILABLE_TAGS.forEach(tag => {
                const isChecked = userTags.includes(tag);
                const bgClass = isChecked ? "bg-indigo-500 text-white border-indigo-500" : "bg-slate-50 text-slate-500 border-slate-200";
                html += `<label class="inline-block px-3 py-1.5 rounded-full text-[10px] font-bold border cursor-pointer transition ${bgClass}"><input type="checkbox" value="${tag}" class="hidden tag-checkbox" ${isChecked ? "checked" : ""} onchange="toggleTagStyle(this)">${tag}</label>`;
            });
            document.getElementById('edit-tags-container').innerHTML = html;
        }

        function toggleTagStyle(checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) { label.classList.replace('bg-slate-50', 'bg-indigo-500'); label.classList.replace('text-slate-500', 'text-white'); label.classList.replace('border-slate-200', 'border-indigo-500'); } 
            else { label.classList.replace('bg-indigo-500', 'bg-slate-50'); label.classList.replace('text-white', 'text-slate-500'); label.classList.replace('border-indigo-500', 'border-slate-200'); }
        }

        function renderProfile(data) {
            if (data.profile && data.profile.mapValue && data.profile.mapValue.fields) {
                const p = data.profile.mapValue.fields;
                const name = getSafe(p.name); const uni = getSafe(p.uni); const grade = getSafe(p.grade); const intro = getSafe(p.intro); const selfIntro = getSafe(p.selfIntro); 
                let roles = []; if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) roles = p.roles.arrayValue.values.map(v => getSafe(v)); else if (p.role) roles = [getSafe(p.role)];
                let tags = []; if (p.tags && p.tags.arrayValue && p.tags.arrayValue.values) tags = p.tags.arrayValue.values.map(v => getSafe(v));

                if (name) document.getElementById('user-name').innerText = name + " ã•ã‚“";
                if (uni || grade) document.getElementById('user-univ').innerText = `${uni} ${grade}`;
                if (intro) document.getElementById('user-intro').innerText = intro;

                applyRoleStyle(roles);
                let tagsHtml = ""; tags.forEach(tag => { tagsHtml += `<span class="bg-indigo-50 text-indigo-600 border border-indigo-200 text-[10px] font-bold px-2.5 py-1 rounded shadow-sm">ğŸ·ï¸ ${tag}</span>`; });
                if(tagsHtml) document.getElementById('my-interest-tags').innerHTML = tagsHtml;

                document.getElementById('edit-name').value = name; document.getElementById('edit-uni').value = uni; document.getElementById('edit-faculty').value = getSafe(p.faculty);
                document.getElementById('edit-grade').value = grade || "å­¦éƒ¨1å¹´"; document.getElementById('edit-selfintro').value = selfIntro;
                renderEditTags(tags);
            } else { renderEditTags([]); }
        }

        function renderTags(data) {
            const container = document.getElementById('tags-container'); let html = "";
            if (data.motivationResult) html += `<button onclick="showSameTypeUsers('${getSafe(data.motivationResult).replace('ã‚„ã‚‹æ°—ï¼š', '')}', 'motivation', 'ğŸ”¥ ã‚„ã‚‹æ°—ã‚¿ã‚¤ãƒ—')" class="bg-orange-50 hover:bg-orange-100 text-orange-600 border border-orange-200 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm">ğŸ”¥ ${getSafe(data.motivationResult).replace('ã‚„ã‚‹æ°—ï¼š', '')}</button>`;
            if (data.bigFiveResult) { const match = getSafe(data.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/); if (match) html += `<button onclick="showSameTypeUsers('${match[1]}', 'bigFive', 'ğŸ§  æ€§æ ¼ã‚¿ã‚¤ãƒ—')" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm">ğŸ§  ${match[1]}æ´¾</button>`; }
            if (data.chronoResult) html += `<button onclick="showSameTypeUsers('${getSafe(data.chronoResult).split('ï¼ˆ')[0]}', 'chrono', 'â° ã‚¯ãƒ­ãƒã‚¿ã‚¤ãƒ—')" class="bg-emerald-50 hover:bg-emerald-100 text-emerald-600 border border-emerald-200 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm">â° ${getSafe(data.chronoResult).split('ï¼ˆ')[0]}</button>`;
            if (data.coffeeResult) html += `<button onclick="showSameTypeUsers('${getSafe(data.coffeeResult).split(' ')[0]}', 'coffee', 'â˜• ã‚³ãƒ¼ãƒ’ãƒ¼æ€§æ ¼')" class="bg-amber-50 hover:bg-amber-100 text-amber-600 border border-amber-200 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm">â˜• ${getSafe(data.coffeeResult).split(' ')[0]}å¥½ã</button>`;
            if (data.smResult) html += `<button onclick="showSameTypeUsers('${getSafe(data.smResult).split('ï¼ˆ')[0]}', 'sm', 'ğŸŒ¬ï¸ ã‚¹ãƒˆãƒ¬ã‚¹ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆ')" class="bg-pink-50 hover:bg-pink-100 text-pink-600 border border-pink-200 text-xs font-bold px-3 py-1.5 rounded-lg active:scale-95 transition shadow-sm">ğŸŒ¬ï¸ ${getSafe(data.smResult).split('ï¼ˆ')[0]}</button>`;
            if (html !== "") { container.innerHTML = html; document.getElementById('tags-hint').classList.remove('hidden'); }
        }

        // ğŸŒŸ åå‰ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ããŸã‚ã®æ©Ÿèƒ½ï¼ˆLINE IDã‚’ã‚­ãƒ¼ã«ã™ã‚‹ï¼‰
        function openProfileByLineId(lineId) {
            if (!lineId) { alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒç´ã¥ã„ã¦ã„ã¾ã›ã‚“"); return; }
            if (lineId === myUserId) { alert("ã“ã‚Œã¯ã‚ãªãŸè‡ªèº«ã§ã™ï¼"); return; }
            // allUsersDataã® doc.name ã«ã¯ Firestoreã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID (=LINE ID) ãŒå«ã¾ã‚Œã¦ã„ã‚‹
            const index = allUsersData.findIndex(doc => doc.name.includes(lineId));
            if (index !== -1) {
                closeEventDetail(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã¯ä¸€æ—¦é–‰ã˜ã‚‹
                showOtherProfile(index);
            } else {
                alert("ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã¾ã ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
            }
        }

async function openEventDetail(eventId, title) {
            document.getElementById('event-modal-title').innerText = title;
            document.getElementById('event-modal-content').innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div><p class="text-xs text-slate-400 font-bold">è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>`;
            document.getElementById('event-detail-modal').classList.remove('hidden'); document.getElementById('event-detail-modal').classList.add('flex');

            try {
                const res = await fetch(`https://asia-northeast1-shinrizemi-linebot.cloudfunctions.net/getEventDetails?eventId=${eventId}`);
                const data = await res.json();

                // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®å®‰å…¨ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°è¡¨ç¤º
                if (data.details && data.details.includes("âš ï¸")) {
                    throw new Error(data.details);
                }

                let html = `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 whitespace-pre-wrap text-xs text-slate-700 leading-relaxed font-medium">${data.details}</div>`;

                // ğŸ™‹ å‚åŠ äºˆå®šãƒªã‚¹ãƒˆï¼ˆAPIã®ä»•æ§˜ã«åˆã‚ã›ã¦ joinsLineIds ã‚’ä½¿ç”¨ï¼‰
                const joins = data.joinsLineIds || [];
                html += `<div class="mt-4"><p class="text-[10px] font-bold text-indigo-500 mb-2">ğŸ™‹ å‚åŠ äºˆå®š (${joins.length}äºº)</p>`;
                if(joins.length > 0) {
                    html += `<div class="flex flex-wrap gap-1.5">${joins.map(id => {
                        const userDoc = allUsersData.find(doc => doc.name.includes(id));
                        const name = userDoc ? (getSafe(userDoc.fields?.profile?.mapValue?.fields?.name) || "åŒ¿å") : "åŒ¿å";
                        return `<button onclick="openProfileByLineId('${id}')" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-[10px] font-bold px-2.5 py-1 rounded-md border border-indigo-200 active:scale-95 transition shadow-sm">${name}</button>`;
                    }).join('')}</div>`;
                } else { html += `<p class="text-[10px] text-slate-400">ã¾ã å‚åŠ è€…ã¯ã„ã¾ã›ã‚“</p>`; }
                html += `</div>`;

                // ğŸ¤” è¿·ã„ä¸­ãƒªã‚¹ãƒˆï¼ˆAPIã®ä»•æ§˜ã«åˆã‚ã›ã¦ maybesLineIds ã‚’ä½¿ç”¨ï¼‰
                const maybes = data.maybesLineIds || [];
                html += `<div class="mt-4"><p class="text-[10px] font-bold text-orange-500 mb-2">ğŸ¤” è¿·ã„ä¸­ (${maybes.length}äºº)</p>`;
                if(maybes.length > 0) {
                    html += `<div class="flex flex-wrap gap-1.5">${maybes.map(id => {
                        const userDoc = allUsersData.find(doc => doc.name.includes(id));
                        const name = userDoc ? (getSafe(userDoc.fields?.profile?.mapValue?.fields?.name) || "åŒ¿å") : "åŒ¿å";
                        return `<button onclick="openProfileByLineId('${id}')" class="bg-orange-50 hover:bg-orange-100 text-orange-600 text-[10px] font-bold px-2.5 py-1 rounded-md border border-orange-200 active:scale-95 transition shadow-sm">${name}</button>`;
                    }).join('')}</div>`;
                } else { html += `<p class="text-[10px] text-slate-400">è¿·ã„ä¸­ã®äººã¯ã„ã¾ã›ã‚“</p>`; }
                html += `</div>`;

                document.getElementById('event-modal-content').innerHTML = html;
            } catch(e) { 
                document.getElementById('event-modal-content').innerHTML = `<p class="text-center text-red-400 py-4 text-xs font-bold whitespace-pre-wrap">${e.message || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'}</p>`; 
            }
        }

        function closeEventDetail() { document.getElementById('event-detail-modal').classList.add('hidden'); document.getElementById('event-detail-modal').classList.remove('flex'); }

        function openPastEventsModal() {
            let html = globalPastEvents.map(ev => `
                <div onclick="closePastEventsModal(); openEventDetail('${ev.id}', '${ev.title}')" class="bg-white rounded-xl p-4 border border-slate-200 shadow-sm flex flex-col cursor-pointer hover:bg-slate-50 active:scale-95 transition">
                    <div class="text-[10px] text-emerald-600 font-bold mb-1">ğŸ“… ${ev.date}</div><h4 class="text-sm font-bold text-slate-800">${ev.title}</h4>
                </div>`).join('');
            document.getElementById('past-events-list').innerHTML = html;
            document.getElementById('past-events-modal').classList.remove('hidden'); document.getElementById('past-events-modal').classList.add('flex');
        }
        function closePastEventsModal() { document.getElementById('past-events-modal').classList.add('hidden'); document.getElementById('past-events-modal').classList.remove('flex'); }

        function showSameTypeUsers(typeValue, typeCategory, titlePrefix) {
            if (allUsersData.length === 0) { alert("ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãŠè©¦ã—ãã ã•ã„ï¼"); return; }
            document.getElementById('same-type-title').innerText = `${titlePrefix} ãŒåŒã˜ä»²é–“`;
            const matchedUsers = [];
            allUsersData.forEach((doc, index) => {
                if (doc.name.includes(myUserId)) return; 
                const f = doc.fields;
                if (!f || !f.profile || !f.profile.mapValue) return;
                let isMatch = false;
                if (typeCategory === 'chrono' && getSafe(f.chronoResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'bigFive' && getSafe(f.bigFiveResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'coffee' && getSafe(f.coffeeResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'sm' && getSafe(f.smResult).includes(typeValue)) isMatch = true;
                else if (typeCategory === 'motivation' && getSafe(f.motivationResult).includes(typeValue)) isMatch = true;
                if (isMatch) {
                    const p = f.profile.mapValue.fields;
                    let roles = []; if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) roles = p.roles.arrayValue.values.map(v => getSafe(v)); else if (p.role) roles = [getSafe(p.role)];
                    matchedUsers.push({ index: index, name: getSafe(p.name) || "åŒ¿åãƒ¡ãƒ³ãƒãƒ¼", icon: getSafe(p.iconUrl) || "https://via.placeholder.com/150", roles: roles });
                }
            });
            document.getElementById('same-type-count').innerText = `ã‚ãªãŸä»¥å¤–ã« ${matchedUsers.length} äººè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼`;
            const listContainer = document.getElementById('same-type-list');
            if (matchedUsers.length > 0) {
                let html = "";
                matchedUsers.forEach(user => {
                    // â˜…ã“ã“ã§ã‚‚å…±é€šã®ãƒãƒƒã‚¸é–¢æ•°ã‚’ä½¿ç”¨ï¼
                    const topRoleBadge = user.roles.length > 0 && user.roles[0] !== "æœªè¨­å®š" && user.roles[0] !== "ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼" ? getRoleBadgeHtml(user.roles[0]) : "";
                    html += `<div onclick="closeSameTypeModal(); showOtherProfile(${user.index})" class="flex items-center gap-4 bg-slate-50 p-3 rounded-xl border border-slate-200 cursor-pointer hover:bg-slate-100 active:scale-95 transition shadow-sm">
                        <img src="${user.icon}" class="w-12 h-12 rounded-full object-cover border border-slate-300">
                        <div><p class="text-sm font-bold text-slate-800 mb-0.5">${user.name} ã•ã‚“</p>${topRoleBadge}</div>
                        <span class="ml-auto text-indigo-300 text-xs">ğŸ‘‰</span></div>`;
                });
                listContainer.innerHTML = html;
            } else { listContainer.innerHTML = `<p class="text-sm text-slate-400 text-center py-6">ã¾ã ã“ã®ã‚¿ã‚¤ãƒ—ã®ä»²é–“ã¯ã„ã¾ã›ã‚“ã€‚<br>æ–°å…¥ç”ŸãŒå…¥ã£ã¦ãã‚‹ã®ã‚’å¾…ã¨ã†ï¼</p>`; }
            document.getElementById('same-type-modal').classList.remove('hidden'); document.getElementById('same-type-modal').classList.add('flex');
        }
        function closeSameTypeModal() { document.getElementById('same-type-modal').classList.add('hidden'); document.getElementById('same-type-modal').classList.remove('flex'); }

        function showOtherProfile(index) {
            const doc = allUsersData[index]; const f = doc.fields; const p = f.profile.mapValue.fields;
            document.getElementById('other-name').innerText = getSafe(p.name) + " ã•ã‚“";
            document.getElementById('other-icon').src = getSafe(p.iconUrl) || "https://via.placeholder.com/150";
            
            let roles = []; if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) roles = p.roles.arrayValue.values.map(v => getSafe(v)); else if (p.role) roles = [getSafe(p.role)];
            const badgesContainer = document.getElementById('other-role-badges');
            badgesContainer.innerHTML = "";
            if (roles.length > 0 && !roles.includes("ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼") && !roles.includes("æœªè¨­å®š")) {
                 roles.forEach(role => { badgesContainer.innerHTML += getRoleBadgeHtml(role); }); // â˜…å…±é€šã®ãƒãƒƒã‚¸é–¢æ•°ã‚’ä½¿ç”¨ï¼
            }
            
            const uni = getSafe(p.uni); const grade = getSafe(p.grade);
            document.getElementById('other-univ').innerText = (uni || grade) ? `${uni} ${grade}` : "";
            document.getElementById('other-intro').innerText = getSafe(p.intro) || getSafe(p.selfIntro) || "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼";
            let tagsHtml = "";
            if (p.tags && p.tags.arrayValue && p.tags.arrayValue.values) {
                p.tags.arrayValue.values.forEach(v => { tagsHtml += `<span class="bg-slate-100 text-slate-600 text-[9px] font-bold px-2 py-1 rounded border border-slate-200">ğŸ·ï¸ ${getSafe(v)}</span>`; });
            }
            if(tagsHtml === "") tagsHtml = `<span class="text-[10px] text-slate-400">ã‚¿ã‚°æœªè¨­å®š</span>`;
            document.getElementById('other-tags').innerHTML = tagsHtml;
            document.getElementById('other-profile-modal').classList.remove('hidden'); document.getElementById('other-profile-modal').classList.add('flex');
        }

        function closeOtherProfile() { document.getElementById('other-profile-modal').classList.add('hidden'); document.getElementById('other-profile-modal').classList.remove('flex'); }
        function editHitokoto() {
            const current = document.getElementById('user-intro').innerText; const text = current === "ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã²ã¨ã“ã¨ã‚’è¨­å®šï¼" ? "" : current;
            const input = prompt("ã„ã¾ã®ã²ã¨ã“ã¨ï¼ˆãƒã‚¤ãƒšãƒ¼ã‚¸ç”¨ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„âœ¨\nâ€»æœ€å¤§40æ–‡å­—ç¨‹åº¦", text);
            if (input !== null && input.trim() !== "") {
                document.getElementById('user-intro').innerText = "æ›´æ–°ä¸­... ğŸš€";
                liff.sendMessages([{ type: "text", text: "ã²ã¨ã“ã¨ " + input }]).then(() => { setTimeout(() => { window.location.reload(); }, 1500); }).catch(err => alert("ã‚¨ãƒ©ãƒ¼: " + err));
            }
        }
        function openEditModal() { document.getElementById('edit-modal').classList.remove('hidden'); document.getElementById('edit-modal').classList.add('flex'); }
        function closeEditModal() { document.getElementById('edit-modal').classList.add('hidden'); document.getElementById('edit-modal').classList.remove('flex'); }

        function saveProfile() {
            const name = document.getElementById('edit-name').value; const uni = document.getElementById('edit-uni').value; const faculty = document.getElementById('edit-faculty').value; const grade = document.getElementById('edit-grade').value; const selfintro = document.getElementById('edit-selfintro').value;
            const checkedBoxes = document.querySelectorAll('.tag-checkbox:checked'); let selectedTags = []; checkedBoxes.forEach(box => selectedTags.push(box.value)); const tagsString = selectedTags.join(",");
            if(!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼"); return; }
            const text = `ã€ãƒ—ãƒ­ãƒ•æ›´æ–°ã€‘\nåå‰:${name}\nå¤§å­¦:${uni}\nå­¦éƒ¨:${faculty}\nå­¦å¹´:${grade}\nèˆˆå‘³ã‚¿ã‚°:${tagsString}\nè‡ªå·±ç´¹ä»‹:${selfintro}`;
            liff.sendMessages([{ type: "text", text: text }]).then(() => {
                alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã€Notionã¨åŒæœŸã—ã¾ã—ãŸï¼ğŸš€\n(åæ˜ ã«ã¯æ•°ç§’ã‹ã‹ã‚Šã¾ã™)"); window.location.reload(); 
            }).catch((err) => { alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + err); });
        }

        async function fetchConnections() {
            if (!myData) return;
            try {
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`);
                const json = await res.json();
                if (!json.documents) return;
                allUsersData = json.documents;
                const myChrono = getSafe(myData.chronoResult).split('ï¼ˆ')[0]; const myBigFiveMatch = getSafe(myData.bigFiveResult).match(/Big Fiveï¼š(.+?)ãŒç‰¹å¾´çš„/); const myBigFive = myBigFiveMatch ? myBigFiveMatch[1] : ""; const myCoffee = getSafe(myData.coffeeResult).split(' ')[0];
                let chronoSameCount = 0; let syncRanking = [];
                json.documents.forEach((doc, index) => {
                    if (doc.name.includes(myUserId)) return;
                    const f = doc.fields; if (!f || !f.profile || !f.profile.mapValue) return; 
                    const p = f.profile.mapValue.fields; const otherName = getSafe(p.name); const otherIcon = getSafe(p.iconUrl) || "https://via.placeholder.com/150"; if (!otherName) return;
                    let roles = []; if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) roles = p.roles.arrayValue.values.map(v => getSafe(v));
                    let otherChrono = getSafe(f.chronoResult).split('ï¼ˆ')[0]; if (myChrono && otherChrono === myChrono) chronoSameCount++;
                    let score = 0;
                    if (myChrono && otherChrono === myChrono) score += 25; if (myBigFive && getSafe(f.bigFiveResult).includes(myBigFive)) score += 35; if (myCoffee && getSafe(f.coffeeResult).includes(myCoffee)) score += 20; if (getSafe(myData.smResult) && getSafe(f.smResult) && getSafe(myData.smResult).split('ï¼ˆ')[0] === getSafe(f.smResult).split('ï¼ˆ')[0]) score += 20;
                    if (score >= 15) syncRanking.push({ index: index, name: otherName, icon: otherIcon, score: score, topRole: roles.length > 0 ? roles[0] : "ãƒ¡ãƒ³ãƒãƒ¼" });
                });
                if (myChrono) document.getElementById('rare-text').innerHTML = `ã‚ãªãŸã¨åŒã˜ã€Œ${myChrono}ã€ã®ã‚¼ãƒŸç”Ÿã¯ã€<br>å…¨ä½“ã§ <strong class="text-pink-500 text-sm drop-shadow-sm">${chronoSameCount + 1}äºº</strong> ã„ã¾ã™ï¼`;
                syncRanking.sort((a,b) => b.score - a.score); const container = document.getElementById('sync-users-container');
                if (syncRanking.length > 0) {
                    let html = "";
                    syncRanking.slice(0, 5).forEach((user, i) => {
                        const crown = i === 0 ? "ğŸ‘‘" : "ğŸ¤"; const color = i === 0 ? "border-emerald-400 bg-emerald-50" : "border-slate-200 bg-white";
                        html += `<div onclick="showOtherProfile(${user.index})" class="flex-shrink-0 rounded-2xl p-3 border ${color} w-32 flex flex-col items-center cursor-pointer hover:bg-slate-50 active:scale-95 transition shadow-sm relative">
                            <span class="absolute -top-2 -right-2 bg-gradient-to-r from-emerald-400 to-teal-500 text-white text-[9px] font-black px-1.5 py-0.5 rounded-full shadow-md">${user.score}%</span>
                            <img src="${user.icon}" class="w-12 h-12 rounded-full mb-2 object-cover border border-slate-200">
                            <p class="text-[10px] text-slate-800 font-bold text-center w-full truncate">${crown} ${user.name}</p>
                            <p class="text-[8px] text-slate-500 mt-1 w-full text-center truncate">${user.topRole === "ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼" ? "ãƒ¡ãƒ³ãƒãƒ¼" : user.topRole}</p></div>`;
                    });
                    container.innerHTML = html;
                } else { container.innerHTML = `<p class="text-xs text-slate-400 font-bold w-full text-center py-4">ã¾ã ä¼¼ã¦ã„ã‚‹äººãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»²é–“ãŒå¢—ãˆã‚‹ã®ã‚’å¾…ã¨ã†ï¼</p>`; }
            } catch (e) { console.error(e); }
        }

        initMyPage();
    </script>
</body>
</html>