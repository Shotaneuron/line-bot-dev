<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å…¨ä½“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ | åŒ—å¤§å¿ƒç†ã‚¼ãƒŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@700;900&family=Zen+Kaku+Gothic+New:wght@700;900&family=Zen+Maru+Gothic:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: 'Zen Maru Gothic', sans-serif; background: linear-gradient(-45deg, #ffffff, #f8fafc, #eff6ff, #fdf4ff, #fffbeb); background-size: 300% 300%; animation: auroraBG 15s ease infinite; color: #1e293b; min-height: 100vh; padding-bottom: 5rem; overflow-x: hidden; }
        @keyframes auroraBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.9); box-shadow: 0 10px 30px -10px rgba(71, 85, 105, 0.15); }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 3px; }
        .calendar-cell { min-height: 90px; background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(226, 232, 240, 0.6); border-radius: 8px; padding: 3px; display: flex; flex-direction: column; gap: 2px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); overflow: hidden; }
        .calendar-cell.today { background: linear-gradient(135deg, rgba(238, 242, 255, 0.95) 0%, rgba(224, 231, 255, 0.95) 100%); border: 1px solid #818cf8; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.15), inset 0 0 0 1px #e0e7ff; }
        .calendar-cell.empty { background: transparent; border: none; box-shadow: none; }
        
        .event-badge { display: flex; flex-direction: column; padding: 3px; border-radius: 6px; cursor: pointer; transition: transform 0.1s; }
        .event-badge:active { transform: scale(0.95); }
        .event-cat { font-size: 7px; font-weight: 900; line-height: 1; margin-bottom: 2px; opacity: 0.8; }
        .event-title { font-size: 9px; font-weight: 700; line-height: 1.2; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="safe-area-inset-top p-3 sm:p-5">

    <div class="text-center mb-5 fade-in pt-2">
        <div class="relative p-[2px] rounded-3xl bg-gradient-to-r from-cyan-300 via-indigo-300 to-pink-300 shadow-sm mx-1">
            <div class="bg-white/95 backdrop-blur-xl rounded-[1.7rem] py-4 px-4 relative overflow-hidden flex items-center justify-center gap-3">
                <span class="text-2xl drop-shadow-sm">ğŸ“…</span>
                <div>
                    <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-700 to-pink-600 tracking-widest" style="font-family: 'Zen Kaku Gothic New', sans-serif;">ã‚¼ãƒŸ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h1>
                    <p class="text-[9px] font-bold text-slate-400 tracking-[0.1em] mt-0.5">Hokkaido Univ. Psychology Seminar</p>
                </div>
            </div>
        </div>
    </div>

    <section class="glass-card rounded-[2rem] p-3 sm:p-5 fade-in relative overflow-hidden">
        <div class="flex justify-between items-center mb-4 px-2">
            <button onclick="changeMonth(-1)" class="w-9 h-9 flex items-center justify-center bg-white border border-slate-200 rounded-full text-indigo-500 active:scale-95 shadow-sm transition">â—€</button>
            <h2 id="calendar-month-title" class="text-xl font-black text-slate-800 tracking-widest" style="font-family: 'Zen Kaku Gothic New', sans-serif;"></h2>
            <button onclick="changeMonth(1)" class="w-9 h-9 flex items-center justify-center bg-white border border-slate-200 rounded-full text-indigo-500 active:scale-95 shadow-sm transition">â–¶</button>
        </div>
        <div class="calendar-grid mb-2 text-center text-[10px] font-black text-slate-400"><div class="text-pink-500">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div class="text-blue-500">åœŸ</div></div>
        <div id="calendar-body" class="calendar-grid relative">
            <div id="calendar-loading" class="absolute inset-0 bg-white/60 backdrop-blur-md z-10 flex flex-col items-center justify-center rounded-xl">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-2"></div>
                <p class="text-[10px] font-bold text-indigo-600">ã‚¤ãƒ™ãƒ³ãƒˆã‚’åŒæœŸä¸­...</p>
            </div>
        </div>
    </section>

    <section class="glass-card rounded-[2rem] p-4 sm:p-5 mt-4 fade-in mb-8" style="animation-delay: 0.2s;">
        <h2 class="text-sm font-black text-slate-800 tracking-widest flex items-center gap-2 mb-3"><span>âœ¨</span> ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ</h2>
        <div id="pickup-events" class="flex gap-3 overflow-x-auto no-scrollbar pb-2"><p class="text-xs text-slate-400 font-bold px-2">èª­ã¿è¾¼ã¿ä¸­...</p></div>
    </section>

    <div id="event-detail-modal" class="fixed inset-0 z-[70] hidden flex-col justify-end bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2rem] p-6 shadow-2xl border-t border-slate-200 max-h-[90vh] flex flex-col w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeEventDetail()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center z-10">&times;</button>
            
            <div class="flex justify-between items-center mb-3 pr-10">
                <button id="btn-prev-event" onclick="navigateEvent(-1)" class="w-8 h-8 flex items-center justify-center bg-slate-50 border border-slate-200 rounded-full text-indigo-500 active:scale-95 transition disabled:opacity-30 disabled:active:scale-100">â—€</button>
                <div id="event-modal-category" class="flex-1 text-center"></div>
                <button id="btn-next-event" onclick="navigateEvent(1)" class="w-8 h-8 flex items-center justify-center bg-slate-50 border border-slate-200 rounded-full text-indigo-500 active:scale-95 transition disabled:opacity-30 disabled:active:scale-100">â–¶</button>
            </div>
            
            <h3 id="event-modal-title" class="text-xl font-black text-slate-800 mb-4 text-center leading-tight"></h3>
            
            <div id="event-modal-content" class="overflow-y-auto no-scrollbar pb-6 flex-1">
                </div>
        </div>
    </div>

    <div id="other-profile-modal" class="fixed inset-0 z-[80] hidden flex-col justify-end bg-slate-900/50 backdrop-blur-sm">
        <div class="bg-white rounded-t-[2.5rem] p-6 shadow-2xl border-t border-slate-200 max-h-[85vh] w-full max-w-md mx-auto relative animate-[translateY_0.2s_ease-out]">
            <button onclick="closeOtherProfile()" class="absolute top-5 right-5 w-8 h-8 bg-slate-100 rounded-full text-slate-500 text-lg font-bold flex items-center justify-center">&times;</button>
            
            <div class="flex flex-col items-center mt-2 mb-6">
                <img id="other-icon" src="" class="w-24 h-24 rounded-full border-4 border-slate-100 mb-3 object-cover shadow-sm">
                <div id="other-role-badges" class="flex flex-wrap justify-center gap-1 mb-2"></div>
                <h3 id="other-name" class="text-xl font-black text-slate-800 mb-1"></h3>
                <p id="other-univ" class="text-[10px] text-slate-500 font-bold"></p>
            </div>
            
            <div class="bg-slate-50 rounded-xl p-4 mb-4 border border-slate-200">
                <p class="text-[10px] text-slate-500 font-bold mb-1">ğŸ’¬ ä»Šã®ã²ã¨ã“ã¨</p>
                <p id="other-intro" class="text-sm text-slate-700 font-bold"></p>
            </div>
        </div>
    </div>

    <script>
        let currentDate = new Date();
        let allEvents = []; 
        let allUsersData = []; 
        let usersDict = {}; // â˜… çˆ†é€Ÿã§ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ¢ã™ãŸã‚ã®è¾æ›¸
        let myUserId = "";
        let currentEventIndex = -1;

        async function initCalendar() {
            try {
                await liff.init({ liffId: "2009176797-qGY6VB64" }); 
                if (liff.isLoggedIn()) { myUserId = liff.getDecodedIDToken()?.sub; }
                await fetchUsersData(); // å…ˆã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–ã£ã¦ãŠã
                await fetchCalendarEvents();
                renderCalendar();
            } catch(e) { console.error(e); }
        }

        async function fetchUsersData() {
            try {
                const res = await fetch(`https://firestore.googleapis.com/v1/projects/shinrizemi-linebot/databases/default/documents/users?pageSize=1000`);
                const json = await res.json();
                if(json.documents) {
                    allUsersData = json.documents;
                    // â˜… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDï¼ˆï¼LINE IDï¼‰ã‚’ã‚­ãƒ¼ã«ã—ãŸè¾æ›¸ã‚’ä½œã‚‹
                    allUsersData.forEach(doc => {
                        const lineId = doc.name.split('/').pop();
                        usersDict[lineId] = doc;
                    });
                }
            } catch(e){}
        }

        async function fetchCalendarEvents() {
            document.getElementById('calendar-loading').style.display = 'flex';
            try {
                const res = await fetch(`https://asia-northeast1-shinrizemi-linebot.cloudfunctions.net/getCalendarEvents`);
                const data = await res.json();
                allEvents = data.events || [];
            } catch(e) { alert("ã‚¤ãƒ™ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
            document.getElementById('calendar-loading').style.display = 'none';
        }

        function changeMonth(diff) { currentDate.setMonth(currentDate.getMonth() + diff); renderCalendar(); }

        function getCategoryStyle(cat) {
            if (cat.includes("ã™ã“ã‚„ã‹") || cat.includes("é‹å‹•") || cat.includes("å¿«çœ ") || cat.includes("ç‘æƒ³")) return "bg-emerald-50 text-emerald-700 border border-emerald-200/50";
            if (cat.includes("èª­æ›¸") || cat.includes("ãƒ©ã‚¸ã‚ª") || cat.includes("ã‚·ã‚§ã‚¢")) return "bg-orange-50 text-orange-700 border border-orange-200/50";
            if (cat.includes("ã‚¼ãƒŸ") || cat.includes("è¬›ç¾©")) return "bg-blue-50 text-blue-700 border border-blue-200/50";
            if (cat.includes("ã‚«ã‚¯ãƒ†ãƒ«") || cat.includes("ãµã‚‰ã£ã¨")) return "bg-pink-50 text-pink-700 border border-pink-200/50";
            return "bg-indigo-50 text-indigo-700 border border-indigo-200/50"; 
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('calendar-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;

            let html = "";
            for (let i = 0; i < firstDay; i++) { html += `<div class="calendar-cell empty"></div>`; }

            for (let i = 1; i <= lastDate; i++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isToday = isCurrentMonth && i === today.getDate() ? "today" : "";
                
                let eventsHtml = "";
                allEvents.forEach((ev, index) => {
                    if (ev.date === dateStr) {
                        const style = getCategoryStyle(ev.category);
                        const organizerIcon = ev.organizerIds && ev.organizerIds.length > 0 ? `<span class="mr-0.5 opacity-70">ğŸ‘¤</span>` : "";
                        eventsHtml += `
                            <div onclick="openEventDetailByIndex(${index})" class="event-badge ${style}">
                                <span class="event-cat">${ev.category}</span>
                                <span class="event-title">${organizerIcon}${ev.title}</span>
                            </div>`;
                    }
                });

                html += `<div class="calendar-cell ${isToday}"><div class="text-[10px] font-black text-slate-500 pl-1 ${isToday ? 'text-indigo-600' : ''}">${i}</div><div class="flex flex-col gap-1 overflow-y-auto no-scrollbar max-h-16 pb-1">${eventsHtml}</div></div>`;
            }
            document.getElementById('calendar-body').innerHTML = html;
            renderPickupEvents();
        }

        function renderPickupEvents() {
            const today = new Date().toISOString().split('T')[0];
            let html = "";
            let count = 0;
            for (let i = 0; i < allEvents.length; i++) {
                const ev = allEvents[i];
                if (ev.date >= today) {
                    const style = getCategoryStyle(ev.category);
                    html += `
                    <div onclick="openEventDetailByIndex(${i})" class="flex-shrink-0 w-48 bg-white rounded-xl p-3 border border-slate-200 shadow-sm cursor-pointer hover:bg-slate-50 active:scale-95 transition flex flex-col justify-between">
                        <div>
                            <div class="flex justify-between items-start mb-2"><span class="text-[10px] font-bold text-slate-500">ğŸ“… ${ev.date}</span><span class="${style} text-[8px] px-2 py-0.5 rounded font-black">${ev.category}</span></div>
                            <h4 class="text-sm font-black text-slate-800 leading-tight line-clamp-2">${ev.title}</h4>
                        </div>
                    </div>`;
                    count++;
                    if (count >= 5) break;
                }
            }
            if (count === 0) { document.getElementById('pickup-events').innerHTML = '<p class="text-xs text-slate-400 font-bold px-2">ç›´è¿‘ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>'; return; }
            document.getElementById('pickup-events').innerHTML = html;
        }

        // =====================================
        // ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´° ï¼† ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¡¨ç¤º
        // =====================================
        
        function getSafe(f) { if (!f) return ""; if (f.stringValue !== undefined) return f.stringValue; return ""; }
        function getRoleBadgeHtml(role) {
            let badgeClass = "", badgeIcon = "";
            if (role === "ä»£è¡¨") { badgeIcon = "ğŸ‘‘"; badgeClass = "bg-yellow-500/20 text-yellow-800 border border-yellow-400"; } 
            else if (["ç§˜æ›¸", "çµ±æ‹¬", "åºƒå ±", "è£œä½"].some(r => role.includes(r))) { badgeIcon = "ğŸ›¡ï¸"; badgeClass = "bg-slate-200/50 text-slate-700 border border-slate-400"; } 
            else if (role.includes("éƒ¨") || role.includes("PJ") || ["ã‚¼ãƒŸ", "è¬›ç¾©"].some(r => role.includes(r))) { badgeIcon = "âœ¨"; badgeClass = "bg-indigo-500/10 text-indigo-700 border border-indigo-300"; } 
            else { badgeIcon = "ğŸ”–"; badgeClass = "bg-slate-100 text-slate-600 border border-slate-200"; }
            return `<span class="inline-block ${badgeClass} text-[10px] font-black tracking-widest px-2 py-0.5 rounded shadow-sm">${badgeIcon} ${role}</span>`;
        }

        // ğŸŒŸ å¼·åŒ–ç‰ˆï¼šLINE IDã‹ã‚‰100%ç¢ºå®Ÿã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’é–‹ã
        function openProfileByLineId(lineId) {
            if (!lineId) return;
            if (lineId === myUserId) { alert("ã“ã‚Œã¯ã‚ãªãŸè‡ªèº«ã§ã™ï¼ãƒã‚¤ãƒšãƒ¼ã‚¸ã‹ã‚‰ç¢ºèªã—ã¦ãã ã•ã„ã€‚"); return; }
            
            const doc = usersDict[lineId]; // è¾æ›¸ã‹ã‚‰ä¸€ç¬ã§æ¤œç´¢
            if (doc) {
                closeEventDetail();
                const p = doc.fields.profile.mapValue.fields;
                document.getElementById('other-name').innerText = getSafe(p.name) + " ã•ã‚“";
                document.getElementById('other-icon').src = getSafe(p.iconUrl) || "https://via.placeholder.com/150";
                
                let roles = []; if (p.roles && p.roles.arrayValue && p.roles.arrayValue.values) roles = p.roles.arrayValue.values.map(v => getSafe(v)); else if (p.role) roles = [getSafe(p.role)];
                const badgesContainer = document.getElementById('other-role-badges'); badgesContainer.innerHTML = "";
                if (roles.length > 0 && !roles.includes("ä¸€èˆ¬ãƒ¡ãƒ³ãƒãƒ¼") && !roles.includes("æœªè¨­å®š")) {
                     roles.forEach(role => { badgesContainer.innerHTML += getRoleBadgeHtml(role); });
                }
                const uni = getSafe(p.uni); const grade = getSafe(p.grade);
                document.getElementById('other-univ').innerText = (uni || grade) ? `${uni} ${grade}` : "";
                document.getElementById('other-intro').innerText = getSafe(p.intro) || getSafe(p.selfIntro) || "ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼";
                
                document.getElementById('other-profile-modal').classList.remove('hidden'); document.getElementById('other-profile-modal').classList.add('flex');
            } else { alert("ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã¾ã ãƒã‚¤ãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã›ã‚“ã€‚"); }
        }
        function closeOtherProfile() { document.getElementById('other-profile-modal').classList.add('hidden'); document.getElementById('other-profile-modal').classList.remove('flex'); }

        function openEventDetailByIndex(index) {
            currentEventIndex = index;
            const ev = allEvents[index];

            document.getElementById('btn-prev-event').disabled = currentEventIndex <= 0;
            document.getElementById('btn-next-event').disabled = currentEventIndex >= allEvents.length - 1;

            document.getElementById('event-modal-title').innerText = ev.title;
            document.getElementById('event-modal-category').innerHTML = `<span class="${getCategoryStyle(ev.category)} px-3 py-1 rounded-full font-black text-[10px] shadow-sm">${ev.category}</span>`;
            document.getElementById('event-modal-content').innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div><p class="text-xs text-slate-400 font-bold">è©³ç´°ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>`;
            
            document.getElementById('event-detail-modal').classList.remove('hidden'); 
            document.getElementById('event-detail-modal').classList.add('flex');

            fetchEventDetailsData(ev.id);
        }

        function navigateEvent(direction) {
            const newIndex = currentEventIndex + direction;
            if (newIndex >= 0 && newIndex < allEvents.length) { openEventDetailByIndex(newIndex); }
        }

        // â˜…ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒƒãƒ—ã‚’è¾æ›¸ã‹ã‚‰ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆçˆ†é€Ÿï¼ï¼‰
        function createUserChip(lineId, colorClass, borderClass, textClass) {
            const doc = usersDict[lineId];
            if (!doc) return `<span class="text-[9px] text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded-full">åŒ¿å</span>`;
            const p = doc.fields?.profile?.mapValue?.fields;
            const name = getSafe(p.name) || "åŒ¿å";
            const icon = getSafe(p.iconUrl) || "https://via.placeholder.com/150";
            return `
                <div onclick="openProfileByLineId('${lineId}')" class="flex items-center gap-1.5 ${colorClass} px-2 py-1 rounded-full border ${borderClass} cursor-pointer active:scale-95 shadow-sm transition">
                    <img src="${icon}" class="w-5 h-5 rounded-full object-cover">
                    <span class="text-[10px] font-bold ${textClass}">${name}</span>
                </div>`;
        }

        async function fetchEventDetailsData(eventId) {
            try {
                const res = await fetch(`https://asia-northeast1-shinrizemi-linebot.cloudfunctions.net/getEventDetails?eventId=${eventId}`);
                const data = await res.json();

                const isJoin = data.joinsLineIds && data.joinsLineIds.includes(myUserId);
                const isMaybe = data.maybesLineIds && data.maybesLineIds.includes(myUserId);
                const isDecline = data.declinesLineIds && data.declinesLineIds.includes(myUserId);

                let html = `<div class="bg-slate-50 p-4 rounded-xl border border-slate-200 whitespace-pre-wrap text-xs text-slate-700 leading-relaxed font-medium mb-4">${data.details}</div>`;

                html += `<div><p class="text-[10px] font-bold text-indigo-500 mb-2">ğŸ™‹ å‚åŠ äºˆå®š (${data.joinsLineIds ? data.joinsLineIds.length : 0}äºº)</p>`;
                if(data.joinsLineIds && data.joinsLineIds.length > 0) html += `<div class="flex flex-wrap gap-1.5">${data.joinsLineIds.map(id => createUserChip(id, "bg-white", "border-indigo-200", "text-indigo-700")).join('')}</div>`; 
                else html += `<p class="text-[10px] text-slate-400">ã¾ã å‚åŠ è€…ã¯ã„ã¾ã›ã‚“</p>`; 
                html += `</div>`;

                html += `<div class="mt-4"><p class="text-[10px] font-bold text-orange-500 mb-2">ğŸ¤” è¿·ã„ä¸­ (${data.maybesLineIds ? data.maybesLineIds.length : 0}äºº)</p>`;
                if(data.maybesLineIds && data.maybesLineIds.length > 0) html += `<div class="flex flex-wrap gap-1.5">${data.maybesLineIds.map(id => createUserChip(id, "bg-white", "border-orange-200", "text-orange-700")).join('')}</div>`; 
                else html += `<p class="text-[10px] text-slate-400">è¿·ã„ä¸­ã®äººã¯ã„ã¾ã›ã‚“</p>`; 
                html += `</div>`;

                html += `
                    <div class="flex gap-2 mt-6 pt-4 border-t border-slate-100">
                        <button onclick="submitEventStatus('${eventId}', 'join')" class="flex-1 font-bold py-3 rounded-xl text-xs transition border shadow-sm ${isJoin ? 'bg-indigo-500 text-white border-indigo-600' : 'bg-white text-slate-500 border-slate-200'}">ğŸ™‹ å‚åŠ </button>
                        <button onclick="submitEventStatus('${eventId}', 'maybe')" class="flex-1 font-bold py-3 rounded-xl text-xs transition border shadow-sm ${isMaybe ? 'bg-orange-500 text-white border-orange-600' : 'bg-white text-slate-500 border-slate-200'}">ğŸ¤” è¿·ã„ä¸­</button>
                        <button onclick="submitEventStatus('${eventId}', 'decline')" class="flex-1 font-bold py-3 rounded-xl text-xs transition border shadow-sm ${isDecline ? 'bg-slate-500 text-white border-slate-600' : 'bg-white text-slate-500 border-slate-200'}">ğŸ™… ä¸å‚åŠ </button>
                    </div>
                `;
                document.getElementById('event-modal-content').innerHTML = html;
            } catch(e) { document.getElementById('event-modal-content').innerHTML = '<p class="text-center text-red-400 py-4 text-xs font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>'; }
        }

        function closeEventDetail() { document.getElementById('event-detail-modal').classList.add('hidden'); document.getElementById('event-detail-modal').classList.remove('flex'); }

        async function submitEventStatus(eventId, status) {
            if (!myUserId) { alert("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“"); return; }
            document.getElementById('event-modal-content').innerHTML = `
                <div class="flex flex-col items-center justify-center py-10">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-3"></div><p class="text-xs text-slate-400 font-bold">ç™»éŒ²ä¸­...</p>
                </div>`;
            try {
                const res = await fetch(`https://asia-northeast1-shinrizemi-linebot.cloudfunctions.net/updateEventStatus`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: myUserId, eventId: eventId, status: status })
                });
                if (!res.ok) throw new Error("ç™»éŒ²ã‚¨ãƒ©ãƒ¼");
                fetchEventDetailsData(eventId); 
            } catch(e) { alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ"); closeEventDetail(); }
        }

        initCalendar();
    </script>
</body>
</html>